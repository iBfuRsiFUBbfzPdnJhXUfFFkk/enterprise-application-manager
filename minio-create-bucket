#!/bin/bash

# Create MinIO bucket for Enterprise Application Manager
# This script creates the bucket and configures it for private access

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Load environment variables
if [ -f "${SCRIPT_DIR}/.env" ]; then
    export $(grep -v '^#' "${SCRIPT_DIR}/.env" | xargs)
fi

# Default values
BUCKET_NAME="${MINIO_BUCKET_NAME:-enterprise-app-media}"
MINIO_CONTAINER="${MINIO_CONTAINER_NAME:-enterprise-app-minio}"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${GREEN}================================${NC}"
echo -e "${GREEN}  MinIO Bucket Creator${NC}"
echo -e "${GREEN}================================${NC}"
echo ""

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo -e "${RED}✗ Error: Docker is not running${NC}"
    echo "Please start Docker Desktop and try again."
    exit 1
fi

# Check if MinIO container exists
if ! docker ps -a --format '{{.Names}}' | grep -q "^${MINIO_CONTAINER}$"; then
    echo -e "${RED}✗ Error: MinIO container '${MINIO_CONTAINER}' not found${NC}"
    echo "Please run 'docker-compose up -d' first to start the MinIO container."
    exit 1
fi

# Check if MinIO container is running
if ! docker ps --format '{{.Names}}' | grep -q "^${MINIO_CONTAINER}$"; then
    echo -e "${YELLOW}⚠ Warning: MinIO container is not running${NC}"
    echo "Starting MinIO container..."
    docker start "${MINIO_CONTAINER}"
    echo "Waiting for MinIO to be ready..."
    sleep 5
fi

echo "Creating bucket: ${BUCKET_NAME}"
echo ""

# Create bucket using docker exec
docker exec "${MINIO_CONTAINER}" sh -c "
    # Install mc (MinIO client) if not present
    if ! command -v mc > /dev/null 2>&1; then
        echo 'Installing MinIO client (mc)...'
        wget -q https://dl.min.io/client/mc/release/linux-amd64/mc -O /usr/local/bin/mc
        chmod +x /usr/local/bin/mc
    fi

    # Configure mc alias
    mc alias set local http://localhost:9000 \${MINIO_ROOT_USER} \${MINIO_ROOT_PASSWORD} > /dev/null 2>&1

    # Check if bucket exists
    if mc ls local/${BUCKET_NAME} > /dev/null 2>&1; then
        echo '✓ Bucket ${BUCKET_NAME} already exists'
    else
        echo 'Creating bucket ${BUCKET_NAME}...'
        mc mb local/${BUCKET_NAME}
        echo '✓ Bucket ${BUCKET_NAME} created successfully'
    fi

    # Set bucket to private (no anonymous access)
    echo 'Setting bucket policy to private...'
    mc anonymous set none local/${BUCKET_NAME}
    echo '✓ Bucket policy set to private'

    # Show bucket info
    echo ''
    echo 'Bucket information:'
    mc ls local/
"

echo ""
echo -e "${GREEN}✓ MinIO bucket setup complete!${NC}"
echo ""
echo "Bucket: ${BUCKET_NAME}"
echo "Access: Private (authenticated users only)"
echo ""
echo "MinIO Console: http://localhost:9001"
echo "Username: \${MINIO_ROOT_USER}"
echo "Password: \${MINIO_ROOT_PASSWORD}"
echo ""
echo "To view credentials, check your .env file:"
echo "  grep MINIO_ROOT .env"
