{% extends 'base.html' %}
{% block content %}
    <div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Sign in to your account
                </h2>
            </div>
            <form class="mt-8 space-y-6" method="POST" id="loginForm">
                {% csrf_token %}
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="{{ form.username.id_for_label }}" class="sr-only">Username</label>
                        {{ form.username }}
                        {% if form.username.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.username.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="{{ form.password.id_for_label }}" class="sr-only">Password</label>
                        {{ form.password }}
                        {% if form.password.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.password.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>

                {% if form.non_field_errors %}
                    <div class="rounded-md bg-red-50 p-4">
                        <div class="text-sm text-red-700">
                            {{ form.non_field_errors.0 }}
                        </div>
                    </div>
                {% endif %}

                {% if feature_remember_me %}
                    <div class="flex items-center">
                        <input
                            id="remember_me"
                            name="remember_me"
                            type="checkbox"
                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                        >
                        <label for="remember_me" class="ml-2 block text-sm text-gray-900">
                            Remember me
                        </label>
                    </div>
                {% endif %}

                <div>
                    <button
                        type="submit"
                        class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                    >
                        Sign in
                    </button>
                </div>
            </form>
        </div>
    </div>

    <style>
        /* Style the username and password inputs */
        #{{ form.username.id_for_label }} {
            appearance: none;
            border-radius: 0.375rem 0.375rem 0 0;
            position: relative;
            display: block;
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            color: #111827;
            font-size: 0.875rem;
            line-height: 1.25rem;
        }

        #{{ form.username.id_for_label }}::placeholder {
            color: #9ca3af;
        }

        #{{ form.username.id_for_label }}:focus {
            outline: none;
            z-index: 10;
            border-color: #3b82f6;
            ring: 2px;
            ring-color: #3b82f6;
        }

        #{{ form.password.id_for_label }} {
            appearance: none;
            border-radius: 0 0 0.375rem 0.375rem;
            position: relative;
            display: block;
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            color: #111827;
            font-size: 0.875rem;
            line-height: 1.25rem;
        }

        #{{ form.password.id_for_label }}::placeholder {
            color: #9ca3af;
        }

        #{{ form.password.id_for_label }}:focus {
            outline: none;
            z-index: 10;
            border-color: #3b82f6;
            ring: 2px;
            ring-color: #3b82f6;
        }
    </style>

    {% if feature_remember_me %}
    <script>
        (function() {
            'use strict';

            const STORAGE_KEYS = {
                username: 'eam_saved_username',
                password: 'eam_saved_password',
                rememberMe: 'eam_remember_me'
            };

            const usernameField = document.getElementById('{{ form.username.id_for_label }}');
            const passwordField = document.getElementById('{{ form.password.id_for_label }}');
            const rememberMeCheckbox = document.getElementById('remember_me');
            const loginForm = document.getElementById('loginForm');

            // Simple base64 encode/decode for basic obfuscation
            function encode(str) {
                return btoa(unescape(encodeURIComponent(str)));
            }

            function decode(str) {
                try {
                    return decodeURIComponent(escape(atob(str)));
                } catch (e) {
                    return '';
                }
            }

            // Load saved credentials on page load
            function loadSavedCredentials() {
                const savedUsername = localStorage.getItem(STORAGE_KEYS.username);
                const savedPassword = localStorage.getItem(STORAGE_KEYS.password);
                const rememberMeState = localStorage.getItem(STORAGE_KEYS.rememberMe);

                if (rememberMeState === 'true') {
                    rememberMeCheckbox.checked = true;

                    if (savedUsername) {
                        usernameField.value = decode(savedUsername);
                    }

                    if (savedPassword) {
                        passwordField.value = decode(savedPassword);
                    }
                }
            }

            // Save or clear credentials on form submit
            function handleFormSubmit(e) {
                if (rememberMeCheckbox.checked) {
                    // Save credentials to localStorage
                    localStorage.setItem(STORAGE_KEYS.username, encode(usernameField.value));
                    localStorage.setItem(STORAGE_KEYS.password, encode(passwordField.value));
                    localStorage.setItem(STORAGE_KEYS.rememberMe, 'true');
                } else {
                    // Clear saved credentials
                    localStorage.removeItem(STORAGE_KEYS.username);
                    localStorage.removeItem(STORAGE_KEYS.password);
                    localStorage.removeItem(STORAGE_KEYS.rememberMe);
                }
            }

            // Initialize on page load
            loadSavedCredentials();

            // Attach form submit handler
            loginForm.addEventListener('submit', handleFormSubmit);
        })();
    </script>
    {% endif %}
{% endblock %}