{% extends 'authenticated/base_authenticated.html' %}

{% block title %}Vulnerability #{{ vulnerability.id }} - GitLab Vulnerability{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
            <h1 class="text-3xl font-bold text-gray-900">Vulnerability #{{ vulnerability.id }}</h1>
            <div class="flex space-x-2">
                <a href="{% url 'gitlab_sync_vulnerabilities' %}" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                    Back to Vulnerabilities
                </a>
                <a href="{% url 'gitlab_sync_dashboard' %}" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                    Dashboard
                </a>
            </div>
        </div>
        {% if vulnerability.project %}
        <p class="text-sm text-gray-600">
            <a href="{% url 'gitlab_sync_project_detail' vulnerability.project.id %}" class="text-blue-600 hover:text-blue-800">
                {{ vulnerability.project.path_with_namespace }}
            </a>
        </p>
        {% endif %}
    </div>

    <!-- Vulnerability Title & Status -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex items-start justify-between">
            <h2 class="text-xl font-semibold text-gray-900">{{ vulnerability.title }}</h2>
            <div class="flex gap-2">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                    {% if vulnerability.severity == 'critical' %}bg-red-100 text-red-800
                    {% elif vulnerability.severity == 'high' %}bg-orange-100 text-orange-800
                    {% elif vulnerability.severity == 'medium' %}bg-yellow-100 text-yellow-800
                    {% elif vulnerability.severity == 'low' %}bg-green-100 text-green-800
                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                    {{ vulnerability.severity|upper|default:"UNKNOWN" }}
                </span>
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                    {% if vulnerability.state == 'detected' %}bg-red-100 text-red-800
                    {% elif vulnerability.state == 'resolved' %}bg-green-100 text-green-800
                    {% elif vulnerability.state == 'dismissed' %}bg-gray-100 text-gray-800
                    {% else %}bg-blue-100 text-blue-800{% endif %}">
                    {{ vulnerability.state|upper }}
                </span>
            </div>
        </div>
    </div>

    <!-- Vulnerability Information -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Vulnerability Details</h2>
            <dl class="space-y-3">
                <div>
                    <dt class="text-sm font-medium text-gray-500">ID</dt>
                    <dd class="text-sm text-gray-900 mt-1">{{ vulnerability.id }}</dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">Severity</dt>
                    <dd class="text-sm text-gray-900 mt-1">{{ vulnerability.severity|default:"—" }}</dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">Confidence</dt>
                    <dd class="text-sm text-gray-900 mt-1">{{ vulnerability.confidence|default:"—" }}</dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">Report Type</dt>
                    <dd class="text-sm text-gray-900 mt-1">{{ vulnerability.report_type|default:"—" }}</dd>
                </div>
                {% if vulnerability.finding_id %}
                <div>
                    <dt class="text-sm font-medium text-gray-500">Finding ID</dt>
                    <dd class="text-sm text-gray-900 mt-1">{{ vulnerability.finding_id }}</dd>
                </div>
                {% endif %}
            </dl>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Scanner Information</h2>
            <dl class="space-y-3">
                {% if vulnerability.scanner_name %}
                <div>
                    <dt class="text-sm font-medium text-gray-500">Scanner Name</dt>
                    <dd class="text-sm text-gray-900 mt-1">{{ vulnerability.scanner_name }}</dd>
                </div>
                {% endif %}
                {% if vulnerability.scanner_vendor %}
                <div>
                    <dt class="text-sm font-medium text-gray-500">Scanner Vendor</dt>
                    <dd class="text-sm text-gray-900 mt-1">{{ vulnerability.scanner_vendor }}</dd>
                </div>
                {% endif %}
                {% if vulnerability.author %}
                <div>
                    <dt class="text-sm font-medium text-gray-500">Reported By</dt>
                    <dd class="text-sm text-blue-600 hover:text-blue-800 mt-1">
                        <a href="{% url 'gitlab_sync_user_detail' vulnerability.author.id %}">{{ vulnerability.author.name }}</a>
                    </dd>
                </div>
                {% endif %}
                {% if vulnerability.resolved_by %}
                <div>
                    <dt class="text-sm font-medium text-gray-500">Resolved By</dt>
                    <dd class="text-sm text-blue-600 hover:text-blue-800 mt-1">
                        <a href="{% url 'gitlab_sync_user_detail' vulnerability.resolved_by.id %}">{{ vulnerability.resolved_by.name }}</a>
                    </dd>
                </div>
                {% endif %}
                {% if vulnerability.dismissed_by %}
                <div>
                    <dt class="text-sm font-medium text-gray-500">Dismissed By</dt>
                    <dd class="text-sm text-blue-600 hover:text-blue-800 mt-1">
                        <a href="{% url 'gitlab_sync_user_detail' vulnerability.dismissed_by.id %}">{{ vulnerability.dismissed_by.name }}</a>
                    </dd>
                </div>
                {% endif %}
            </dl>
        </div>
    </div>

    <!-- Description -->
    {% if vulnerability.description %}
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Description</h2>
        <div class="text-sm text-gray-900 prose max-w-none">
            <pre class="whitespace-pre-wrap font-sans">{{ vulnerability.description }}</pre>
        </div>
    </div>
    {% endif %}

    <!-- Location Information -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Location</h2>
        <dl class="space-y-3">
            {% if vulnerability.location_file %}
            <div>
                <dt class="text-sm font-medium text-gray-500">File</dt>
                <dd class="text-sm text-gray-900 mt-1 font-mono">{{ vulnerability.location_file }}</dd>
            </div>
            {% endif %}
            {% if vulnerability.location_start_line %}
            <div>
                <dt class="text-sm font-medium text-gray-500">Line Range</dt>
                <dd class="text-sm text-gray-900 mt-1">
                    Lines {{ vulnerability.location_start_line }}{% if vulnerability.location_end_line %} - {{ vulnerability.location_end_line }}{% endif %}
                </dd>
            </div>
            {% endif %}
            {% if vulnerability.location_class %}
            <div>
                <dt class="text-sm font-medium text-gray-500">Class</dt>
                <dd class="text-sm text-gray-900 mt-1 font-mono">{{ vulnerability.location_class }}</dd>
            </div>
            {% endif %}
            {% if vulnerability.location_method %}
            <div>
                <dt class="text-sm font-medium text-gray-500">Method</dt>
                <dd class="text-sm text-gray-900 mt-1 font-mono">{{ vulnerability.location_method }}</dd>
            </div>
            {% endif %}
            {% if vulnerability.location_dependency %}
            <div>
                <dt class="text-sm font-medium text-gray-500">Dependency</dt>
                <dd class="text-sm text-gray-900 mt-1 font-mono">{{ vulnerability.location_dependency }}</dd>
            </div>
            {% endif %}
            {% if vulnerability.location_image %}
            <div>
                <dt class="text-sm font-medium text-gray-500">Image</dt>
                <dd class="text-sm text-gray-900 mt-1 font-mono">{{ vulnerability.location_image }}</dd>
            </div>
            {% endif %}
            {% if vulnerability.location_operating_system %}
            <div>
                <dt class="text-sm font-medium text-gray-500">Operating System</dt>
                <dd class="text-sm text-gray-900 mt-1">{{ vulnerability.location_operating_system }}</dd>
            </div>
            {% endif %}
        </dl>
    </div>

    <!-- Timestamps -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Timeline</h2>
        <dl class="space-y-3">
            {% if vulnerability.detected_at %}
            <div>
                <dt class="text-sm font-medium text-gray-500">Detected</dt>
                <dd class="text-sm text-gray-900 mt-1">{{ vulnerability.detected_at|date:"M d, Y H:i" }}</dd>
            </div>
            {% endif %}
            <div>
                <dt class="text-sm font-medium text-gray-500">Created</dt>
                <dd class="text-sm text-gray-900 mt-1">{{ vulnerability.created_at|date:"M d, Y H:i" }}</dd>
            </div>
            <div>
                <dt class="text-sm font-medium text-gray-500">Updated</dt>
                <dd class="text-sm text-gray-900 mt-1">{{ vulnerability.updated_at|date:"M d, Y H:i" }}</dd>
            </div>
            {% if vulnerability.resolved_at %}
            <div>
                <dt class="text-sm font-medium text-gray-500">Resolved</dt>
                <dd class="text-sm text-gray-900 mt-1">{{ vulnerability.resolved_at|date:"M d, Y H:i" }}</dd>
            </div>
            {% endif %}
            {% if vulnerability.dismissed_at %}
            <div>
                <dt class="text-sm font-medium text-gray-500">Dismissed</dt>
                <dd class="text-sm text-gray-900 mt-1">{{ vulnerability.dismissed_at|date:"M d, Y H:i" }}</dd>
            </div>
            {% endif %}
        </dl>
    </div>

    <!-- Identifiers & Links -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {% if vulnerability.identifiers %}
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Identifiers</h2>
            <div class="text-sm text-gray-900">
                <pre class="whitespace-pre-wrap font-mono text-xs">{{ vulnerability.identifiers }}</pre>
            </div>
        </div>
        {% endif %}

        {% if vulnerability.links %}
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Links</h2>
            <div class="text-sm text-gray-900">
                <pre class="whitespace-pre-wrap font-mono text-xs">{{ vulnerability.links }}</pre>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
