{% extends 'authenticated/base_authenticated.html' %}

{% block extra_head %}
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-6">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-white shadow-md rounded-lg">
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900">
                    {% if item %}Edit{% else %}Add{% endif %} Estimation Item
                </h2>
                <p class="mt-1 text-sm text-gray-500">for {{ estimation.name }}</p>
            </div>
            <form method="post" id="estimation-item-form" class="px-6 py-6">
                {% csrf_token %}

                {# Hidden field to preserve the estimation FK relationship #}
                <input type="hidden" name="estimation" value="{{ estimation.id }}">

                {% if form.non_field_errors %}
                    <div class="mb-6 bg-red-50 border border-red-200 rounded-md p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">Form Errors</h3>
                                <div class="mt-2 text-sm text-red-700">
                                    <ul class="list-disc list-inside space-y-1">
                                        {% for error in form.non_field_errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <div class="space-y-6">
                    <div>
                        <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Title {% if form.title.field.required %}<span class="text-red-500">*</span>{% endif %}
                        </label>
                        {{ form.title }}
                        <p class="mt-1 text-xs text-gray-500">Short, descriptive title for this item</p>
                        {% if form.title.errors %}<p class="mt-2 text-sm text-red-600">{{ form.title.errors.0 }}</p>{% endif %}
                    </div>

                    <div>
                        <label for="{{ form.group.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Group {% if form.group.field.required %}<span class="text-red-500">*</span>{% endif %}
                        </label>
                        {{ form.group }}
                        <datalist id="group-datalist">
                            {# Dynamically populated via JavaScript from existing groups #}
                        </datalist>
                        <p class="mt-1 text-xs text-gray-500">Optional category to logically group related items (e.g., Frontend, Backend, Database). Leave blank if not needed.</p>
                        {% if form.group.errors %}<p class="mt-2 text-sm text-red-600">{{ form.group.errors.0 }}</p>{% endif %}

                        <!-- Quick Select Group Cards -->
                        <div id="group-cards-container" class="mt-3 hidden">
                            <p class="text-xs font-medium text-gray-600 mb-2">Quick select from existing groups:</p>
                            <div id="group-cards" class="flex flex-wrap gap-2">
                                <!-- Cards will be populated dynamically -->
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label for="{{ form.links.id_for_label }}" class="block text-sm font-medium text-gray-700">
                                Related Links {% if form.links.field.required %}<span class="text-red-500">*</span>{% endif %}
                            </label>
                            <button type="button" id="add_new_link_button"
                                    class="inline-flex items-center px-3 py-1 border border-green-300 shadow-sm text-xs font-medium rounded text-green-700 bg-white hover:bg-green-50">
                                <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Add New Link
                            </button>
                        </div>

                        <!-- Selected Links Display (Cards) -->
                        <div id="selected-links-display" class="mb-3">
                            <!-- Cards will be dynamically inserted here -->
                        </div>

                        <!-- Hidden Select2 Field for Backend -->
                        <div class="hidden">
                            {{ form.links }}
                        </div>

                        <!-- Search/Add Links Dropdown -->
                        <div class="relative">
                            <button type="button" id="search_links_button"
                                    class="w-full flex items-center justify-between px-3 py-2 border border-gray-300 rounded-md text-sm text-gray-700 bg-white hover:bg-gray-50">
                                <span class="flex items-center">
                                    <svg class="h-4 w-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                    </svg>
                                    Search and add existing links...
                                </span>
                                <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                            <div id="links_dropdown" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg">
                                <!-- Search input -->
                                <div class="p-2 border-b border-gray-200">
                                    <div class="relative">
                                        <input type="text" id="link_search_input"
                                               placeholder="Type to search links..."
                                               class="w-full pl-8 pr-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <svg class="absolute left-2 top-2.5 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                        </svg>
                                    </div>
                                </div>
                                <!-- Links list -->
                                <div id="links_list" class="max-h-60 overflow-y-auto">
                                    <!-- Dropdown content will be dynamically populated -->
                                </div>
                            </div>
                        </div>

                        <p class="mt-1 text-xs text-gray-500">Click cards to remove links. Use the search button or "Add New Link" button to add links.</p>
                        {% if form.links.errors %}<p class="mt-2 text-sm text-red-600">{{ form.links.errors.0 }}</p>{% endif %}
                    </div>

                    <div>
                        <label for="{{ form.story_points.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Story Points {% if form.story_points.field.required %}<span class="text-red-500">*</span>{% endif %}
                        </label>
                        <div class="flex items-center space-x-2 max-w-md">
                            <div class="flex-shrink-0" style="width: 120px;">
                                {{ form.story_points }}
                            </div>
                            <button type="button" id="calculate_story_points"
                                    class="inline-flex items-center px-2 py-1 border border-blue-300 shadow-sm text-xs font-medium rounded text-blue-700 bg-blue-50 hover:bg-blue-100"
                                    title="Calculate story points based on lead dev base hours (1 point â‰ˆ 4 hours)"
                                    data-modifier="{{ estimation.story_points_modifier|default:1.0 }}">
                                <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                </svg>
                                Auto-Calculate
                            </button>
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Conventional agile wisdom: 1 story point â‰ˆ 4 hours of ideal work time. Click Auto-Calculate based on lead dev hours.</p>
                        {% if form.story_points.errors %}<p class="mt-2 text-sm text-red-600">{{ form.story_points.errors.0 }}</p>{% endif %}
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700">
                                Description (Markdown Supported) {% if form.description.field.required %}<span class="text-red-500">*</span>{% endif %}
                            </label>
                            <div class="flex space-x-2">
                                <button type="button" id="enhance_with_ai"
                                        class="inline-flex items-center px-3 py-1 border border-purple-300 shadow-sm text-xs font-medium rounded text-purple-700 bg-white hover:bg-purple-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                    </svg>
                                    <span id="enhance_button_text">Enhance with AI</span>
                                </button>
                                <button type="button" id="toggle_preview"
                                        class="inline-flex items-center px-2 py-1 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50">
                                    <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                    </svg>
                                    <span id="preview_button_text">Show Preview</span>
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-4" id="description_container">
                            <div id="description_editor">
                                {{ form.description }}
                            </div>
                            <div id="description_preview" class="hidden border border-gray-300 rounded-md p-4 bg-gray-50 prose prose-sm max-w-none">
                                <p class="text-gray-500 italic">Preview will appear here...</p>
                            </div>
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Detailed description with markdown support (use **bold**, *italic*, `code`, # headings, - lists, etc.)</p>
                        {% if form.description.errors %}<p class="mt-2 text-sm text-red-600">{{ form.description.errors.0 }}</p>{% endif %}
                    </div>

                    <div class="border-t border-gray-200 pt-6">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-lg font-medium text-gray-900">Development Hours</h3>
                                <p class="text-sm text-gray-500 mt-1">Enter Lead hours first. Other levels auto-fill (Senior=1.25Ã—, Mid=2Ã—, Junior=3Ã—). Also auto-fills code review (0.5Ã—), testing (1Ã—), and review iteration time (1Ã— lead review). You can override any value.</p>
                            </div>
                            <button type="button" id="recalculate_dev_hours" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Recalculate
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.hours_lead.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Lead Developer Hours
                                </label>
                                {{ form.hours_lead }}
                                {% if form.hours_lead.errors %}<p class="mt-2 text-sm text-red-600">{{ form.hours_lead.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.hours_senior.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Senior Developer Hours
                                </label>
                                {{ form.hours_senior }}
                                {% if form.hours_senior.errors %}<p class="mt-2 text-sm text-red-600">{{ form.hours_senior.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.hours_mid.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Mid-Level Developer Hours
                                </label>
                                {{ form.hours_mid }}
                                {% if form.hours_mid.errors %}<p class="mt-2 text-sm text-red-600">{{ form.hours_mid.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.hours_junior.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Junior Developer Hours
                                </label>
                                {{ form.hours_junior }}
                                {% if form.hours_junior.errors %}<p class="mt-2 text-sm text-red-600">{{ form.hours_junior.errors.0 }}</p>{% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-6">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-lg font-medium text-gray-900">Code Review Hours</h3>
                                <p class="text-sm text-gray-500 mt-1">Auto-filled at 0.5Ã— (50%) of development hours for each level. You can override any value.</p>
                            </div>
                            <button type="button" id="recalculate_code_review_hours" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Recalculate
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.code_review_hours_lead.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Lead Developer Hours
                                </label>
                                {{ form.code_review_hours_lead }}
                                {% if form.code_review_hours_lead.errors %}<p class="mt-2 text-sm text-red-600">{{ form.code_review_hours_lead.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.code_review_hours_senior.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Senior Developer Hours
                                </label>
                                {{ form.code_review_hours_senior }}
                                {% if form.code_review_hours_senior.errors %}<p class="mt-2 text-sm text-red-600">{{ form.code_review_hours_senior.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.code_review_hours_mid.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Mid-Level Developer Hours
                                </label>
                                {{ form.code_review_hours_mid }}
                                {% if form.code_review_hours_mid.errors %}<p class="mt-2 text-sm text-red-600">{{ form.code_review_hours_mid.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.code_review_hours_junior.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Junior Developer Hours
                                </label>
                                {{ form.code_review_hours_junior }}
                                {% if form.code_review_hours_junior.errors %}<p class="mt-2 text-sm text-red-600">{{ form.code_review_hours_junior.errors.0 }}</p>{% endif %}
                            </div>
                        </div>

                        <div class="mt-6 border-t border-gray-100 pt-6">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <label for="{{ form.code_reviewer_hours.id_for_label }}" class="block text-sm font-medium text-gray-900 mb-2">
                                    Code Reviewer Time (Lead Developer)
                                </label>
                                <div class="max-w-xs">
                                    {{ form.code_reviewer_hours }}
                                </div>
                                <p class="mt-2 text-xs text-gray-600">Auto-filled at 1Ã— (100%) of Lead Code Review hours. Time spent in back-and-forth code review process: addressing feedback, resolving issues, and iterating on changes based on review comments.</p>
                                {% if form.code_reviewer_hours.errors %}<p class="mt-2 text-sm text-red-600">{{ form.code_reviewer_hours.errors.0 }}</p>{% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-6">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-lg font-medium text-gray-900">Testing Hours</h3>
                                <p class="text-sm text-gray-500 mt-1">Auto-filled at 1Ã— (100%) of development hours for each level. You can override any value.</p>
                            </div>
                            <button type="button" id="recalculate_tests_hours" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Recalculate
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.tests_hours_lead.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Lead Developer Hours
                                </label>
                                {{ form.tests_hours_lead }}
                                {% if form.tests_hours_lead.errors %}<p class="mt-2 text-sm text-red-600">{{ form.tests_hours_lead.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.tests_hours_senior.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Senior Developer Hours
                                </label>
                                {{ form.tests_hours_senior }}
                                {% if form.tests_hours_senior.errors %}<p class="mt-2 text-sm text-red-600">{{ form.tests_hours_senior.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.tests_hours_mid.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Mid-Level Developer Hours
                                </label>
                                {{ form.tests_hours_mid }}
                                {% if form.tests_hours_mid.errors %}<p class="mt-2 text-sm text-red-600">{{ form.tests_hours_mid.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.tests_hours_junior.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Junior Developer Hours
                                </label>
                                {{ form.tests_hours_junior }}
                                {% if form.tests_hours_junior.errors %}<p class="mt-2 text-sm text-red-600">{{ form.tests_hours_junior.errors.0 }}</p>{% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Estimation Metadata</h3>
                        <p class="text-sm text-gray-500 mb-4">Complexity, priority, and uncertainty information</p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.cone_of_uncertainty.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Cone of Uncertainty {% if form.cone_of_uncertainty.field.required %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {{ form.cone_of_uncertainty }}
                                <p class="mt-1 text-xs text-gray-500">Project phase - automatically determines padding multiplier</p>
                                {% if form.cone_of_uncertainty.errors %}<p class="mt-2 text-sm text-red-600">{{ form.cone_of_uncertainty.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.complexity_level.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Complexity Level {% if form.complexity_level.field.required %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {{ form.complexity_level }}
                                <p class="mt-1 text-xs text-gray-500">Technical complexity of this item</p>
                                {% if form.complexity_level.errors %}<p class="mt-2 text-sm text-red-600">{{ form.complexity_level.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.priority.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Priority {% if form.priority.field.required %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {{ form.priority }}
                                <p class="mt-1 text-xs text-gray-500">Importance/urgency of this item</p>
                                {% if form.priority.errors %}<p class="mt-2 text-sm text-red-600">{{ form.priority.errors.0 }}</p>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Spacer to prevent content from being hidden behind sticky buttons -->
                <div class="h-20"></div>
            </form>
        </div>
    </div>
</div>

<!-- Sticky Save/Cancel Buttons -->
<div class="fixed left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-40" style="bottom: 28px;">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex justify-end space-x-3">
            <a href="{% url 'estimation_detail' estimation.id %}"
               class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Cancel
            </a>
            <button type="submit" form="estimation-item-form"
                    class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                Save
            </button>
        </div>
    </div>
</div>

<style>
    /* Style Django form fields with Tailwind */
    input[type="text"],
    input[type="email"],
    input[type="number"],
    input[type="url"],
    input[type="date"],
    input[type="datetime-local"],
    input[type="password"],
    textarea,
    select {
        display: block;
        width: 100%;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        line-height: 1.5;
        color: #1f2937;
        background-color: #ffffff;
        background-clip: padding-box;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="number"]:focus,
    input[type="url"]:focus,
    input[type="date"]:focus,
    input[type="datetime-local"]:focus,
    input[type="password"]:focus,
    textarea:focus,
    select:focus {
        color: #1f2937;
        background-color: #ffffff;
        border-color: #3b82f6;
        outline: 0;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    input[type="text"]:disabled,
    input[type="email"]:disabled,
    input[type="number"]:disabled,
    input[type="url"]:disabled,
    input[type="date"]:disabled,
    input[type="datetime-local"]:disabled,
    input[type="password"]:disabled,
    textarea:disabled,
    select:disabled {
        background-color: #f3f4f6;
        opacity: 1;
    }

    textarea {
        min-height: 100px;
        resize: vertical;
    }

    input[type="checkbox"] {
        width: 1rem;
        height: 1rem;
        color: #3b82f6;
        background-color: #ffffff;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        cursor: pointer;
    }

    input[type="checkbox"]:focus {
        border-color: #3b82f6;
        outline: 0;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    input[type="checkbox"]:checked {
        background-color: #3b82f6;
        border-color: #3b82f6;
    }

    /* Placeholder styling */
    input::placeholder,
    textarea::placeholder {
        color: #9ca3af;
        opacity: 1;
    }

    /* Markdown preview styling */
    #description_preview {
        min-height: 200px;
    }
    #description_preview h1,
    #description_preview h2,
    #description_preview h3,
    #description_preview h4,
    #description_preview h5,
    #description_preview h6 {
        font-weight: 600;
        margin-top: 1em;
        margin-bottom: 0.5em;
    }
    #description_preview h1 { font-size: 1.5em; }
    #description_preview h2 { font-size: 1.3em; }
    #description_preview h3 { font-size: 1.1em; }
    #description_preview ul,
    #description_preview ol {
        margin-left: 1.5em;
        margin-top: 0.5em;
        margin-bottom: 0.5em;
    }
    #description_preview code {
        background-color: #f3f4f6;
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-family: monospace;
    }
    #description_preview pre {
        background-color: #f3f4f6;
        padding: 1rem;
        border-radius: 0.375rem;
        overflow-x: auto;
        margin: 0.5em 0;
    }
    #description_preview pre code {
        background-color: transparent;
        padding: 0;
    }
    #description_preview blockquote {
        border-left: 4px solid #e5e7eb;
        padding-left: 1rem;
        margin: 0.5em 0;
        color: #6b7280;
    }
</style>

<!-- Marked.js for markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Populate group datalist and quick-select cards with existing groups from the estimation
    const groupField = document.getElementById('{{ form.group.id_for_label }}');
    if (groupField) {
        const existingGroups = groupField.getAttribute('data-existing-groups');
        if (existingGroups) {
            const datalist = document.getElementById('group-datalist');
            const groups = existingGroups.split('|').filter(g => g.trim() !== '');

            // Populate datalist
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                datalist.appendChild(option);
            });

            // Populate quick-select group cards
            if (groups.length > 0) {
                const groupCardsContainer = document.getElementById('group-cards-container');
                const groupCards = document.getElementById('group-cards');

                // Add "Ungrouped" card first
                const ungroupedCard = document.createElement('button');
                ungroupedCard.type = 'button';
                ungroupedCard.className = 'inline-flex items-center px-3 py-2 text-sm font-medium rounded-lg border-2 border-gray-300 bg-white text-gray-700 hover:border-red-500 hover:bg-red-50 hover:text-red-700 transition-all duration-150 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2';
                ungroupedCard.innerHTML = `
                    <svg class="h-4 w-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Ungrouped
                `;
                ungroupedCard.setAttribute('data-group-name', '');

                // Add click handler to clear the group field
                ungroupedCard.addEventListener('click', function() {
                    groupField.value = '';

                    // Visual feedback - highlight the selected card
                    document.querySelectorAll('#group-cards button').forEach(btn => {
                        btn.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-700', 'ring-2', 'ring-blue-500');
                        btn.classList.remove('border-red-500', 'bg-red-50', 'text-red-700', 'ring-red-500');
                        if (btn.getAttribute('data-group-name') === '') {
                            btn.classList.add('border-gray-300', 'bg-white', 'text-gray-700');
                        } else {
                            btn.classList.add('border-gray-300', 'bg-white', 'text-gray-700');
                        }
                    });
                    this.classList.remove('border-gray-300', 'bg-white', 'text-gray-700');
                    this.classList.add('border-red-500', 'bg-red-50', 'text-red-700', 'ring-2', 'ring-red-500');
                });

                groupCards.appendChild(ungroupedCard);

                // Add group cards
                groups.forEach(group => {
                    const card = document.createElement('button');
                    card.type = 'button';
                    card.className = 'inline-flex items-center px-3 py-2 text-sm font-medium rounded-lg border-2 border-gray-300 bg-white text-gray-700 hover:border-blue-500 hover:bg-blue-50 hover:text-blue-700 transition-all duration-150 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2';
                    card.innerHTML = `
                        <svg class="h-4 w-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                        </svg>
                        ${group}
                    `;
                    card.setAttribute('data-group-name', group);

                    // Add click handler to populate the group field
                    card.addEventListener('click', function() {
                        groupField.value = group;

                        // Visual feedback - highlight the selected card
                        document.querySelectorAll('#group-cards button').forEach(btn => {
                            btn.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-700', 'ring-2', 'ring-blue-500');
                            btn.classList.remove('border-red-500', 'bg-red-50', 'text-red-700', 'ring-red-500');
                            btn.classList.add('border-gray-300', 'bg-white', 'text-gray-700');
                        });
                        this.classList.remove('border-gray-300', 'bg-white', 'text-gray-700');
                        this.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-700', 'ring-2', 'ring-blue-500');
                    });

                    groupCards.appendChild(card);
                });

                // Show the cards container
                groupCardsContainer.classList.remove('hidden');

                // If the field already has a value, highlight the corresponding card
                const currentValue = groupField.value.trim();
                if (currentValue === '') {
                    // Highlight ungrouped card
                    const ungroupedCardElem = document.querySelector('#group-cards button[data-group-name=""]');
                    if (ungroupedCardElem) {
                        ungroupedCardElem.classList.remove('border-gray-300', 'bg-white', 'text-gray-700');
                        ungroupedCardElem.classList.add('border-red-500', 'bg-red-50', 'text-red-700', 'ring-2', 'ring-red-500');
                    }
                } else {
                    const matchingCard = document.querySelector(`#group-cards button[data-group-name="${currentValue}"]`);
                    if (matchingCard) {
                        matchingCard.classList.remove('border-gray-300', 'bg-white', 'text-gray-700');
                        matchingCard.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-700', 'ring-2', 'ring-blue-500');
                    }
                }

                // Update card highlighting when typing in the field
                groupField.addEventListener('input', function() {
                    const currentValue = this.value.trim();
                    document.querySelectorAll('#group-cards button').forEach(btn => {
                        const groupName = btn.getAttribute('data-group-name');

                        // Reset all cards
                        btn.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-700', 'ring-2', 'ring-blue-500');
                        btn.classList.remove('border-red-500', 'bg-red-50', 'text-red-700', 'ring-red-500');
                        btn.classList.add('border-gray-300', 'bg-white', 'text-gray-700');

                        // Highlight matching card
                        if (groupName === currentValue) {
                            btn.classList.remove('border-gray-300', 'bg-white', 'text-gray-700');
                            if (groupName === '') {
                                // Ungrouped card - red highlight
                                btn.classList.add('border-red-500', 'bg-red-50', 'text-red-700', 'ring-2', 'ring-red-500');
                            } else {
                                // Group card - blue highlight
                                btn.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-700', 'ring-2', 'ring-blue-500');
                            }
                        }
                    });
                });
            }
        }
    }

    // Enhance with AI functionality
    const descriptionField = document.getElementById('{{ form.description.id_for_label }}');
    const enhanceButton = document.getElementById('enhance_with_ai');
    const enhanceButtonText = document.getElementById('enhance_button_text');

    if (enhanceButton && descriptionField) {
        enhanceButton.addEventListener('click', function() {
            const currentDescription = descriptionField.value.trim();

            if (!currentDescription) {
                alert('Please enter some text in the description field first.');
                return;
            }

            if (!confirm('This will replace your current description with an AI-enhanced version. Continue?')) {
                return;
            }

            // Disable button and show loading state
            enhanceButton.disabled = true;
            enhanceButtonText.textContent = 'Enhancing...';

            // Get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Call the enhance endpoint
            fetch('{% url "estimation_item_enhance_description" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    description: currentDescription
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Replace the description with the enhanced version
                    descriptionField.value = data.enhanced_description;

                    // Update preview if it's visible
                    const previewDiv = document.getElementById('description_preview');
                    if (previewDiv && !previewDiv.classList.contains('hidden')) {
                        try {
                            previewDiv.innerHTML = marked.parse(data.enhanced_description);
                        } catch (e) {
                            previewDiv.innerHTML = '<p class="text-red-500">Error rendering markdown</p>';
                        }
                    }

                    alert('Description enhanced successfully!');
                } else {
                    alert('Error: ' + (data.error || 'Failed to enhance description'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while enhancing the description. Please try again.');
            })
            .finally(() => {
                // Re-enable button and restore text
                enhanceButton.disabled = false;
                enhanceButtonText.textContent = 'Enhance with AI';
            });
        });
    }

    // Markdown Preview functionality
    const previewDiv = document.getElementById('description_preview');
    const toggleButton = document.getElementById('toggle_preview');
    const buttonText = document.getElementById('preview_button_text');
    const descriptionContainer = document.getElementById('description_container');
    let previewVisible = false;

    if (toggleButton && descriptionField && previewDiv) {
        toggleButton.addEventListener('click', function() {
            previewVisible = !previewVisible;

            if (previewVisible) {
                // Show preview
                previewDiv.classList.remove('hidden');
                descriptionContainer.classList.remove('grid-cols-1');
                descriptionContainer.classList.add('grid-cols-2');
                buttonText.textContent = 'Hide Preview';
                updatePreview();
            } else {
                // Hide preview
                previewDiv.classList.add('hidden');
                descriptionContainer.classList.remove('grid-cols-2');
                descriptionContainer.classList.add('grid-cols-1');
                buttonText.textContent = 'Show Preview';
            }
        });

        // Update preview on input
        descriptionField.addEventListener('input', function() {
            if (previewVisible) {
                updatePreview();
            }
        });

        function updatePreview() {
            const markdownText = descriptionField.value;
            if (markdownText.trim() === '') {
                previewDiv.innerHTML = '<p class="text-gray-500 italic">Preview will appear here...</p>';
            } else {
                try {
                    previewDiv.innerHTML = marked.parse(markdownText);
                } catch (e) {
                    previewDiv.innerHTML = '<p class="text-red-500">Error rendering markdown</p>';
                }
            }
        }
    }
    // Helper function to format hours - rounds to 2 decimals but removes trailing zeros
    function formatHours(value) {
        return parseFloat(value.toFixed(2)).toString();
    }

    // Auto-populate hours based on lead dev values
    // Multipliers: Senior = 1.25x, Mid = 2x, Junior = 3x

    function autoPopulate(leadFieldId, seniorFieldId, midFieldId, juniorFieldId) {
        const leadField = document.getElementById(leadFieldId);
        if (!leadField) return;

        const seniorField = document.getElementById(seniorFieldId);
        const midField = document.getElementById(midFieldId);
        const juniorField = document.getElementById(juniorFieldId);

        leadField.addEventListener('input', function() {
            const leadValue = parseFloat(leadField.value) || 0;

            // Only auto-populate if the dependent field hasn't been manually modified
            // We check if the current value matches what it would be from auto-population
            if (seniorField && (seniorField.value === '' || parseFloat(seniorField.value) === 0)) {
                seniorField.value = formatHours(leadValue * 1.25);
            }
            if (midField && (midField.value === '' || parseFloat(midField.value) === 0)) {
                midField.value = formatHours(leadValue * 2);
            }
            if (juniorField && (juniorField.value === '' || parseFloat(juniorField.value) === 0)) {
                juniorField.value = formatHours(leadValue * 3);
            }
        });
    }

    // Auto-populate code review hours as 0.5x of dev hours
    function autoPopulateCodeReview() {
        const levels = ['lead', 'senior', 'mid', 'junior'];

        levels.forEach(level => {
            const devField = document.getElementById(`id_hours_${level}`);
            const codeReviewField = document.getElementById(`id_code_review_hours_${level}`);

            if (!devField || !codeReviewField) return;

            devField.addEventListener('input', function() {
                const devValue = parseFloat(devField.value) || 0;
                // Only auto-populate if code review field is empty or zero
                if (codeReviewField.value === '' || parseFloat(codeReviewField.value) === 0) {
                    codeReviewField.value = formatHours(devValue * 0.5);
                }
            });
        });
    }

    // Auto-populate testing hours as 1x of dev hours
    function autoPopulateTests() {
        const levels = ['lead', 'senior', 'mid', 'junior'];

        levels.forEach(level => {
            const devField = document.getElementById(`id_hours_${level}`);
            const testsField = document.getElementById(`id_tests_hours_${level}`);

            if (!devField || !testsField) return;

            devField.addEventListener('input', function() {
                const devValue = parseFloat(devField.value) || 0;
                // Only auto-populate if tests field is empty or zero
                if (testsField.value === '' || parseFloat(testsField.value) === 0) {
                    testsField.value = formatHours(devValue * 1.0);
                }
            });
        });
    }

    // Auto-populate code reviewer hours as 1x of lead code review hours
    function autoPopulateCodeReviewer() {
        const leadCodeReviewField = document.getElementById('id_code_review_hours_lead');
        const codeReviewerField = document.getElementById('id_code_reviewer_hours');

        if (!leadCodeReviewField || !codeReviewerField) return;

        leadCodeReviewField.addEventListener('input', function() {
            const leadCodeReviewValue = parseFloat(leadCodeReviewField.value) || 0;
            // Only auto-populate if code reviewer field is empty or zero
            if (codeReviewerField.value === '' || parseFloat(codeReviewerField.value) === 0) {
                codeReviewerField.value = formatHours(leadCodeReviewValue * 1.0);
            }
        });
    }

    // Force recalculation function (ignores current values)
    function forceRecalculate(leadFieldId, seniorFieldId, midFieldId, juniorFieldId) {
        const leadField = document.getElementById(leadFieldId);
        if (!leadField) return;

        const leadValue = parseFloat(leadField.value) || 0;
        const seniorField = document.getElementById(seniorFieldId);
        const midField = document.getElementById(midFieldId);
        const juniorField = document.getElementById(juniorFieldId);

        if (seniorField) seniorField.value = formatHours(leadValue * 1.25);
        if (midField) midField.value = formatHours(leadValue * 2);
        if (juniorField) juniorField.value = formatHours(leadValue * 3);
    }

    // Force recalculate code review hours as 0.5x dev hours
    function forceRecalculateCodeReview() {
        const levels = ['lead', 'senior', 'mid', 'junior'];

        levels.forEach(level => {
            const devField = document.getElementById(`id_hours_${level}`);
            const codeReviewField = document.getElementById(`id_code_review_hours_${level}`);

            if (devField && codeReviewField) {
                const devValue = parseFloat(devField.value) || 0;
                codeReviewField.value = formatHours(devValue * 0.5);
            }
        });
    }

    // Force recalculate testing hours as 1x dev hours
    function forceRecalculateTests() {
        const levels = ['lead', 'senior', 'mid', 'junior'];

        levels.forEach(level => {
            const devField = document.getElementById(`id_hours_${level}`);
            const testsField = document.getElementById(`id_tests_hours_${level}`);

            if (devField && testsField) {
                const devValue = parseFloat(devField.value) || 0;
                testsField.value = formatHours(devValue * 1.0);
            }
        });
    }

    // Force recalculate code reviewer hours as 1x lead code review hours
    function forceRecalculateCodeReviewer() {
        const leadCodeReviewField = document.getElementById('id_code_review_hours_lead');
        const codeReviewerField = document.getElementById('id_code_reviewer_hours');

        if (leadCodeReviewField && codeReviewerField) {
            const leadCodeReviewValue = parseFloat(leadCodeReviewField.value) || 0;
            codeReviewerField.value = formatHours(leadCodeReviewValue * 1.0);
        }
    }

    // Apply auto-population to all categories
    autoPopulate('id_hours_lead', 'id_hours_senior', 'id_hours_mid', 'id_hours_junior');
    autoPopulateCodeReview(); // Auto-populate code review as 0.5x dev hours
    autoPopulateCodeReviewer(); // Auto-populate code reviewer hours as 1x lead code review hours
    autoPopulateTests(); // Auto-populate testing as 1x dev hours

    // Attach recalculate button handlers
    document.getElementById('recalculate_dev_hours')?.addEventListener('click', function() {
        forceRecalculate('id_hours_lead', 'id_hours_senior', 'id_hours_mid', 'id_hours_junior');
        // Also update code review, code reviewer, and testing hours when dev hours are recalculated
        forceRecalculateCodeReview();
        forceRecalculateCodeReviewer();
        forceRecalculateTests();
    });

    document.getElementById('recalculate_code_review_hours')?.addEventListener('click', function() {
        forceRecalculateCodeReview();
        forceRecalculateCodeReviewer();
    });

    document.getElementById('recalculate_tests_hours')?.addEventListener('click', function() {
        forceRecalculateTests();
    });

    // Story point calculation handler
    document.getElementById('calculate_story_points')?.addEventListener('click', function() {
        // Get lead dev base hours (dev + code review + testing)
        const leadDev = parseFloat(document.getElementById('id_hours_lead')?.value) || 0;
        const leadCodeReview = parseFloat(document.getElementById('id_code_review_hours_lead')?.value) || 0;
        const leadTests = parseFloat(document.getElementById('id_tests_hours_lead')?.value) || 0;

        const baseHours = leadDev + leadCodeReview + leadTests;

        if (baseHours === 0) {
            alert('Please enter lead developer hours first (dev, code review, and/or testing).');
            return;
        }

        // Get the story points modifier from the estimation (default to 1.0 if not available)
        const modifier = parseFloat(this.getAttribute('data-modifier')) || 1.0;

        // Calculate story points: 1 point â‰ˆ 4 hours, apply modifier, round to nearest 0.5
        const rawPoints = (baseHours / 4.0) * modifier;
        const roundedPoints = Math.round(rawPoints * 2) / 2;

        // Set the story points field
        const storyPointsField = document.getElementById('id_story_points');
        if (storyPointsField) {
            storyPointsField.value = roundedPoints.toFixed(1);
        }
    });

    // Links Management System
    let allLinks = []; // Will store all available links
    let selectedLinkIds = new Set(); // Track selected link IDs

    // Initialize links system
    function initializeLinksSystem() {
        // Get initially selected links from the form
        const selectElement = document.getElementById('id_links');
        if (selectElement) {
            Array.from(selectElement.selectedOptions).forEach(option => {
                selectedLinkIds.add(option.value);
                allLinks.push({
                    id: option.value,
                    name: option.text,
                    url: option.getAttribute('data-url') || '#'
                });
            });
        }

        // Fetch all available links from the select options
        Array.from(selectElement.options).forEach(option => {
            if (!allLinks.find(l => l.id === option.value)) {
                allLinks.push({
                    id: option.value,
                    name: option.text,
                    url: option.getAttribute('data-url') || '#'
                });
            }
        });

        renderSelectedLinks();
        renderDropdown();
    }

    // Render selected links as cards
    function renderSelectedLinks() {
        const container = document.getElementById('selected-links-display');
        if (!container) return;

        if (selectedLinkIds.size === 0) {
            container.innerHTML = '<p class="text-sm text-gray-500 italic py-2">No links selected. Use the search button or "Add New Link" to add links.</p>';
            return;
        }

        const selectedLinks = allLinks.filter(link => selectedLinkIds.has(link.id));
        container.innerHTML = selectedLinks.map(link => `
            <div class="inline-flex items-center gap-2 px-3 py-2 mr-2 mb-2 text-sm font-medium rounded-lg bg-blue-50 text-blue-700 border border-blue-200 hover:bg-blue-100 transition-colors duration-150 group">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                </svg>
                <span class="font-medium">${link.name}</span>
                <button type="button" onclick="removeLink('${link.id}')"
                        class="ml-1 p-0.5 rounded hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        title="Remove link">
                    <svg class="h-4 w-4 text-blue-600 hover:text-blue-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        `).join('');

        // Update hidden select field
        syncHiddenSelect();
    }

    // Remove a link
    window.removeLink = function(linkId) {
        selectedLinkIds.delete(linkId);
        renderSelectedLinks();
        renderDropdown();
    };

    // Add a link
    window.addLink = function(linkId) {
        selectedLinkIds.add(linkId);
        renderSelectedLinks();
        renderDropdown();
        closeDropdown();
    };

    // Sync hidden select field
    function syncHiddenSelect() {
        const selectElement = document.getElementById('id_links');
        if (!selectElement) return;

        // Clear all selections
        Array.from(selectElement.options).forEach(option => {
            option.selected = false;
        });

        // Select the chosen ones
        selectedLinkIds.forEach(id => {
            const option = selectElement.querySelector(`option[value="${id}"]`);
            if (option) {
                option.selected = true;
            }
        });
    }

    // Render dropdown
    function renderDropdown(searchQuery = '') {
        const linksList = document.getElementById('links_list');
        if (!linksList) return;

        // Filter out already selected links
        let availableLinks = allLinks.filter(link => !selectedLinkIds.has(link.id));

        // Apply search filter
        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            availableLinks = availableLinks.filter(link =>
                link.name.toLowerCase().includes(query)
            );
        }

        if (availableLinks.length === 0) {
            linksList.innerHTML = '<p class="px-4 py-3 text-sm text-gray-500 italic">No links found.</p>';
            return;
        }

        linksList.innerHTML = availableLinks.map(link => `
            <button type="button"
                    onclick="addLink('${link.id}')"
                    class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 focus:bg-gray-100 focus:outline-none border-b border-gray-100 last:border-b-0">
                <div class="flex items-center">
                    <svg class="h-4 w-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                    </svg>
                    <span>${link.name}</span>
                </div>
            </button>
        `).join('');
    }

    // Toggle dropdown
    const searchButton = document.getElementById('search_links_button');
    const dropdown = document.getElementById('links_dropdown');
    const searchInput = document.getElementById('link_search_input');

    searchButton?.addEventListener('click', function(e) {
        e.stopPropagation();
        const isHidden = dropdown.classList.contains('hidden');
        dropdown.classList.toggle('hidden');

        if (isHidden) {
            // Opening dropdown
            setTimeout(() => {
                searchInput?.focus();
            }, 100);
        } else {
            // Closing dropdown
            closeDropdown();
        }
    });

    // Search input filtering
    searchInput?.addEventListener('input', function(e) {
        renderDropdown(e.target.value);
    });

    // Prevent dropdown from closing when clicking inside it
    dropdown?.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchButton?.contains(e.target) && !dropdown?.contains(e.target)) {
            closeDropdown();
        }
    });

    function closeDropdown() {
        dropdown?.classList.add('hidden');
        if (searchInput) {
            searchInput.value = '';
        }
        renderDropdown(); // Reset to show all available links
    }

    // Handle "Add New Link" button
    document.getElementById('add_new_link_button')?.addEventListener('click', function() {
        window.openLinkModal(function(newLink) {
            // Add the new link to our data
            allLinks.push({
                id: newLink.id.toString(),
                name: newLink.name,
                url: newLink.url
            });

            // Add to hidden select
            const selectElement = document.getElementById('id_links');
            const newOption = new Option(newLink.name, newLink.id, true, true);
            newOption.setAttribute('data-url', newLink.url);
            selectElement.appendChild(newOption);

            // Add to selected
            selectedLinkIds.add(newLink.id.toString());
            renderSelectedLinks();
            renderDropdown();
        });
    });

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', function() {
        initializeLinksSystem();
    });

    // Keyboard shortcut: Ctrl+S or Cmd+S to save form
    document.addEventListener('keydown', function(e) {
        // Check for Ctrl+S (Windows/Linux) or Cmd+S (Mac)
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault(); // Prevent browser's default save dialog

            // Submit the form
            const form = document.getElementById('estimation-item-form');
            if (form) {
                form.submit();
            }
        }
    });
});
</script>

<!-- Include reusable link modal component -->
{% include 'authenticated/common/components/link_modal.html' %}

{% endblock %}
