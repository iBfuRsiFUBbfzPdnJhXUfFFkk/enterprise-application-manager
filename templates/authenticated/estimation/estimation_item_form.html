{% extends 'authenticated/base_authenticated.html' %}
{% block content %}
<div class="min-h-screen bg-gray-50 py-6">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-white shadow-md rounded-lg">
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900">
                    {% if item %}Edit{% else %}Add{% endif %} Estimation Item
                </h2>
                <p class="mt-1 text-sm text-gray-500">for {{ estimation.name }}</p>
            </div>
            <form method="post" class="px-6 py-6">
                {% csrf_token %}

                {# Hidden field to preserve the estimation FK relationship #}
                <input type="hidden" name="estimation" value="{{ estimation.id }}">

                {% if form.non_field_errors %}
                    <div class="mb-6 bg-red-50 border border-red-200 rounded-md p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">Form Errors</h3>
                                <div class="mt-2 text-sm text-red-700">
                                    <ul class="list-disc list-inside space-y-1">
                                        {% for error in form.non_field_errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <div class="space-y-6">
                    <div>
                        <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Title {% if form.title.field.required %}<span class="text-red-500">*</span>{% endif %}
                        </label>
                        {{ form.title }}
                        <p class="mt-1 text-xs text-gray-500">Short, descriptive title for this item</p>
                        {% if form.title.errors %}<p class="mt-2 text-sm text-red-600">{{ form.title.errors.0 }}</p>{% endif %}
                    </div>

                    <div>
                        <label for="{{ form.group.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Group {% if form.group.field.required %}<span class="text-red-500">*</span>{% endif %}
                        </label>
                        {{ form.group }}
                        <datalist id="group-datalist">
                            {# Dynamically populated via JavaScript from existing groups #}
                        </datalist>
                        <p class="mt-1 text-xs text-gray-500">Optional category to logically group related items (e.g., Frontend, Backend, Database). Leave blank if not needed.</p>
                        {% if form.group.errors %}<p class="mt-2 text-sm text-red-600">{{ form.group.errors.0 }}</p>{% endif %}
                    </div>

                    <div>
                        <label for="{{ form.story_points.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Story Points {% if form.story_points.field.required %}<span class="text-red-500">*</span>{% endif %}
                        </label>
                        <div class="flex items-center space-x-2 max-w-md">
                            <div class="flex-shrink-0" style="width: 120px;">
                                {{ form.story_points }}
                            </div>
                            <button type="button" id="calculate_story_points"
                                    class="inline-flex items-center px-2 py-1 border border-blue-300 shadow-sm text-xs font-medium rounded text-blue-700 bg-blue-50 hover:bg-blue-100"
                                    title="Calculate story points based on lead dev base hours (1 point ≈ 4 hours)">
                                <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                </svg>
                                Auto-Calculate
                            </button>
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Conventional agile wisdom: 1 story point ≈ 4 hours of ideal work time. Click Auto-Calculate based on lead dev hours.</p>
                        {% if form.story_points.errors %}<p class="mt-2 text-sm text-red-600">{{ form.story_points.errors.0 }}</p>{% endif %}
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700">
                                Description (Markdown Supported) {% if form.description.field.required %}<span class="text-red-500">*</span>{% endif %}
                            </label>
                            <button type="button" id="toggle_preview"
                                    class="inline-flex items-center px-2 py-1 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50">
                                <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                <span id="preview_button_text">Show Preview</span>
                            </button>
                        </div>
                        <div class="grid grid-cols-1 gap-4" id="description_container">
                            <div id="description_editor">
                                {{ form.description }}
                            </div>
                            <div id="description_preview" class="hidden border border-gray-300 rounded-md p-4 bg-gray-50 prose prose-sm max-w-none">
                                <p class="text-gray-500 italic">Preview will appear here...</p>
                            </div>
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Detailed description with markdown support (use **bold**, *italic*, `code`, # headings, - lists, etc.)</p>
                        {% if form.description.errors %}<p class="mt-2 text-sm text-red-600">{{ form.description.errors.0 }}</p>{% endif %}
                    </div>

                    <div class="border-t border-gray-200 pt-6">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-lg font-medium text-gray-900">Development Hours</h3>
                                <p class="text-sm text-gray-500 mt-1">Enter Lead hours first. Other levels auto-fill (Senior=1.25×, Mid=2×, Junior=3×). Also auto-fills code review (0.5×), testing (1×), and review iteration time (1× lead review). You can override any value.</p>
                            </div>
                            <button type="button" id="recalculate_dev_hours" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Recalculate
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.hours_lead.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Lead Developer Hours
                                </label>
                                {{ form.hours_lead }}
                                {% if form.hours_lead.errors %}<p class="mt-2 text-sm text-red-600">{{ form.hours_lead.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.hours_senior.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Senior Developer Hours
                                </label>
                                {{ form.hours_senior }}
                                {% if form.hours_senior.errors %}<p class="mt-2 text-sm text-red-600">{{ form.hours_senior.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.hours_mid.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Mid-Level Developer Hours
                                </label>
                                {{ form.hours_mid }}
                                {% if form.hours_mid.errors %}<p class="mt-2 text-sm text-red-600">{{ form.hours_mid.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.hours_junior.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Junior Developer Hours
                                </label>
                                {{ form.hours_junior }}
                                {% if form.hours_junior.errors %}<p class="mt-2 text-sm text-red-600">{{ form.hours_junior.errors.0 }}</p>{% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-6">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-lg font-medium text-gray-900">Code Review Hours</h3>
                                <p class="text-sm text-gray-500 mt-1">Auto-filled at 0.5× (50%) of development hours for each level. You can override any value.</p>
                            </div>
                            <button type="button" id="recalculate_code_review_hours" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Recalculate
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.code_review_hours_lead.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Lead Developer Hours
                                </label>
                                {{ form.code_review_hours_lead }}
                                {% if form.code_review_hours_lead.errors %}<p class="mt-2 text-sm text-red-600">{{ form.code_review_hours_lead.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.code_review_hours_senior.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Senior Developer Hours
                                </label>
                                {{ form.code_review_hours_senior }}
                                {% if form.code_review_hours_senior.errors %}<p class="mt-2 text-sm text-red-600">{{ form.code_review_hours_senior.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.code_review_hours_mid.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Mid-Level Developer Hours
                                </label>
                                {{ form.code_review_hours_mid }}
                                {% if form.code_review_hours_mid.errors %}<p class="mt-2 text-sm text-red-600">{{ form.code_review_hours_mid.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.code_review_hours_junior.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Junior Developer Hours
                                </label>
                                {{ form.code_review_hours_junior }}
                                {% if form.code_review_hours_junior.errors %}<p class="mt-2 text-sm text-red-600">{{ form.code_review_hours_junior.errors.0 }}</p>{% endif %}
                            </div>
                        </div>

                        <div class="mt-6 border-t border-gray-100 pt-6">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <label for="{{ form.code_reviewer_hours.id_for_label }}" class="block text-sm font-medium text-gray-900 mb-2">
                                    Code Reviewer Time (Lead Developer)
                                </label>
                                <div class="max-w-xs">
                                    {{ form.code_reviewer_hours }}
                                </div>
                                <p class="mt-2 text-xs text-gray-600">Auto-filled at 1× (100%) of Lead Code Review hours. Time spent in back-and-forth code review process: addressing feedback, resolving issues, and iterating on changes based on review comments.</p>
                                {% if form.code_reviewer_hours.errors %}<p class="mt-2 text-sm text-red-600">{{ form.code_reviewer_hours.errors.0 }}</p>{% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-6">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-lg font-medium text-gray-900">Testing Hours</h3>
                                <p class="text-sm text-gray-500 mt-1">Auto-filled at 1× (100%) of development hours for each level. You can override any value.</p>
                            </div>
                            <button type="button" id="recalculate_tests_hours" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Recalculate
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.tests_hours_lead.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Lead Developer Hours
                                </label>
                                {{ form.tests_hours_lead }}
                                {% if form.tests_hours_lead.errors %}<p class="mt-2 text-sm text-red-600">{{ form.tests_hours_lead.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.tests_hours_senior.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Senior Developer Hours
                                </label>
                                {{ form.tests_hours_senior }}
                                {% if form.tests_hours_senior.errors %}<p class="mt-2 text-sm text-red-600">{{ form.tests_hours_senior.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.tests_hours_mid.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Mid-Level Developer Hours
                                </label>
                                {{ form.tests_hours_mid }}
                                {% if form.tests_hours_mid.errors %}<p class="mt-2 text-sm text-red-600">{{ form.tests_hours_mid.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.tests_hours_junior.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Junior Developer Hours
                                </label>
                                {{ form.tests_hours_junior }}
                                {% if form.tests_hours_junior.errors %}<p class="mt-2 text-sm text-red-600">{{ form.tests_hours_junior.errors.0 }}</p>{% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Estimation Metadata</h3>
                        <p class="text-sm text-gray-500 mb-4">Complexity, priority, and uncertainty information</p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.cone_of_uncertainty.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Cone of Uncertainty {% if form.cone_of_uncertainty.field.required %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {{ form.cone_of_uncertainty }}
                                <p class="mt-1 text-xs text-gray-500">Project phase - automatically determines padding multiplier</p>
                                {% if form.cone_of_uncertainty.errors %}<p class="mt-2 text-sm text-red-600">{{ form.cone_of_uncertainty.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.complexity_level.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Complexity Level {% if form.complexity_level.field.required %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {{ form.complexity_level }}
                                <p class="mt-1 text-xs text-gray-500">Technical complexity of this item</p>
                                {% if form.complexity_level.errors %}<p class="mt-2 text-sm text-red-600">{{ form.complexity_level.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.priority.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Priority {% if form.priority.field.required %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {{ form.priority }}
                                <p class="mt-1 text-xs text-gray-500">Importance/urgency of this item</p>
                                {% if form.priority.errors %}<p class="mt-2 text-sm text-red-600">{{ form.priority.errors.0 }}</p>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <a href="{% url 'estimation_detail' estimation.id %}"
                       class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Cancel
                    </a>
                    <button type="submit"
                            class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    /* Style Django form fields with Tailwind */
    input[type="text"],
    input[type="email"],
    input[type="number"],
    input[type="url"],
    input[type="date"],
    input[type="datetime-local"],
    input[type="password"],
    textarea,
    select {
        display: block;
        width: 100%;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        line-height: 1.5;
        color: #1f2937;
        background-color: #ffffff;
        background-clip: padding-box;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="number"]:focus,
    input[type="url"]:focus,
    input[type="date"]:focus,
    input[type="datetime-local"]:focus,
    input[type="password"]:focus,
    textarea:focus,
    select:focus {
        color: #1f2937;
        background-color: #ffffff;
        border-color: #3b82f6;
        outline: 0;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    input[type="text"]:disabled,
    input[type="email"]:disabled,
    input[type="number"]:disabled,
    input[type="url"]:disabled,
    input[type="date"]:disabled,
    input[type="datetime-local"]:disabled,
    input[type="password"]:disabled,
    textarea:disabled,
    select:disabled {
        background-color: #f3f4f6;
        opacity: 1;
    }

    textarea {
        min-height: 100px;
        resize: vertical;
    }

    input[type="checkbox"] {
        width: 1rem;
        height: 1rem;
        color: #3b82f6;
        background-color: #ffffff;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        cursor: pointer;
    }

    input[type="checkbox"]:focus {
        border-color: #3b82f6;
        outline: 0;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    input[type="checkbox"]:checked {
        background-color: #3b82f6;
        border-color: #3b82f6;
    }

    /* Placeholder styling */
    input::placeholder,
    textarea::placeholder {
        color: #9ca3af;
        opacity: 1;
    }

    /* Markdown preview styling */
    #description_preview {
        min-height: 200px;
    }
    #description_preview h1,
    #description_preview h2,
    #description_preview h3,
    #description_preview h4,
    #description_preview h5,
    #description_preview h6 {
        font-weight: 600;
        margin-top: 1em;
        margin-bottom: 0.5em;
    }
    #description_preview h1 { font-size: 1.5em; }
    #description_preview h2 { font-size: 1.3em; }
    #description_preview h3 { font-size: 1.1em; }
    #description_preview ul,
    #description_preview ol {
        margin-left: 1.5em;
        margin-top: 0.5em;
        margin-bottom: 0.5em;
    }
    #description_preview code {
        background-color: #f3f4f6;
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-family: monospace;
    }
    #description_preview pre {
        background-color: #f3f4f6;
        padding: 1rem;
        border-radius: 0.375rem;
        overflow-x: auto;
        margin: 0.5em 0;
    }
    #description_preview pre code {
        background-color: transparent;
        padding: 0;
    }
    #description_preview blockquote {
        border-left: 4px solid #e5e7eb;
        padding-left: 1rem;
        margin: 0.5em 0;
        color: #6b7280;
    }
</style>

<!-- Marked.js for markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Populate group datalist with existing groups from the estimation
    const groupField = document.getElementById('{{ form.group.id_for_label }}');
    if (groupField) {
        const existingGroups = groupField.getAttribute('data-existing-groups');
        if (existingGroups) {
            const datalist = document.getElementById('group-datalist');
            const groups = existingGroups.split('|').filter(g => g.trim() !== '');
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                datalist.appendChild(option);
            });
        }
    }

    // Markdown Preview functionality
    const descriptionField = document.getElementById('{{ form.description.id_for_label }}');
    const previewDiv = document.getElementById('description_preview');
    const toggleButton = document.getElementById('toggle_preview');
    const buttonText = document.getElementById('preview_button_text');
    const descriptionContainer = document.getElementById('description_container');
    let previewVisible = false;

    if (toggleButton && descriptionField && previewDiv) {
        toggleButton.addEventListener('click', function() {
            previewVisible = !previewVisible;

            if (previewVisible) {
                // Show preview
                previewDiv.classList.remove('hidden');
                descriptionContainer.classList.remove('grid-cols-1');
                descriptionContainer.classList.add('grid-cols-2');
                buttonText.textContent = 'Hide Preview';
                updatePreview();
            } else {
                // Hide preview
                previewDiv.classList.add('hidden');
                descriptionContainer.classList.remove('grid-cols-2');
                descriptionContainer.classList.add('grid-cols-1');
                buttonText.textContent = 'Show Preview';
            }
        });

        // Update preview on input
        descriptionField.addEventListener('input', function() {
            if (previewVisible) {
                updatePreview();
            }
        });

        function updatePreview() {
            const markdownText = descriptionField.value;
            if (markdownText.trim() === '') {
                previewDiv.innerHTML = '<p class="text-gray-500 italic">Preview will appear here...</p>';
            } else {
                try {
                    previewDiv.innerHTML = marked.parse(markdownText);
                } catch (e) {
                    previewDiv.innerHTML = '<p class="text-red-500">Error rendering markdown</p>';
                }
            }
        }
    }
    // Auto-populate hours based on lead dev values
    // Multipliers: Senior = 1.25x, Mid = 2x, Junior = 3x

    function autoPopulate(leadFieldId, seniorFieldId, midFieldId, juniorFieldId) {
        const leadField = document.getElementById(leadFieldId);
        if (!leadField) return;

        const seniorField = document.getElementById(seniorFieldId);
        const midField = document.getElementById(midFieldId);
        const juniorField = document.getElementById(juniorFieldId);

        leadField.addEventListener('input', function() {
            const leadValue = parseFloat(leadField.value) || 0;

            // Only auto-populate if the dependent field hasn't been manually modified
            // We check if the current value matches what it would be from auto-population
            if (seniorField && (seniorField.value === '' || parseFloat(seniorField.value) === 0)) {
                seniorField.value = (leadValue * 1.25).toFixed(2);
            }
            if (midField && (midField.value === '' || parseFloat(midField.value) === 0)) {
                midField.value = (leadValue * 2).toFixed(2);
            }
            if (juniorField && (juniorField.value === '' || parseFloat(juniorField.value) === 0)) {
                juniorField.value = (leadValue * 3).toFixed(2);
            }
        });
    }

    // Auto-populate code review hours as 0.5x of dev hours
    function autoPopulateCodeReview() {
        const levels = ['lead', 'senior', 'mid', 'junior'];

        levels.forEach(level => {
            const devField = document.getElementById(`id_hours_${level}`);
            const codeReviewField = document.getElementById(`id_code_review_hours_${level}`);

            if (!devField || !codeReviewField) return;

            devField.addEventListener('input', function() {
                const devValue = parseFloat(devField.value) || 0;
                // Only auto-populate if code review field is empty or zero
                if (codeReviewField.value === '' || parseFloat(codeReviewField.value) === 0) {
                    codeReviewField.value = (devValue * 0.5).toFixed(2);
                }
            });
        });
    }

    // Auto-populate testing hours as 1x of dev hours
    function autoPopulateTests() {
        const levels = ['lead', 'senior', 'mid', 'junior'];

        levels.forEach(level => {
            const devField = document.getElementById(`id_hours_${level}`);
            const testsField = document.getElementById(`id_tests_hours_${level}`);

            if (!devField || !testsField) return;

            devField.addEventListener('input', function() {
                const devValue = parseFloat(devField.value) || 0;
                // Only auto-populate if tests field is empty or zero
                if (testsField.value === '' || parseFloat(testsField.value) === 0) {
                    testsField.value = (devValue * 1.0).toFixed(2);
                }
            });
        });
    }

    // Auto-populate code reviewer hours as 1x of lead code review hours
    function autoPopulateCodeReviewer() {
        const leadCodeReviewField = document.getElementById('id_code_review_hours_lead');
        const codeReviewerField = document.getElementById('id_code_reviewer_hours');

        if (!leadCodeReviewField || !codeReviewerField) return;

        leadCodeReviewField.addEventListener('input', function() {
            const leadCodeReviewValue = parseFloat(leadCodeReviewField.value) || 0;
            // Only auto-populate if code reviewer field is empty or zero
            if (codeReviewerField.value === '' || parseFloat(codeReviewerField.value) === 0) {
                codeReviewerField.value = (leadCodeReviewValue * 1.0).toFixed(2);
            }
        });
    }

    // Force recalculation function (ignores current values)
    function forceRecalculate(leadFieldId, seniorFieldId, midFieldId, juniorFieldId) {
        const leadField = document.getElementById(leadFieldId);
        if (!leadField) return;

        const leadValue = parseFloat(leadField.value) || 0;
        const seniorField = document.getElementById(seniorFieldId);
        const midField = document.getElementById(midFieldId);
        const juniorField = document.getElementById(juniorFieldId);

        if (seniorField) seniorField.value = (leadValue * 1.25).toFixed(2);
        if (midField) midField.value = (leadValue * 2).toFixed(2);
        if (juniorField) juniorField.value = (leadValue * 3).toFixed(2);
    }

    // Force recalculate code review hours as 0.5x dev hours
    function forceRecalculateCodeReview() {
        const levels = ['lead', 'senior', 'mid', 'junior'];

        levels.forEach(level => {
            const devField = document.getElementById(`id_hours_${level}`);
            const codeReviewField = document.getElementById(`id_code_review_hours_${level}`);

            if (devField && codeReviewField) {
                const devValue = parseFloat(devField.value) || 0;
                codeReviewField.value = (devValue * 0.5).toFixed(2);
            }
        });
    }

    // Force recalculate testing hours as 1x dev hours
    function forceRecalculateTests() {
        const levels = ['lead', 'senior', 'mid', 'junior'];

        levels.forEach(level => {
            const devField = document.getElementById(`id_hours_${level}`);
            const testsField = document.getElementById(`id_tests_hours_${level}`);

            if (devField && testsField) {
                const devValue = parseFloat(devField.value) || 0;
                testsField.value = (devValue * 1.0).toFixed(2);
            }
        });
    }

    // Force recalculate code reviewer hours as 1x lead code review hours
    function forceRecalculateCodeReviewer() {
        const leadCodeReviewField = document.getElementById('id_code_review_hours_lead');
        const codeReviewerField = document.getElementById('id_code_reviewer_hours');

        if (leadCodeReviewField && codeReviewerField) {
            const leadCodeReviewValue = parseFloat(leadCodeReviewField.value) || 0;
            codeReviewerField.value = (leadCodeReviewValue * 1.0).toFixed(2);
        }
    }

    // Apply auto-population to all categories
    autoPopulate('id_hours_lead', 'id_hours_senior', 'id_hours_mid', 'id_hours_junior');
    autoPopulateCodeReview(); // Auto-populate code review as 0.5x dev hours
    autoPopulateCodeReviewer(); // Auto-populate code reviewer hours as 1x lead code review hours
    autoPopulateTests(); // Auto-populate testing as 1x dev hours

    // Attach recalculate button handlers
    document.getElementById('recalculate_dev_hours')?.addEventListener('click', function() {
        forceRecalculate('id_hours_lead', 'id_hours_senior', 'id_hours_mid', 'id_hours_junior');
        // Also update code review, code reviewer, and testing hours when dev hours are recalculated
        forceRecalculateCodeReview();
        forceRecalculateCodeReviewer();
        forceRecalculateTests();
    });

    document.getElementById('recalculate_code_review_hours')?.addEventListener('click', function() {
        forceRecalculateCodeReview();
        forceRecalculateCodeReviewer();
    });

    document.getElementById('recalculate_tests_hours')?.addEventListener('click', function() {
        forceRecalculateTests();
    });

    // Add 0.25 step to all hour input fields for increment behavior (without validation)
    function addStepWithoutValidation() {
        const hourFieldIds = [
            'id_hours_junior', 'id_hours_mid', 'id_hours_senior', 'id_hours_lead',
            'id_code_review_hours_junior', 'id_code_review_hours_mid',
            'id_code_review_hours_senior', 'id_code_review_hours_lead',
            'id_code_reviewer_hours',
            'id_tests_hours_junior', 'id_tests_hours_mid',
            'id_tests_hours_senior', 'id_tests_hours_lead',
            'id_story_points'
        ];

        hourFieldIds.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.setAttribute('step', '0.25');
            }
        });

        // Remove step validation on form submission
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                hourFieldIds.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        // Temporarily remove step attribute to bypass validation
                        field.removeAttribute('step');
                    }
                });
            });
        }
    }

    addStepWithoutValidation();

    // Story point calculation handler
    document.getElementById('calculate_story_points')?.addEventListener('click', function() {
        // Get lead dev base hours (dev + code review + testing)
        const leadDev = parseFloat(document.getElementById('id_hours_lead')?.value) || 0;
        const leadCodeReview = parseFloat(document.getElementById('id_code_review_hours_lead')?.value) || 0;
        const leadTests = parseFloat(document.getElementById('id_tests_hours_lead')?.value) || 0;

        const baseHours = leadDev + leadCodeReview + leadTests;

        if (baseHours === 0) {
            alert('Please enter lead developer hours first (dev, code review, and/or testing).');
            return;
        }

        // Calculate story points: 1 point ≈ 4 hours, rounded to nearest 0.5
        const rawPoints = baseHours / 4.0;
        const roundedPoints = Math.round(rawPoints * 2) / 2;

        // Set the story points field
        const storyPointsField = document.getElementById('id_story_points');
        if (storyPointsField) {
            storyPointsField.value = roundedPoints.toFixed(1);
        }
    });
});
</script>
{% endblock %}
