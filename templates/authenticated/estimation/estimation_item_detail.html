{% extends 'authenticated/base_authenticated.html' %}
{% load humanize %}

{% block extra_head %}
<style>
    /* Prose styling for markdown content */
    .prose {
        color: #374151;
        max-width: 65ch;
    }
    .prose p {
        margin-top: 1.25em;
        margin-bottom: 1.25em;
    }
    .prose h1 {
        font-size: 2.25em;
        margin-top: 0;
        margin-bottom: 0.8888889em;
        line-height: 1.1111111;
        font-weight: 800;
    }
    .prose h2 {
        font-size: 1.5em;
        margin-top: 2em;
        margin-bottom: 1em;
        line-height: 1.3333333;
        font-weight: 700;
    }
    .prose h3 {
        font-size: 1.25em;
        margin-top: 1.6em;
        margin-bottom: 0.6em;
        line-height: 1.6;
        font-weight: 600;
    }
    .prose ul, .prose ol {
        margin-top: 1.25em;
        margin-bottom: 1.25em;
        padding-left: 1.625em;
    }
    .prose li {
        margin-top: 0.5em;
        margin-bottom: 0.5em;
    }
    .prose code {
        color: #111827;
        font-weight: 600;
        font-size: 0.875em;
        background-color: #f3f4f6;
        padding: 0.2em 0.4em;
        border-radius: 0.25rem;
    }
    .prose pre {
        background-color: #1f2937;
        color: #f9fafb;
        overflow-x: auto;
        padding: 1em;
        border-radius: 0.375rem;
        margin-top: 1.7142857em;
        margin-bottom: 1.7142857em;
    }
    .prose pre code {
        background-color: transparent;
        color: inherit;
        font-size: 0.875em;
        font-weight: 400;
        padding: 0;
    }
    .prose blockquote {
        font-weight: 500;
        font-style: italic;
        color: #111827;
        border-left-width: 0.25rem;
        border-left-color: #e5e7eb;
        quotes: "\201C""\201D""\2018""\2019";
        margin-top: 1.6em;
        margin-bottom: 1.6em;
        padding-left: 1em;
    }
    .prose a {
        color: #2563eb;
        text-decoration: underline;
        font-weight: 500;
    }
    .prose a:hover {
        color: #1d4ed8;
    }
    .prose strong {
        color: #111827;
        font-weight: 600;
    }
    .prose table {
        width: 100%;
        table-layout: auto;
        text-align: left;
        margin-top: 2em;
        margin-bottom: 2em;
        font-size: 0.875em;
        line-height: 1.7142857;
    }
    .prose thead {
        border-bottom-width: 1px;
        border-bottom-color: #d1d5db;
    }
    .prose thead th {
        font-weight: 600;
        vertical-align: bottom;
        padding-right: 0.5714286em;
        padding-bottom: 0.5714286em;
        padding-left: 0.5714286em;
    }
    .prose tbody tr {
        border-bottom-width: 1px;
        border-bottom-color: #e5e7eb;
    }
    .prose tbody td {
        vertical-align: baseline;
        padding-top: 0.5714286em;
        padding-right: 0.5714286em;
        padding-bottom: 0.5714286em;
        padding-left: 0.5714286em;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-6">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="bg-white shadow-sm rounded-lg mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="flex items-center text-sm text-gray-500 mb-2">
                            <a href="{% url 'estimation_detail' estimation.id %}" class="hover:text-blue-600">
                                {{ estimation.name }}
                            </a>
                            <svg class="h-4 w-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                            <span>Item Details</span>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-900">
                            {{ item.title|default:"(No Title)" }}
                        </h1>
                        {% if item.group %}
                            <div class="mt-2">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    üìÅ {{ item.group }}
                                </span>
                            </div>
                        {% endif %}
                    </div>
                    <div class="flex space-x-2">
                        <a href="{% url 'estimation_item_edit' item.id %}"
                           class="inline-flex items-center px-4 py-2 border border-blue-300 shadow-sm text-sm font-medium rounded-md text-blue-700 bg-white hover:bg-blue-50">
                            <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                            Edit
                        </a>
                        <a href="{% url 'estimation_item_duplicate' item.id %}"
                           class="inline-flex items-center px-4 py-2 border border-green-300 shadow-sm text-sm font-medium rounded-md text-green-700 bg-white hover:bg-green-50">
                            <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                            Duplicate
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Description -->
                {% if item.description %}
                <div class="bg-white shadow-sm rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Description</h2>
                    </div>
                    <div class="px-6 py-4">
                        <div id="description-content" class="prose max-w-none text-gray-700">
                            <!-- Markdown will be rendered here by JavaScript -->
                        </div>
                        <script type="text/markdown" id="description-markdown">{{ item.description }}</script>
                    </div>
                </div>
                {% endif %}

                <!-- Related Links -->
                {% if item.links.exists %}
                <div class="bg-white shadow-sm rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Related Links</h2>
                    </div>
                    <div class="px-6 py-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {% for link in item.links.all %}
                                <a href="{{ link.url }}"
                                   target="_blank"
                                   rel="noopener noreferrer"
                                   class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 transition-colors duration-150 group">
                                    <div class="flex items-center min-w-0 flex-1">
                                        <div class="flex-shrink-0 h-10 w-10 bg-blue-100 rounded-lg flex items-center justify-center group-hover:bg-blue-200">
                                            <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                                            </svg>
                                        </div>
                                        <div class="ml-3 min-w-0 flex-1">
                                            <p class="text-sm font-medium text-gray-900 truncate">{{ link.name }}</p>
                                            {% if link.comment %}
                                                <p class="text-xs text-gray-500 truncate">{{ link.comment }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <svg class="h-4 w-4 text-gray-400 group-hover:text-blue-600 flex-shrink-0 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                    </svg>
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Hours Breakdown -->
                <div class="bg-white shadow-sm rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Hours Breakdown</h2>
                    </div>
                    <div class="px-6 py-4">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Junior</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Mid</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Senior</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Lead</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td class="px-4 py-3 text-sm font-medium text-gray-900">Development</td>
                                        <td class="px-4 py-3 text-sm text-right text-gray-600">{{ item.hours_junior|default:"0"|floatformat:-2 }}</td>
                                        <td class="px-4 py-3 text-sm text-right text-gray-600">{{ item.hours_mid|default:"0"|floatformat:-2 }}</td>
                                        <td class="px-4 py-3 text-sm text-right text-gray-600">{{ item.hours_senior|default:"0"|floatformat:-2 }}</td>
                                        <td class="px-4 py-3 text-sm text-right text-gray-600">{{ item.hours_lead|default:"0"|floatformat:-2 }}</td>
                                    </tr>
                                    <tr class="bg-gray-50">
                                        <td class="px-4 py-3 text-sm font-medium text-gray-900">Code Review</td>
                                        <td class="px-4 py-3 text-sm text-right text-gray-600">{{ item.code_review_hours_junior|default:"0"|floatformat:-2 }}</td>
                                        <td class="px-4 py-3 text-sm text-right text-gray-600">{{ item.code_review_hours_mid|default:"0"|floatformat:-2 }}</td>
                                        <td class="px-4 py-3 text-sm text-right text-gray-600">{{ item.code_review_hours_senior|default:"0"|floatformat:-2 }}</td>
                                        <td class="px-4 py-3 text-sm text-right text-gray-600">{{ item.code_review_hours_lead|default:"0"|floatformat:-2 }}</td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-3 text-sm font-medium text-gray-900">Testing</td>
                                        <td class="px-4 py-3 text-sm text-right text-gray-600">{{ item.tests_hours_junior|default:"0"|floatformat:-2 }}</td>
                                        <td class="px-4 py-3 text-sm text-right text-gray-600">{{ item.tests_hours_mid|default:"0"|floatformat:-2 }}</td>
                                        <td class="px-4 py-3 text-sm text-right text-gray-600">{{ item.tests_hours_senior|default:"0"|floatformat:-2 }}</td>
                                        <td class="px-4 py-3 text-sm text-right text-gray-600">{{ item.tests_hours_lead|default:"0"|floatformat:-2 }}</td>
                                    </tr>
                                    <tr class="bg-blue-50 font-semibold">
                                        <td class="px-4 py-3 text-sm text-gray-900">With Uncertainty ({{ item.get_uncertainty_multiplier }}x)</td>
                                        <td class="px-4 py-3 text-sm text-right text-blue-900">{{ item.get_junior_hours_with_uncertainty|floatformat:-2 }}</td>
                                        <td class="px-4 py-3 text-sm text-right text-blue-900">{{ item.get_mid_hours_with_uncertainty|floatformat:-2 }}</td>
                                        <td class="px-4 py-3 text-sm text-right text-blue-900">{{ item.get_senior_hours_with_uncertainty|floatformat:-2 }}</td>
                                        <td class="px-4 py-3 text-sm text-right text-blue-900">{{ item.get_lead_hours_with_uncertainty|floatformat:-2 }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-700">
                                <strong>Code Reviewer Hours:</strong> {{ item.code_reviewer_hours|default:"0"|floatformat:-2 }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Quick Stats -->
                <div class="bg-white shadow-sm rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Quick Stats</h2>
                    </div>
                    <div class="px-6 py-4 space-y-4">
                        <div>
                            <dt class="text-xs font-medium text-gray-500 uppercase mb-1">Story Points</dt>
                            <dd class="text-2xl font-bold text-blue-600">{{ item.story_points|default:"0"|floatformat:1 }}</dd>
                        </div>
                        <div>
                            <dt class="text-xs font-medium text-gray-500 uppercase mb-1">Complexity</dt>
                            <dd>
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                                    {% if item.complexity_level == 'LOW' %}bg-green-100 text-green-800
                                    {% elif item.complexity_level == 'MEDIUM' %}bg-yellow-100 text-yellow-800
                                    {% elif item.complexity_level == 'HIGH' %}bg-orange-100 text-orange-800
                                    {% elif item.complexity_level == 'VERY_HIGH' %}bg-red-100 text-red-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ item.get_complexity_level_display|default:"N/A" }}
                                </span>
                            </dd>
                        </div>
                        <div>
                            <dt class="text-xs font-medium text-gray-500 uppercase mb-1">Priority</dt>
                            <dd>
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                                    {% if item.priority == 'CRITICAL' %}bg-red-100 text-red-800
                                    {% elif item.priority == 'HIGH' %}bg-orange-100 text-orange-800
                                    {% elif item.priority == 'MEDIUM' %}bg-yellow-100 text-yellow-800
                                    {% elif item.priority == 'LOW' %}bg-green-100 text-green-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ item.get_priority_display|default:"N/A" }}
                                </span>
                            </dd>
                        </div>
                        <div>
                            <dt class="text-xs font-medium text-gray-500 uppercase mb-1">Cone of Uncertainty</dt>
                            <dd class="text-sm text-gray-900">{{ item.get_cone_of_uncertainty_display|default:"N/A" }}</dd>
                        </div>
                        <div>
                            <dt class="text-xs font-medium text-gray-500 uppercase mb-1">Order</dt>
                            <dd class="text-sm text-gray-900">{{ item.order|default:"N/A" }}</dd>
                        </div>
                    </div>
                </div>

                <!-- Metadata -->
                <div class="bg-white shadow-sm rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Metadata</h2>
                    </div>
                    <div class="px-6 py-4 space-y-3 text-sm">
                        {% if created_record %}
                        <div>
                            <dt class="text-xs font-medium text-gray-500 uppercase">Created</dt>
                            <dd class="text-gray-900 mt-1">{{ created_record.history_date|naturaltime }}</dd>
                        </div>
                        {% endif %}
                        {% if updated_record %}
                        <div>
                            <dt class="text-xs font-medium text-gray-500 uppercase">Last Updated</dt>
                            <dd class="text-gray-900 mt-1">{{ updated_record.history_date|naturaltime }}</dd>
                        </div>
                        {% endif %}
                        <div>
                            <dt class="text-xs font-medium text-gray-500 uppercase">ID</dt>
                            <dd class="text-gray-900 mt-1">{{ item.id }}</dd>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
<script>
// Render markdown in description
document.addEventListener('DOMContentLoaded', function() {
    const markdownScript = document.getElementById('description-markdown');
    const contentDiv = document.getElementById('description-content');

    if (markdownScript && contentDiv) {
        const markdownText = markdownScript.textContent;
        if (markdownText.trim()) {
            // Check if marked is available
            if (typeof marked !== 'undefined' && marked.parse) {
                // Configure marked to enable all markdown features
                marked.setOptions({
                    gfm: true,  // GitHub Flavored Markdown
                    breaks: false,  // Don't convert \n to <br>
                    headerIds: true,
                    mangle: false,
                    sanitize: false
                });

                const renderedHtml = marked.parse(markdownText);
                contentDiv.innerHTML = renderedHtml;
            } else {
                console.error('Marked.js library not loaded');
                contentDiv.textContent = markdownText; // Fallback to plain text
            }
        }
    }
});
</script>
{% endblock %}
