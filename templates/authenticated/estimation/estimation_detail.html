{% extends 'authenticated/base_authenticated.html' %}
{% load templatetags_markdown %}
{% block content %}
<div class="min-h-screen bg-gray-50 py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="bg-white shadow-sm rounded-lg mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-start">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">{{ model.name }}</h1>
                        {% if model.description %}
                            <p class="mt-2 text-sm text-gray-600">{{ model.description }}</p>
                        {% endif %}
                        {% if model.links.exists %}
                            <div class="flex flex-wrap gap-2 mt-3">
                                {% for link in model.links.all %}
                                    <a href="{{ link.get_short_url }}"
                                       target="_blank"
                                       rel="noopener noreferrer"
                                       class="inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-lg bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-200 transition-colors duration-150"
                                       title="{{ link.comment|default:link.url }}">
                                        <svg class="h-3.5 w-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                                        </svg>
                                        {{ link.name }}
                                        <svg class="h-3 w-3 ml-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                        </svg>
                                    </a>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="flex space-x-2">
                        <a href="{% url 'estimation_export_docx' model.id %}"
                           class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            Export DOCX
                        </a>
                        <a href="{% url 'estimation_edit' model.id %}"
                           class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Edit
                        </a>
                        <a href="{% url 'estimation_delete' model.id %}"
                           onclick="return confirm('Are you sure you want to delete this estimation?')"
                           class="inline-flex items-center px-3 py-2 border border-red-300 shadow-sm text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50">
                            Delete
                        </a>
                    </div>
                </div>
            </div>

            <!-- Related Info -->
            <div class="px-6 py-4 bg-gray-50">
                <div class="grid grid-cols-3 gap-4 text-sm mb-4">
                    <div>
                        <span class="text-gray-500">Application:</span>
                        <span class="ml-2 font-medium">{{ model.application|default:"N/A" }}</span>
                    </div>
                    <div>
                        <span class="text-gray-500">Project:</span>
                        <span class="ml-2 font-medium">{{ model.project|default:"N/A" }}</span>
                    </div>
                    <div>
                        <span class="text-gray-500">Contingency:</span>
                        <span class="ml-2 font-medium">{{ model.contingency_padding_percent|default:"0"|floatformat:2 }}%</span>
                    </div>
                </div>
                <div class="border-t border-gray-200 pt-3">
                    <h3 class="text-xs font-semibold text-gray-600 uppercase mb-2">Team Composition (for duration estimates)</h3>
                    <div class="grid grid-cols-4 gap-4 text-sm">
                        <div>
                            <span class="text-gray-500">Junior Devs:</span>
                            <span class="ml-2 font-medium">{{ model.junior_developer_count|default:"0" }}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Mid Devs:</span>
                            <span class="ml-2 font-medium">{{ model.mid_developer_count|default:"0" }}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Senior Devs:</span>
                            <span class="ml-2 font-medium">{{ model.senior_developer_count|default:"0" }}</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Lead Devs:</span>
                            <span class="ml-2 font-medium">{{ model.lead_developer_count|default:"0" }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estimation Items -->
        <div class="bg-white shadow-sm rounded-lg mb-6">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-900">Estimation Items</h2>
                <div class="flex space-x-2">
                    <a href="{% url 'estimation_fix_item_order' model.id %}"
                       class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
                       title="Fix item ordering (useful when order values are corrupted)">
                        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                        Fix Order
                    </a>
                    <a href="{% url 'estimation_recalculate_all_items' model.id %}"
                       class="inline-flex items-center px-3 py-2 border border-purple-300 shadow-sm text-sm font-medium rounded-md text-purple-700 bg-white hover:bg-purple-50"
                       onclick="return confirm('Recalculate all hours and story points for all items? This will overwrite code review, testing, review iteration hours, and story points based on current dev hours.')"
                       title="Auto-calculate all hours and story points using lead dev hours as base (code review: 0.5x, testing: 1x, review iteration: 1x of lead review, story points: base hours / 4)">
                        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Recalculate All
                    </a>
                    <a href="{% url 'estimation_item_add' model.id %}"
                       class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Add Item
                    </a>
                </div>
            </div>

            {% if items %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 120px;">Order</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" style="min-width: 200px;">Title</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 70px;">Pts</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 90px;">Cmplx</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 80px;">Prior</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 70px;">CoU</th>
                                <th class="px-2 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 65px;" title="Junior Developer Hours (with cone of uncertainty)">Jr</th>
                                <th class="px-2 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 65px;" title="Mid-Level Developer Hours (with cone of uncertainty)">Mid</th>
                                <th class="px-2 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 65px;" title="Senior Developer Hours (with cone of uncertainty)">Sr</th>
                                <th class="px-2 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 65px;" title="Lead Developer Hours (with cone of uncertainty)">Lead</th>
                                <th class="px-2 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" style="width: 65px;" title="Review Iteration Time - Back-and-forth resolving review feedback (no multiplier)">Rev Iter</th>
                                <th class="px-2 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap" style="width: 140px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="estimation-items-tbody" class="bg-white">
                            {% for group_name, group_data in grouped_items.items %}
                                {# Group Header Row #}
                                <tr class="bg-gray-100 border-t-2 border-gray-300 group-header cursor-pointer hover:bg-gray-200" data-group-name="{{ group_name }}" onclick="toggleGroup('{{ group_name|escapejs }}')">
                                    <td colspan="12" class="px-3 py-2">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <svg class="h-4 w-4 mr-2 group-chevron transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                </svg>
                                                <div class="font-semibold text-gray-800 text-sm">
                                                    📁 {{ group_name }}
                                                    <span class="text-xs text-gray-600 font-normal ml-2">({{ group_data.items|length }} item{{ group_data.items|length|pluralize }})</span>
                                                </div>
                                            </div>
                                            <div class="flex items-center space-x-2" onclick="event.stopPropagation()">
                                                <div class="flex items-center">
                                                    <a href="{% url 'estimation_group_move_to_top' model.id group_name %}"
                                                       class="text-gray-600 hover:text-blue-600 p-0.5"
                                                       title="Move group to top">
                                                        <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7 7 7M5 19l7-7 7 7"/>
                                                        </svg>
                                                    </a>
                                                    <a href="{% url 'estimation_group_move_up' model.id group_name %}"
                                                       class="text-gray-600 hover:text-blue-600 p-0.5"
                                                       title="Move group up">
                                                        <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                                                        </svg>
                                                    </a>
                                                    <a href="{% url 'estimation_group_move_down' model.id group_name %}"
                                                       class="text-gray-600 hover:text-blue-600 p-0.5"
                                                       title="Move group down">
                                                        <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                        </svg>
                                                    </a>
                                                    <a href="{% url 'estimation_group_move_to_bottom' model.id group_name %}"
                                                       class="text-gray-600 hover:text-blue-600 p-0.5"
                                                       title="Move group to bottom">
                                                        <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7-7-7M19 5l-7 7-7-7"/>
                                                        </svg>
                                                    </a>
                                                </div>
                                                <button type="button"
                                                        onclick="renameGroup('{{ group_name|escapejs }}', {{ model.id }})"
                                                        class="inline-flex items-center px-2 py-1 text-xs font-medium text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors duration-150"
                                                        title="Rename this group">
                                                    <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                    </svg>
                                                    Rename
                                                </button>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {# Items in this group #}
                                {% for item in group_data.items %}
                                <tr class="hover:bg-gray-50 group-item hidden" data-item-id="{{ item.id }}" data-group="{{ group_name }}">
                                    <td class="px-2 py-3 text-sm text-center">
                                        <div class="flex justify-center items-center">
                                            <div class="drag-handle cursor-move text-gray-400 hover:text-gray-600 p-0.5" title="Drag to reorder">
                                                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
                                                </svg>
                                            </div>
                                            <a href="{% url 'estimation_item_move_to_top' item.id %}"
                                               class="text-gray-600 hover:text-blue-600 p-0.5"
                                               title="Move to top">
                                                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7 7 7M5 19l7-7 7 7"/>
                                                </svg>
                                            </a>
                                            <a href="{% url 'estimation_item_move_up' item.id %}"
                                               class="text-gray-600 hover:text-blue-600 p-0.5"
                                               title="Move up">
                                                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                                                </svg>
                                            </a>
                                            <a href="{% url 'estimation_item_move_down' item.id %}"
                                               class="text-gray-600 hover:text-blue-600 p-0.5"
                                               title="Move down">
                                                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                </svg>
                                            </a>
                                            <a href="{% url 'estimation_item_move_to_bottom' item.id %}"
                                               class="text-gray-600 hover:text-blue-600 p-0.5"
                                               title="Move to bottom">
                                                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7-7-7M19 5l-7 7-7-7"/>
                                                </svg>
                                            </a>
                                        </div>
                                    </td>
                                    <td class="px-3 py-3 text-sm text-gray-900">
                                        <div class="font-medium">{{ item.title|default:"(No title)" }}</div>
                                        {% if item.links.exists %}
                                            <div class="flex flex-wrap gap-1 mt-2">
                                                {% for link in item.links.all %}
                                                    <a href="{{ link.get_short_url }}"
                                                       target="_blank"
                                                       rel="noopener noreferrer"
                                                       class="inline-flex items-center px-2 py-1 text-xs font-medium rounded bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-200 transition-colors duration-150"
                                                       title="{{ link.comment|default:link.url }}">
                                                        <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                                                        </svg>
                                                        {{ link.name|truncatewords:3 }}
                                                        <svg class="h-3 w-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                                        </svg>
                                                    </a>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td class="px-2 py-3 text-sm text-center text-gray-900">{{ item.story_points|default:"0"|floatformat:1 }}</td>
                                    <td class="px-2 py-3 text-sm text-center">
                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                                            {% if item.complexity_level == 'LOW' %}bg-green-100 text-green-800
                                            {% elif item.complexity_level == 'MEDIUM' %}bg-yellow-100 text-yellow-800
                                            {% elif item.complexity_level == 'HIGH' %}bg-orange-100 text-orange-800
                                            {% elif item.complexity_level == 'VERY_HIGH' %}bg-red-100 text-red-800
                                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                                            {{ item.get_complexity_level_display|default:"N/A" }}
                                        </span>
                                    </td>
                                    <td class="px-2 py-3 text-sm text-center">
                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                                            {% if item.priority == 'CRITICAL' %}bg-red-100 text-red-800
                                            {% elif item.priority == 'HIGH' %}bg-orange-100 text-orange-800
                                            {% elif item.priority == 'MEDIUM' %}bg-yellow-100 text-yellow-800
                                            {% elif item.priority == 'LOW' %}bg-green-100 text-green-800
                                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                                            {{ item.get_priority_display|default:"N/A" }}
                                        </span>
                                    </td>
                                    <td class="px-2 py-3 text-xs text-center text-gray-600" title="{{ item.get_cone_of_uncertainty_display }}">
                                        {% if item.cone_of_uncertainty == 'INITIAL_CONCEPT' %}4x
                                        {% elif item.cone_of_uncertainty == 'APPROVED_PRODUCT' %}2x
                                        {% elif item.cone_of_uncertainty == 'REQUIREMENTS_COMPLETE' %}1.5x
                                        {% elif item.cone_of_uncertainty == 'DESIGN_COMPLETE' %}1.25x
                                        {% elif item.cone_of_uncertainty == 'IMPLEMENTATION_COMPLETE' %}1.1x
                                        {% else %}N/A{% endif %}
                                    </td>
                                    <td class="px-2 py-3 text-sm text-right text-gray-500" title="Dev: {{ item.hours_junior|default:"0"|floatformat:2 }} | Code Review: {{ item.code_review_hours_junior|default:"0"|floatformat:2 }} | Tests: {{ item.tests_hours_junior|default:"0"|floatformat:2 }} | CoU: {{ item.get_cone_of_uncertainty_display }}">{{ item.get_junior_hours_with_uncertainty|floatformat:2 }}</td>
                                    <td class="px-2 py-3 text-sm text-right text-gray-500" title="Dev: {{ item.hours_mid|default:"0"|floatformat:2 }} | Code Review: {{ item.code_review_hours_mid|default:"0"|floatformat:2 }} | Tests: {{ item.tests_hours_mid|default:"0"|floatformat:2 }} | CoU: {{ item.get_cone_of_uncertainty_display }}">{{ item.get_mid_hours_with_uncertainty|floatformat:2 }}</td>
                                    <td class="px-2 py-3 text-sm text-right text-gray-500" title="Dev: {{ item.hours_senior|default:"0"|floatformat:2 }} | Code Review: {{ item.code_review_hours_senior|default:"0"|floatformat:2 }} | Tests: {{ item.tests_hours_senior|default:"0"|floatformat:2 }} | CoU: {{ item.get_cone_of_uncertainty_display }}">{{ item.get_senior_hours_with_uncertainty|floatformat:2 }}</td>
                                    <td class="px-2 py-3 text-sm text-right text-gray-500" title="Dev: {{ item.hours_lead|default:"0"|floatformat:2 }} | Code Review: {{ item.code_review_hours_lead|default:"0"|floatformat:2 }} | Tests: {{ item.tests_hours_lead|default:"0"|floatformat:2 }} | CoU: {{ item.get_cone_of_uncertainty_display }}">{{ item.get_lead_hours_with_uncertainty|floatformat:2 }}</td>
                                    <td class="px-2 py-3 text-sm text-right text-gray-500">{{ item.get_reviewer_hours|floatformat:2 }}</td>
                                    <td class="px-2 py-3 text-xs text-right whitespace-nowrap">
                                        <a href="{% url 'estimation_item_edit' item.id %}" class="text-blue-600 hover:text-blue-900 inline-block">Edit</a>
                                        <span class="text-gray-300 mx-1">|</span>
                                        <a href="{% url 'estimation_item_duplicate' item.id %}" class="text-green-600 hover:text-green-900 inline-block">Dup</a>
                                        <span class="text-gray-300 mx-1">|</span>
                                        <a href="{% url 'estimation_item_delete' item.id %}"
                                           onclick="return confirm('Delete this item?')"
                                           class="text-red-600 hover:text-red-900 inline-block">Del</a>
                                    </td>
                                </tr>
                                {% endfor %}
                                {# Group Subtotal Row #}
                                <tr class="bg-blue-50 border-t border-blue-200 group-subtotal hidden" data-group="{{ group_name }}">
                                    <td colspan="2" class="px-3 py-2 text-sm font-semibold text-blue-900">
                                        {{ group_name }} Subtotal
                                    </td>
                                    <td class="px-2 py-2 text-sm text-center font-semibold text-blue-900">
                                        {{ group_data.subtotals.story_points|floatformat:1 }}
                                    </td>
                                    <td colspan="3"></td>
                                    <td class="px-2 py-2 text-sm text-right font-semibold text-blue-900">
                                        {{ group_data.subtotals.junior_with_uncertainty|floatformat:2 }}
                                    </td>
                                    <td class="px-2 py-2 text-sm text-right font-semibold text-blue-900">
                                        {{ group_data.subtotals.mid_with_uncertainty|floatformat:2 }}
                                    </td>
                                    <td class="px-2 py-2 text-sm text-right font-semibold text-blue-900">
                                        {{ group_data.subtotals.senior_with_uncertainty|floatformat:2 }}
                                    </td>
                                    <td class="px-2 py-2 text-sm text-right font-semibold text-blue-900">
                                        {{ group_data.subtotals.lead_with_uncertainty|floatformat:2 }}
                                    </td>
                                    <td class="px-2 py-2 text-sm text-right font-semibold text-blue-900">
                                        {{ group_data.subtotals.reviewer_hours|floatformat:2 }}
                                    </td>
                                    <td></td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="px-6 py-12 text-center">
                    <p class="text-gray-500">No estimation items yet. Add your first item above.</p>
                </div>
            {% endif %}
        </div>

        <!-- Combined Project Estimate -->
        {% if model.get_total_team_size > 0 %}
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 shadow-lg rounded-lg mb-6">
                <div class="px-6 py-4 border-b border-blue-200 bg-blue-100">
                    <h2 class="text-2xl font-bold text-blue-900">Combined Project Estimate</h2>
                    <p class="mt-1 text-sm text-blue-700">Realistic timeline for your mixed team working in parallel</p>
                </div>
                <div class="px-6 py-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <dt class="text-sm font-medium text-gray-500 mb-2">Project Duration</dt>
                            <dd class="text-4xl font-bold text-blue-600">
                                {{ model.get_combined_project_duration_weeks|floatformat:1 }} <span class="text-2xl">weeks</span>
                            </dd>
                            <dd class="text-lg text-gray-600 mt-2">
                                ({{ model.get_combined_project_duration_months|floatformat:1 }} months)
                            </dd>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow">
                            <dt class="text-sm font-medium text-gray-500 mb-2">Team Size</dt>
                            <dd class="text-4xl font-bold text-indigo-600">
                                {{ model.get_total_team_size }} <span class="text-2xl">dev{{ model.get_total_team_size|pluralize }}</span>
                            </dd>
                        </div>

                        {% if model.sprint_duration_weeks %}
                            <div class="bg-white p-6 rounded-lg shadow">
                                <dt class="text-sm font-medium text-gray-500 mb-2">Sprint Count</dt>
                                <dd class="text-4xl font-bold text-purple-600">
                                    {{ model.get_sprint_count }} <span class="text-2xl">sprint{{ model.get_sprint_count|pluralize }}</span>
                                </dd>
                                <dd class="text-sm text-gray-600 mt-2">
                                    ({{ model.sprint_duration_weeks }} week{{ model.sprint_duration_weeks|pluralize }} each)
                                </dd>
                            </div>
                        {% endif %}

                        {% if totals.required_team_velocity_per_sprint %}
                            <div class="bg-white p-6 rounded-lg shadow border-l-4 border-green-500">
                                <dt class="text-sm font-medium text-gray-500 mb-2">Required Team Velocity</dt>
                                <dd class="text-4xl font-bold text-green-600">
                                    {{ totals.required_team_velocity_per_sprint|floatformat:1 }} <span class="text-2xl">pts/sprint</span>
                                </dd>
                                <dd class="text-sm text-gray-600 mt-2">
                                    Story points per sprint needed
                                </dd>
                            </div>
                        {% endif %}

                        {% if totals.required_velocity_per_developer_per_sprint %}
                            <div class="bg-white p-6 rounded-lg shadow border-l-4 border-teal-500">
                                <dt class="text-sm font-medium text-gray-500 mb-2">Per Developer Velocity</dt>
                                <dd class="text-4xl font-bold text-teal-600">
                                    {{ totals.required_velocity_per_developer_per_sprint|floatformat:2 }} <span class="text-2xl">pts/sprint</span>
                                </dd>
                                <dd class="text-sm text-gray-600 mt-2">
                                    Per person ({{ model.get_total_team_size }} developer{{ model.get_total_team_size|pluralize }})
                                </dd>
                            </div>
                        {% endif %}

                        {% if totals.required_velocity_per_week %}
                            <div class="bg-white p-6 rounded-lg shadow border-l-4 border-indigo-500">
                                <dt class="text-sm font-medium text-gray-500 mb-2">Weekly Velocity</dt>
                                <dd class="text-4xl font-bold text-indigo-600">
                                    {{ totals.required_velocity_per_week|floatformat:1 }} <span class="text-2xl">pts/week</span>
                                </dd>
                                <dd class="text-sm text-gray-600 mt-2">
                                    Alternative weekly view
                                </dd>
                            </div>
                        {% endif %}

                        {% if model.get_bottleneck_level %}
                            <div class="bg-white p-6 rounded-lg shadow">
                                <dt class="text-sm font-medium text-gray-500 mb-2">Bottleneck Level</dt>
                                <dd class="text-3xl font-bold text-amber-600">
                                    {{ model.get_bottleneck_level.0 }}
                                </dd>
                                <dd class="text-sm text-gray-600 mt-2">
                                    Takes {{ model.get_bottleneck_level.1|floatformat:1 }} weeks
                                </dd>
                                <dd class="text-xs text-gray-500 mt-1">
                                    This level determines project duration
                                </dd>
                            </div>
                        {% endif %}
                    </div>

                    <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <p class="text-sm text-gray-700">
                            <strong class="text-blue-900">How this works:</strong> Each developer level works on their assigned tasks in parallel.
                            The project completes when the slowest level finishes (the bottleneck). This estimate assumes each level has dedicated work
                            and developers work simultaneously at 40 hours per week.
                        </p>
                        {% if totals.required_team_velocity_per_sprint %}
                        <p class="text-sm text-gray-700 mt-3">
                            <strong class="text-green-900">Required Velocity:</strong> To complete this estimation on schedule, your team needs to maintain
                            a velocity of <strong>{{ totals.required_team_velocity_per_sprint|floatformat:1 }} story points per sprint</strong>.
                            Compare this to your team's historical velocity to assess if the timeline is realistic.
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Best Case Scenario -->
        {% if model.get_total_team_size > 0 %}
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 shadow-lg rounded-lg mb-6">
                <div class="px-6 py-4 border-b border-green-200 bg-green-100">
                    <h2 class="text-2xl font-bold text-green-900">Best Case Scenario</h2>
                    <p class="mt-1 text-sm text-green-700">Optimistic timeline assuming all tasks at Implementation Complete phase (1.1x uncertainty)</p>
                </div>
                <div class="px-6 py-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <dt class="text-sm font-medium text-gray-500 mb-2">Project Duration</dt>
                            <dd class="text-4xl font-bold text-green-600">
                                {{ model.get_combined_project_duration_weeks_best_case|floatformat:1 }} <span class="text-2xl">weeks</span>
                            </dd>
                            <dd class="text-lg text-gray-600 mt-2">
                                ({{ model.get_combined_project_duration_months_best_case|floatformat:1 }} months)
                            </dd>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow">
                            <dt class="text-sm font-medium text-gray-500 mb-2">Team Size</dt>
                            <dd class="text-4xl font-bold text-emerald-600">
                                {{ model.get_total_team_size }} <span class="text-2xl">dev{{ model.get_total_team_size|pluralize }}</span>
                            </dd>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow">
                            <dt class="text-sm font-medium text-gray-500 mb-2">Uncertainty Multiplier</dt>
                            <dd class="text-4xl font-bold text-green-600">
                                1.1x
                            </dd>
                            <dd class="text-sm text-gray-600 mt-2">
                                Implementation Complete
                            </dd>
                        </div>
                    </div>

                    <div class="mt-6 p-4 bg-green-50 rounded-lg border border-green-200">
                        <p class="text-sm text-gray-700">
                            <strong class="text-green-900">Best Case:</strong> This timeline assumes all estimation items are at the "Implementation Complete" stage
                            with minimal uncertainty (1.1x multiplier). This represents the most optimistic scenario where requirements, design, and implementation
                            details are fully known.
                        </p>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Worst Case Scenario -->
        {% if model.get_total_team_size > 0 %}
            <div class="bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-200 shadow-lg rounded-lg mb-6">
                <div class="px-6 py-4 border-b border-red-200 bg-red-100">
                    <h2 class="text-2xl font-bold text-red-900">Worst Case Scenario</h2>
                    <p class="mt-1 text-sm text-red-700">Conservative timeline assuming all tasks at Initial Concept phase (4.0x uncertainty)</p>
                </div>
                <div class="px-6 py-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <dt class="text-sm font-medium text-gray-500 mb-2">Project Duration</dt>
                            <dd class="text-4xl font-bold text-red-600">
                                {{ model.get_combined_project_duration_weeks_worst_case|floatformat:1 }} <span class="text-2xl">weeks</span>
                            </dd>
                            <dd class="text-lg text-gray-600 mt-2">
                                ({{ model.get_combined_project_duration_months_worst_case|floatformat:1 }} months)
                            </dd>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow">
                            <dt class="text-sm font-medium text-gray-500 mb-2">Team Size</dt>
                            <dd class="text-4xl font-bold text-orange-600">
                                {{ model.get_total_team_size }} <span class="text-2xl">dev{{ model.get_total_team_size|pluralize }}</span>
                            </dd>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow">
                            <dt class="text-sm font-medium text-gray-500 mb-2">Uncertainty Multiplier</dt>
                            <dd class="text-4xl font-bold text-red-600">
                                4.0x
                            </dd>
                            <dd class="text-sm text-gray-600 mt-2">
                                Initial Concept
                            </dd>
                        </div>
                    </div>

                    <div class="mt-6 p-4 bg-red-50 rounded-lg border border-red-200">
                        <p class="text-sm text-gray-700">
                            <strong class="text-red-900">Worst Case:</strong> This timeline assumes all estimation items are at the "Initial Concept" stage
                            with maximum uncertainty (4.0x multiplier). This represents the most conservative scenario where requirements are unclear and significant
                            changes are expected during the project.
                        </p>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Totals Summary -->
        <div class="bg-white shadow-sm rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">Estimation Summary</h2>
                <p class="mt-1 text-sm text-gray-500">Hours shown include cone of uncertainty multipliers based on project phase. Each level represents alternative estimates, not additive totals. Contingency is applied to base hours only.</p>
            </div>
            <div class="px-6 py-4">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <p class="col-span-full text-xs text-gray-600 mb-2">Note: Code review time is included in each developer's hours and performed by the same developers, not a separate reviewer position.</p>
                    <!-- Junior Developer -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">Junior Developer</h3>
                        <dl class="space-y-2">
                            <div>
                                <dt class="text-xs text-gray-500">Base Hours</dt>
                                <dd class="text-lg font-semibold text-gray-900">{{ totals.base_junior|floatformat:2 }}</dd>
                            </div>
                            <div>
                                <dt class="text-xs text-gray-500">With Uncertainty</dt>
                                <dd class="text-lg font-semibold text-gray-900">{{ totals.junior_with_uncertainty|floatformat:2 }}</dd>
                            </div>
                            <div>
                                <dt class="text-xs text-gray-500">Contingency ({{ model.contingency_padding_percent|default:"0"|floatformat:2 }}%)</dt>
                                <dd class="text-lg font-semibold text-blue-600">{{ totals.contingency_junior|floatformat:2 }}</dd>
                            </div>
                            <div class="border-t border-gray-300 pt-2">
                                <dt class="text-xs text-gray-700 font-medium">Grand Total</dt>
                                <dd class="text-xl font-bold text-blue-700">{{ totals.grand_total_junior|floatformat:2 }}</dd>
                            </div>
                            {% if model.junior_developer_count %}
                                <div class="border-t border-gray-300 pt-2 mt-2 bg-green-50 -mx-4 px-4 py-2 rounded">
                                    <dt class="text-xs text-green-700 font-medium">Duration Estimate</dt>
                                    <dd class="text-sm text-green-900 mt-1">
                                        {{ model.get_duration_weeks_junior|floatformat:1 }} weeks
                                        <span class="text-xs text-gray-600">({{ model.get_duration_months_junior|floatformat:1 }} months)</span>
                                    </dd>
                                    <dd class="text-xs text-gray-600 mt-1">{{ model.junior_developer_count }} dev{{ model.junior_developer_count|pluralize }} @ 40 hrs/week</dd>
                                </div>
                            {% endif %}
                        </dl>
                    </div>

                    <!-- Mid-Level Developer -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">Mid-Level Developer</h3>
                        <dl class="space-y-2">
                            <div>
                                <dt class="text-xs text-gray-500">Base Hours</dt>
                                <dd class="text-lg font-semibold text-gray-900">{{ totals.base_mid|floatformat:2 }}</dd>
                            </div>
                            <div>
                                <dt class="text-xs text-gray-500">With Uncertainty</dt>
                                <dd class="text-lg font-semibold text-gray-900">{{ totals.mid_with_uncertainty|floatformat:2 }}</dd>
                            </div>
                            <div>
                                <dt class="text-xs text-gray-500">Contingency ({{ model.contingency_padding_percent|default:"0"|floatformat:2 }}%)</dt>
                                <dd class="text-lg font-semibold text-blue-600">{{ totals.contingency_mid|floatformat:2 }}</dd>
                            </div>
                            <div class="border-t border-gray-300 pt-2">
                                <dt class="text-xs text-gray-700 font-medium">Grand Total</dt>
                                <dd class="text-xl font-bold text-blue-700">{{ totals.grand_total_mid|floatformat:2 }}</dd>
                            </div>
                            {% if model.mid_developer_count %}
                                <div class="border-t border-gray-300 pt-2 mt-2 bg-green-50 -mx-4 px-4 py-2 rounded">
                                    <dt class="text-xs text-green-700 font-medium">Duration Estimate</dt>
                                    <dd class="text-sm text-green-900 mt-1">
                                        {{ model.get_duration_weeks_mid|floatformat:1 }} weeks
                                        <span class="text-xs text-gray-600">({{ model.get_duration_months_mid|floatformat:1 }} months)</span>
                                    </dd>
                                    <dd class="text-xs text-gray-600 mt-1">{{ model.mid_developer_count }} dev{{ model.mid_developer_count|pluralize }} @ 40 hrs/week</dd>
                                </div>
                            {% endif %}
                        </dl>
                    </div>

                    <!-- Senior Developer -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">Senior Developer</h3>
                        <dl class="space-y-2">
                            <div>
                                <dt class="text-xs text-gray-500">Base Hours</dt>
                                <dd class="text-lg font-semibold text-gray-900">{{ totals.base_senior|floatformat:2 }}</dd>
                            </div>
                            <div>
                                <dt class="text-xs text-gray-500">With Uncertainty</dt>
                                <dd class="text-lg font-semibold text-gray-900">{{ totals.senior_with_uncertainty|floatformat:2 }}</dd>
                            </div>
                            <div>
                                <dt class="text-xs text-gray-500">Contingency ({{ model.contingency_padding_percent|default:"0"|floatformat:2 }}%)</dt>
                                <dd class="text-lg font-semibold text-blue-600">{{ totals.contingency_senior|floatformat:2 }}</dd>
                            </div>
                            <div class="border-t border-gray-300 pt-2">
                                <dt class="text-xs text-gray-700 font-medium">Grand Total</dt>
                                <dd class="text-xl font-bold text-blue-700">{{ totals.grand_total_senior|floatformat:2 }}</dd>
                            </div>
                            {% if model.senior_developer_count %}
                                <div class="border-t border-gray-300 pt-2 mt-2 bg-green-50 -mx-4 px-4 py-2 rounded">
                                    <dt class="text-xs text-green-700 font-medium">Duration Estimate</dt>
                                    <dd class="text-sm text-green-900 mt-1">
                                        {{ model.get_duration_weeks_senior|floatformat:1 }} weeks
                                        <span class="text-xs text-gray-600">({{ model.get_duration_months_senior|floatformat:1 }} months)</span>
                                    </dd>
                                    <dd class="text-xs text-gray-600 mt-1">{{ model.senior_developer_count }} dev{{ model.senior_developer_count|pluralize }} @ 40 hrs/week</dd>
                                </div>
                            {% endif %}
                        </dl>
                    </div>

                    <!-- Lead Developer -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">Lead Developer</h3>
                        <dl class="space-y-2">
                            <div>
                                <dt class="text-xs text-gray-500">Base Hours</dt>
                                <dd class="text-lg font-semibold text-gray-900">{{ totals.base_lead|floatformat:2 }}</dd>
                            </div>
                            <div>
                                <dt class="text-xs text-gray-500">With Uncertainty</dt>
                                <dd class="text-lg font-semibold text-gray-900">{{ totals.lead_with_uncertainty|floatformat:2 }}</dd>
                            </div>
                            <div>
                                <dt class="text-xs text-gray-500">Contingency ({{ model.contingency_padding_percent|default:"0"|floatformat:2 }}%)</dt>
                                <dd class="text-lg font-semibold text-blue-600">{{ totals.contingency_lead|floatformat:2 }}</dd>
                            </div>
                            <div class="border-t border-gray-300 pt-2">
                                <dt class="text-xs text-gray-700 font-medium">Grand Total</dt>
                                <dd class="text-xl font-bold text-blue-700">{{ totals.grand_total_lead|floatformat:2 }}</dd>
                            </div>
                            {% if model.lead_developer_count %}
                                <div class="border-t border-gray-300 pt-2 mt-2 bg-green-50 -mx-4 px-4 py-2 rounded">
                                    <dt class="text-xs text-green-700 font-medium">Duration Estimate</dt>
                                    <dd class="text-sm text-green-900 mt-1">
                                        {{ model.get_duration_weeks_lead|floatformat:1 }} weeks
                                        <span class="text-xs text-gray-600">({{ model.get_duration_months_lead|floatformat:1 }} months)</span>
                                    </dd>
                                    <dd class="text-xs text-gray-600 mt-1">{{ model.lead_developer_count }} dev{{ model.lead_developer_count|pluralize }} @ 40 hrs/week</dd>
                                </div>
                            {% endif %}
                        </dl>
                    </div>
                </div>

                <!-- Optional Average View -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Average Estimate (Optional Aggregate View)</h3>
                        <p class="text-xs text-gray-600 mb-3">This is an average across all developer levels with uncertainty applied. Use with caution as levels are alternatives, not additive.</p>
                        <dd class="text-2xl font-bold text-gray-900">{{ totals.average_with_uncertainty|floatformat:2 }} hours</dd>
                    </div>
                </div>

                <!-- Total Story Points -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Total Story Points</h3>
                        <p class="text-xs text-gray-600 mb-3">Sum of all story points across estimation items. Story points represent relative complexity/effort (1 point ≈ 4 hours of ideal work time).</p>
                        <dd class="text-2xl font-bold text-blue-900">{{ totals.total_story_points|floatformat:1 }} points</dd>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comments Section -->
        {% if model.comment %}
            <div class="bg-white shadow-sm rounded-lg mt-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900">Comments</h2>
                </div>
                <div class="px-6 py-4">
                    <div id="comments-content" class="prose prose-sm max-w-none">
                        <!-- Markdown will be rendered here -->
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Marked.js for markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

<!-- SortableJS for drag-and-drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
// Toggle group visibility
function toggleGroup(groupName) {
    const groupItems = document.querySelectorAll(`tr.group-item[data-group="${groupName}"], tr.group-subtotal[data-group="${groupName}"]`);
    const groupHeader = document.querySelector(`tr.group-header[data-group-name="${groupName}"]`);
    const chevron = groupHeader.querySelector('.group-chevron');

    groupItems.forEach(item => {
        item.classList.toggle('hidden');
    });

    // Rotate chevron
    if (chevron.style.transform === 'rotate(-90deg)') {
        chevron.style.transform = '';
    } else {
        chevron.style.transform = 'rotate(-90deg)';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize all groups as collapsed
    const groupHeaders = document.querySelectorAll('.group-header');
    groupHeaders.forEach(header => {
        const chevron = header.querySelector('.group-chevron');
        if (chevron) {
            chevron.style.transform = 'rotate(-90deg)';
        }
    });

    // Render markdown comments
    const commentsContent = document.getElementById('comments-content');
    if (commentsContent) {
        const markdownText = "{{ model.comment|escapejs }}";
        if (markdownText && markdownText.trim() !== '') {
            try {
                commentsContent.innerHTML = marked.parse(markdownText);
            } catch (e) {
                commentsContent.innerHTML = '<p class="text-red-500">Error rendering markdown</p>';
            }
        }
    }

    // Scroll position persistence
    const SCROLL_STORAGE_KEY = 'estimation_detail_scroll_{{ model.id }}';

    // Restore scroll position on page load
    const savedScroll = localStorage.getItem(SCROLL_STORAGE_KEY);
    if (savedScroll) {
        window.scrollTo(0, parseInt(savedScroll));
    }

    // Save scroll position before leaving the page
    window.addEventListener('beforeunload', function() {
        localStorage.setItem(SCROLL_STORAGE_KEY, window.scrollY);
    });

    // Also save on visibility change (tab switching, etc.)
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') {
            localStorage.setItem(SCROLL_STORAGE_KEY, window.scrollY);
        }
    });

    // Drag and drop functionality with group support
    const tableBody = document.querySelector('#estimation-items-tbody');
    if (tableBody) {
        const sortable = new Sortable(tableBody, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'bg-blue-100',
            dragClass: 'opacity-50',
            filter: '.bg-gray-100, .bg-blue-50', // Exclude group headers and subtotal rows
            onEnd: function(evt) {
                // Get the dragged item's row
                const draggedRow = evt.item;
                const itemId = parseInt(draggedRow.dataset.itemId);

                if (isNaN(itemId)) {
                    console.log('Skipping non-item row');
                    return;
                }

                // Find which group this item is now in by looking for the previous group header row
                let currentRow = draggedRow.previousElementSibling;
                let newGroup = null;

                // Walk backwards to find the group header
                while (currentRow) {
                    if (currentRow.dataset.groupName) {
                        newGroup = currentRow.dataset.groupName;
                        break;
                    }
                    currentRow = currentRow.previousElementSibling;
                }

                // Get the new order of item IDs (excluding headers and subtotals)
                const rows = tableBody.querySelectorAll('tr[data-item-id]');
                const itemIds = Array.from(rows).map(row => parseInt(row.dataset.itemId)).filter(id => !isNaN(id));

                // Send AJAX request to update order and group
                console.log('Sending reorder request:', { item_id: itemId, new_group: newGroup, item_ids: itemIds });
                fetch('{% url "estimation_item_reorder" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        item_id: itemId,
                        new_group: newGroup === 'Ungrouped' ? null : newGroup,
                        item_ids: itemIds
                    })
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);
                    if (!data.success) {
                        console.error('Failed to reorder items:', data.error);
                        alert('Failed to save new order: ' + (data.error || 'Unknown error'));
                        // Reload page to restore original state
                        location.reload();
                    } else {
                        console.log('Successfully reordered items');
                        // Reload page to update group subtotals
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error reordering items:', error);
                    alert('Failed to save new order: ' + error.message);
                    // Reload page to restore original state
                    location.reload();
                });
            }
        });
    }

    // Helper function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Double-click handler to navigate to item detail page
    const itemRows = document.querySelectorAll('tr[data-item-id]');
    itemRows.forEach(row => {
        row.style.cursor = 'pointer';
        row.addEventListener('dblclick', function() {
            const itemId = this.dataset.itemId;
            if (itemId) {
                window.location.href = `{% url 'estimation_item_detail' 0 %}`.replace('0', itemId);
            }
        });
    });
});

// Group rename function
function renameGroup(oldGroupName, estimationId) {
    const newGroupName = prompt(`Rename group "${oldGroupName}" to:`, oldGroupName);

    if (!newGroupName) {
        return; // User cancelled
    }

    if (newGroupName === oldGroupName) {
        alert('New group name must be different from the current name.');
        return;
    }

    // Show loading state
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<svg class="animate-spin h-3 w-3 mr-1 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Renaming...';

    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Submit rename request
    const formData = new FormData();
    formData.append('old_group_name', oldGroupName);
    formData.append('new_group_name', newGroupName);

    fetch(`{% url 'estimation_group_rename' 0 %}`.replace('0', estimationId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to show the updated group name
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to rename group'));
            button.disabled = false;
            button.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while renaming the group. Please try again.');
        button.disabled = false;
        button.innerHTML = originalText;
    });
}
</script>
{% endblock %}
