{% extends 'authenticated/base_authenticated.html' %}
{% block content %}
<div class="min-h-screen bg-gray-50 py-6">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-white shadow-md rounded-lg">
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-900">
                    {% if model %}Edit{% else %}New{% endif %} Estimation
                </h2>
                <p class="mt-1 text-sm text-gray-500">{% if model %}Update estimation details{% else %}Create a new project/task estimation{% endif %}</p>
            </div>
            <form method="post" class="px-6 py-6">
                {% csrf_token %}
                <div class="space-y-6">
                    <div>
                        <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Name {% if form.name.field.required %}<span class="text-red-500">*</span>{% endif %}
                        </label>
                        {{ form.name }}
                        {% if form.name.errors %}<p class="mt-2 text-sm text-red-600">{{ form.name.errors.0 }}</p>{% endif %}
                    </div>

                    <div>
                        <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Description
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}<p class="mt-2 text-sm text-red-600">{{ form.description.errors.0 }}</p>{% endif %}
                    </div>

                    <div>
                        <label for="{{ form.application.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Application
                        </label>
                        {{ form.application }}
                        <p class="mt-1 text-xs text-gray-500">Link this estimation to an application</p>
                        {% if form.application.errors %}<p class="mt-2 text-sm text-red-600">{{ form.application.errors.0 }}</p>{% endif %}
                    </div>

                    <div>
                        <label for="{{ form.project.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Project
                        </label>
                        {{ form.project }}
                        <p class="mt-1 text-xs text-gray-500">Link this estimation to a project</p>
                        {% if form.project.errors %}<p class="mt-2 text-sm text-red-600">{{ form.project.errors.0 }}</p>{% endif %}
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label for="{{ form.links.id_for_label }}" class="block text-sm font-medium text-gray-700">
                                Related Links {% if form.links.field.required %}<span class="text-red-500">*</span>{% endif %}
                            </label>
                            <button type="button" id="add_new_link_button"
                                    class="inline-flex items-center px-3 py-1 border border-green-300 shadow-sm text-xs font-medium rounded text-green-700 bg-white hover:bg-green-50">
                                <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Add New Link
                            </button>
                        </div>

                        <!-- Selected Links Display (Cards) -->
                        <div id="selected-links-display" class="mb-3">
                            <!-- Cards will be dynamically inserted here -->
                        </div>

                        <!-- Hidden Select2 Field for Backend -->
                        <div class="hidden">
                            {{ form.links }}
                        </div>

                        <!-- Search/Add Links Dropdown -->
                        <div class="relative">
                            <button type="button" id="search_links_button"
                                    class="w-full flex items-center justify-between px-3 py-2 border border-gray-300 rounded-md text-sm text-gray-700 bg-white hover:bg-gray-50">
                                <span class="flex items-center">
                                    <svg class="h-4 w-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                    </svg>
                                    Search and add existing links...
                                </span>
                                <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                            <div id="links_dropdown" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg">
                                <!-- Search input -->
                                <div class="p-2 border-b border-gray-200">
                                    <div class="relative">
                                        <input type="text" id="link_search_input"
                                               placeholder="Type to search links..."
                                               class="w-full pl-8 pr-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <svg class="absolute left-2 top-2.5 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                        </svg>
                                    </div>
                                </div>
                                <!-- Links list -->
                                <div id="links_list" class="max-h-60 overflow-y-auto">
                                    <!-- Dropdown content will be dynamically populated -->
                                </div>
                            </div>
                        </div>

                        <p class="mt-1 text-xs text-gray-500">Click cards to remove links. Use the search button or "Add New Link" button to add links.</p>
                        {% if form.links.errors %}<p class="mt-2 text-sm text-red-600">{{ form.links.errors.0 }}</p>{% endif %}
                    </div>

                    <div>
                        <label for="{{ form.contingency_padding_percent.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Contingency Padding (%)
                        </label>
                        {{ form.contingency_padding_percent }}
                        <p class="mt-1 text-xs text-gray-500">Percentage to add to total hours for contingency (e.g., 20 for 20%)</p>
                        {% if form.contingency_padding_percent.errors %}<p class="mt-2 text-sm text-red-600">{{ form.contingency_padding_percent.errors.0 }}</p>{% endif %}
                    </div>

                    <div>
                        <label for="{{ form.story_points_modifier.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Story Points Modifier
                        </label>
                        {{ form.story_points_modifier }}
                        <p class="mt-1 text-xs text-gray-500">Multiplier for auto-calculated story points to calibrate to your team's velocity (default: 1.0, >1.0 increases points, &lt;1.0 decreases points)</p>
                        {% if form.story_points_modifier.errors %}<p class="mt-2 text-sm text-red-600">{{ form.story_points_modifier.errors.0 }}</p>{% endif %}
                    </div>

                    <div>
                        <label for="{{ form.sprint_duration_weeks.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Sprint Duration (Weeks)
                        </label>
                        {{ form.sprint_duration_weeks }}
                        <p class="mt-1 text-xs text-gray-500">Number of weeks per sprint for calculating sprint count (defaults to 3 weeks)</p>
                        {% if form.sprint_duration_weeks.errors %}<p class="mt-2 text-sm text-red-600">{{ form.sprint_duration_weeks.errors.0 }}</p>{% endif %}
                    </div>

                    <!-- Team Composition Section -->
                    <div class="border-t border-gray-200 pt-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Team Composition</h3>
                        <p class="text-sm text-gray-600 mb-4">Specify the number of developers at each level to calculate project duration estimates based on a 40-hour work week. Code review time is already included in each developer's hours.</p>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label for="{{ form.junior_developer_count.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Junior Devs
                                </label>
                                {{ form.junior_developer_count }}
                                {% if form.junior_developer_count.errors %}<p class="mt-2 text-sm text-red-600">{{ form.junior_developer_count.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.mid_developer_count.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Mid Devs
                                </label>
                                {{ form.mid_developer_count }}
                                {% if form.mid_developer_count.errors %}<p class="mt-2 text-sm text-red-600">{{ form.mid_developer_count.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.senior_developer_count.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Senior Devs
                                </label>
                                {{ form.senior_developer_count }}
                                {% if form.senior_developer_count.errors %}<p class="mt-2 text-sm text-red-600">{{ form.senior_developer_count.errors.0 }}</p>{% endif %}
                            </div>

                            <div>
                                <label for="{{ form.lead_developer_count.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Lead Devs
                                </label>
                                {{ form.lead_developer_count }}
                                {% if form.lead_developer_count.errors %}<p class="mt-2 text-sm text-red-600">{{ form.lead_developer_count.errors.0 }}</p>{% endif %}
                            </div>
                        </div>
                    </div>

                    <div>
                        <label for="{{ form.comment.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Comment
                        </label>
                        {{ form.comment }}
                        <p class="mt-1 text-xs text-gray-500">Additional notes or comments</p>
                        {% if form.comment.errors %}<p class="mt-2 text-sm text-red-600">{{ form.comment.errors.0 }}</p>{% endif %}
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <a href="{% if model %}{% url 'estimation_detail' model.id %}{% else %}{% url 'estimation' %}{% endif %}"
                       class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Cancel
                    </a>
                    <button type="submit"
                            class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    /* Style Django form fields with Tailwind */
    input[type="text"],
    input[type="email"],
    input[type="number"],
    input[type="url"],
    input[type="date"],
    input[type="datetime-local"],
    input[type="password"],
    textarea,
    select {
        display: block;
        width: 100%;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        line-height: 1.5;
        color: #1f2937;
        background-color: #ffffff;
        background-clip: padding-box;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="number"]:focus,
    input[type="url"]:focus,
    input[type="date"]:focus,
    input[type="datetime-local"]:focus,
    input[type="password"]:focus,
    textarea:focus,
    select:focus {
        color: #1f2937;
        background-color: #ffffff;
        border-color: #3b82f6;
        outline: 0;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    input[type="text"]:disabled,
    input[type="email"]:disabled,
    input[type="number"]:disabled,
    input[type="url"]:disabled,
    input[type="date"]:disabled,
    input[type="datetime-local"]:disabled,
    input[type="password"]:disabled,
    textarea:disabled,
    select:disabled {
        background-color: #f3f4f6;
        opacity: 1;
    }

    textarea {
        min-height: 100px;
        resize: vertical;
    }

    input[type="checkbox"] {
        width: 1rem;
        height: 1rem;
        color: #3b82f6;
        background-color: #ffffff;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        cursor: pointer;
    }

    input[type="checkbox"]:focus {
        border-color: #3b82f6;
        outline: 0;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    input[type="checkbox"]:checked {
        background-color: #3b82f6;
        border-color: #3b82f6;
    }

    /* Placeholder styling */
    input::placeholder,
    textarea::placeholder {
        color: #9ca3af;
        opacity: 1;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Links Management System
    let allLinks = []; // Will store all available links
    let selectedLinkIds = new Set(); // Track selected link IDs

    // Initialize links system
    function initializeLinksSystem() {
        // Get initially selected links from the form
        const selectElement = document.getElementById('id_links');
        if (selectElement) {
            Array.from(selectElement.selectedOptions).forEach(option => {
                selectedLinkIds.add(option.value);
                allLinks.push({
                    id: option.value,
                    name: option.text,
                    url: option.getAttribute('data-url') || '#'
                });
            });
        }

        // Fetch all available links from the select options
        Array.from(selectElement.options).forEach(option => {
            if (!allLinks.find(l => l.id === option.value)) {
                allLinks.push({
                    id: option.value,
                    name: option.text,
                    url: option.getAttribute('data-url') || '#'
                });
            }
        });

        renderSelectedLinks();
        renderDropdown();
    }

    // Render selected links as cards
    function renderSelectedLinks() {
        const container = document.getElementById('selected-links-display');
        if (!container) return;

        if (selectedLinkIds.size === 0) {
            container.innerHTML = '<p class="text-sm text-gray-500 italic py-2">No links selected. Use the search button or "Add New Link" to add links.</p>';
            return;
        }

        const selectedLinks = allLinks.filter(link => selectedLinkIds.has(link.id));
        container.innerHTML = selectedLinks.map(link => `
            <div class="inline-flex items-center gap-2 px-3 py-2 mr-2 mb-2 text-sm font-medium rounded-lg bg-blue-50 text-blue-700 border border-blue-200 hover:bg-blue-100 transition-colors duration-150 group">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                </svg>
                <span class="font-medium">${link.name}</span>
                <button type="button" onclick="removeLink('${link.id}')"
                        class="ml-1 p-0.5 rounded hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        title="Remove link">
                    <svg class="h-4 w-4 text-blue-600 hover:text-blue-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        `).join('');

        // Update hidden select field
        syncHiddenSelect();
    }

    // Remove a link
    window.removeLink = function(linkId) {
        selectedLinkIds.delete(linkId);
        renderSelectedLinks();
        renderDropdown();
    };

    // Add a link
    window.addLink = function(linkId) {
        selectedLinkIds.add(linkId);
        renderSelectedLinks();
        renderDropdown();
        closeDropdown();
    };

    // Sync hidden select field
    function syncHiddenSelect() {
        const selectElement = document.getElementById('id_links');
        if (!selectElement) return;

        // Clear all selections
        Array.from(selectElement.options).forEach(option => {
            option.selected = false;
        });

        // Select the chosen ones
        selectedLinkIds.forEach(id => {
            const option = selectElement.querySelector(`option[value="${id}"]`);
            if (option) {
                option.selected = true;
            }
        });
    }

    // Render dropdown
    function renderDropdown(searchQuery = '') {
        const linksList = document.getElementById('links_list');
        if (!linksList) return;

        // Filter out already selected links
        let availableLinks = allLinks.filter(link => !selectedLinkIds.has(link.id));

        // Apply search filter
        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            availableLinks = availableLinks.filter(link =>
                link.name.toLowerCase().includes(query)
            );
        }

        if (availableLinks.length === 0) {
            linksList.innerHTML = '<p class="px-4 py-3 text-sm text-gray-500 italic">No links found.</p>';
            return;
        }

        linksList.innerHTML = availableLinks.map(link => `
            <button type="button"
                    onclick="addLink('${link.id}')"
                    class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 focus:bg-gray-100 focus:outline-none border-b border-gray-100 last:border-b-0">
                <div class="flex items-center">
                    <svg class="h-4 w-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                    </svg>
                    <span>${link.name}</span>
                </div>
            </button>
        `).join('');
    }

    // Toggle dropdown
    const searchButton = document.getElementById('search_links_button');
    const dropdown = document.getElementById('links_dropdown');
    const searchInput = document.getElementById('link_search_input');

    searchButton?.addEventListener('click', function(e) {
        e.stopPropagation();
        const isHidden = dropdown.classList.contains('hidden');
        dropdown.classList.toggle('hidden');

        if (isHidden) {
            // Opening dropdown
            setTimeout(() => {
                searchInput?.focus();
            }, 100);
        } else {
            // Closing dropdown
            closeDropdown();
        }
    });

    // Search input filtering
    searchInput?.addEventListener('input', function(e) {
        renderDropdown(e.target.value);
    });

    // Prevent dropdown from closing when clicking inside it
    dropdown?.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchButton?.contains(e.target) && !dropdown?.contains(e.target)) {
            closeDropdown();
        }
    });

    function closeDropdown() {
        dropdown?.classList.add('hidden');
        if (searchInput) {
            searchInput.value = '';
        }
        renderDropdown(); // Reset to show all available links
    }

    // Handle "Add New Link" button
    document.getElementById('add_new_link_button')?.addEventListener('click', function() {
        window.openLinkModal(function(newLink) {
            // Add the new link to our data
            allLinks.push({
                id: newLink.id.toString(),
                name: newLink.name,
                url: newLink.url
            });

            // Add to hidden select
            const selectElement = document.getElementById('id_links');
            const newOption = new Option(newLink.name, newLink.id, true, true);
            newOption.setAttribute('data-url', newLink.url);
            selectElement.appendChild(newOption);

            // Add to selected
            selectedLinkIds.add(newLink.id.toString());
            renderSelectedLinks();
            renderDropdown();
        });
    });

    // Initialize on page load
    initializeLinksSystem();
});
</script>

<!-- Include reusable link modal component -->
{% include 'authenticated/common/components/link_modal.html' %}

{% endblock %}
