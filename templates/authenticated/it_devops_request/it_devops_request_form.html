{% extends 'authenticated/base_authenticated.html' %}
{% load static %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    /* Select2 styling for person dropdowns */
    .select2-container--default .select2-selection--single {
        height: 42px;
        padding: 6px 12px;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 28px;
        padding-left: 0;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 40px;
    }
    .select2-dropdown {
        border-color: #d1d5db;
        border-radius: 0.375rem;
    }
    .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: #3b82f6;
    }
    .select2-container--default .select2-search--dropdown .select2-search__field {
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 6px 12px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Markdown Parser -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% include 'authenticated/common/components/link_modal.html' %}
{% include 'authenticated/common/components/document_modal.html' %}
    <!-- Header Section -->
    <div class="bg-white shadow-sm border-b border-gray-200 mb-6">
        <div class="mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center">
                <a href="{% url 'it_devops_request' %}" class="mr-4 text-gray-400 hover:text-gray-600 transition-colors duration-150">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </a>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">{% if form.instance.pk %}Edit{% else %}Create{% endif %} IT/DevOps Request</h1>
                    <p class="mt-1 text-sm text-gray-500">{% if form.instance.pk %}Update request details{% else %}Submit a new IT/DevOps request{% endif %}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Section -->
    <div class="mx-auto px-4 sm:px-6 lg:px-8 pb-12">
        <form method="POST" class="w-full">
            {% csrf_token %}

            <div class="space-y-6 w-full">
                <!-- Document ID -->
                {% if form.instance.pk and form.instance.document_id %}
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-blue-700">
                                <strong>Document ID:</strong> <span class="font-mono font-bold">{{ form.instance.document_id }}</span>
                            </p>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded-r-lg">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-green-700">
                                A unique document ID will be automatically generated when you save this request
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Ask AI Helper -->
                <div class="bg-purple-50 border border-purple-200 rounded-lg overflow-hidden w-full">
                    <button type="button" id="ask-ai-toggle" class="w-full px-6 py-4 flex items-center justify-between text-left hover:bg-purple-100 transition-colors duration-150">
                        <div class="flex items-center">
                            <svg class="h-5 w-5 text-purple-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                            <div>
                                <h3 class="text-sm font-semibold text-purple-900">Need help writing this request?</h3>
                                <p class="text-xs text-purple-600">Copy a prompt to use with AI assistants</p>
                            </div>
                        </div>
                        <svg id="ask-ai-chevron" class="h-5 w-5 text-purple-500 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div id="ask-ai-content" class="hidden px-6 pb-6">
                        <div class="bg-white rounded-lg border border-purple-200 p-4">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Prompt to copy</span>
                                <button type="button" id="copy-ai-prompt" class="inline-flex items-center px-3 py-1 text-xs font-medium rounded-md text-purple-700 bg-purple-100 hover:bg-purple-200 transition-colors duration-150">
                                    <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                    </svg>
                                    <span id="copy-btn-text">Copy</span>
                                </button>
                            </div>
                            <textarea id="ai-prompt-text" readonly rows="8" class="w-full px-3 py-2 text-sm text-gray-700 bg-gray-50 border border-gray-200 rounded-md font-mono resize-none focus:outline-none focus:ring-2 focus:ring-purple-500">I need to make a request to my IT department for [describe what you need here].

Give me a title, description, justification, expected outcome, additional notes, and supporting/related links (each having a URL, title, and description of the link).

Format the response so I can easily copy each section into a form.</textarea>
                            <p class="mt-2 text-xs text-gray-500">
                                Replace <code class="bg-gray-100 px-1 rounded">[describe what you need here]</code> with your specific request, then paste into ChatGPT, Claude, or another AI assistant.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Basic Information -->
                <div class="bg-white shadow-md rounded-lg overflow-hidden w-full">
                    <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Basic Information</h2>
                        <p class="mt-1 text-sm text-gray-500">Request title, status, and priority</p>
                    </div>
                    <div class="px-6 py-6 grid grid-cols-1 gap-6">
                        <div>
                            <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Request Title {% if form.name.field.required %}<span class="text-red-500">*</span>{% endif %}
                            </label>
                            {{ form.name }}
                            {% if form.name.errors %}<p class="mt-2 text-sm text-red-600">{{ form.name.errors.0 }}</p>{% endif %}
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label for="{{ form.status.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Status
                                </label>
                                {{ form.status }}
                                {% if form.status.errors %}<p class="mt-2 text-sm text-red-600">{{ form.status.errors.0 }}</p>{% endif %}
                            </div>
                            <div>
                                <label for="{{ form.priority.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Priority
                                </label>
                                {{ form.priority }}
                                {% if form.priority.errors %}<p class="mt-2 text-sm text-red-600">{{ form.priority.errors.0 }}</p>{% endif %}
                            </div>
                            <div>
                                <label for="{{ form.reference_number.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    External Ticket #
                                </label>
                                {{ form.reference_number }}
                                <p class="mt-1 text-xs text-gray-500">External ticketing system reference (optional)</p>
                                {% if form.reference_number.errors %}<p class="mt-2 text-sm text-red-600">{{ form.reference_number.errors.0 }}</p>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- People -->
                <div class="bg-white shadow-md rounded-lg overflow-hidden w-full">
                    <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">People</h2>
                        <p class="mt-1 text-sm text-gray-500">Request requester, assignee, and approver</p>
                    </div>
                    <div class="px-6 py-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label for="{{ form.person_requester.id_for_label }}" class="block text-sm font-medium text-gray-700">
                                    Requester {% if form.person_requester.field.required %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {% if current_user_person_id %}
                                <button type="button" id="select-me-btn-requester" class="inline-flex items-center px-3 py-1 text-xs font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 transition-colors duration-150">
                                    <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                    Select Me
                                </button>
                                {% endif %}
                            </div>
                            {{ form.person_requester }}
                            {% if form.person_requester.errors %}<p class="mt-2 text-sm text-red-600">{{ form.person_requester.errors.0 }}</p>{% endif %}
                        </div>
                        <div>
                            <label for="{{ form.person_assignee.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Assignee
                            </label>
                            {{ form.person_assignee }}
                            <p class="mt-1 text-xs text-gray-500">IT staff member assigned to work on this</p>
                            {% if form.person_assignee.errors %}<p class="mt-2 text-sm text-red-600">{{ form.person_assignee.errors.0 }}</p>{% endif %}
                        </div>
                        <div>
                            <label for="{{ form.person_approver.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Approver
                            </label>
                            {{ form.person_approver }}
                            <p class="mt-1 text-xs text-gray-500">Person who approved or will approve this request</p>
                            {% if form.person_approver.errors %}<p class="mt-2 text-sm text-red-600">{{ form.person_approver.errors.0 }}</p>{% endif %}
                        </div>
                    </div>
                </div>

                <!-- Related Entities -->
                <div class="bg-white shadow-md rounded-lg overflow-hidden w-full">
                    <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Related Entities</h2>
                        <p class="mt-1 text-sm text-gray-500">Link to application or project (optional)</p>
                    </div>
                    <div class="px-6 py-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="{{ form.application.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Application
                            </label>
                            {{ form.application }}
                            {% if form.application.errors %}<p class="mt-2 text-sm text-red-600">{{ form.application.errors.0 }}</p>{% endif %}
                        </div>
                        <div>
                            <label for="{{ form.project.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Project
                            </label>
                            {{ form.project }}
                            {% if form.project.errors %}<p class="mt-2 text-sm text-red-600">{{ form.project.errors.0 }}</p>{% endif %}
                        </div>
                    </div>
                </div>

                <!-- Request Details -->
                <div class="bg-white shadow-md rounded-lg overflow-hidden w-full">
                    <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Request Details</h2>
                        <p class="mt-1 text-sm text-gray-500">Detailed description, justification, and expected outcomes (Markdown supported)</p>
                    </div>
                    <div class="px-6 py-6 space-y-6">
                        <div>
                            <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Description
                            </label>
                            {{ form.description }}
                            <p class="mt-1 text-xs text-gray-500">What is being requested? Provide technical details.</p>
                            {% if form.description.errors %}<p class="mt-2 text-sm text-red-600">{{ form.description.errors.0 }}</p>{% endif %}
                        </div>
                        <div>
                            <label for="{{ form.justification.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Justification
                            </label>
                            {{ form.justification }}
                            <p class="mt-1 text-xs text-gray-500">Why is this request needed? Business case.</p>
                            {% if form.justification.errors %}<p class="mt-2 text-sm text-red-600">{{ form.justification.errors.0 }}</p>{% endif %}
                        </div>
                        <div>
                            <label for="{{ form.expected_outcome.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Expected Outcome
                            </label>
                            {{ form.expected_outcome }}
                            <p class="mt-1 text-xs text-gray-500">What will success look like when completed?</p>
                            {% if form.expected_outcome.errors %}<p class="mt-2 text-sm text-red-600">{{ form.expected_outcome.errors.0 }}</p>{% endif %}
                        </div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="bg-white shadow-md rounded-lg overflow-hidden w-full">
                    <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Timeline</h2>
                        <p class="mt-1 text-sm text-gray-500">Important dates for this request</p>
                    </div>
                    <div class="px-6 py-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="{{ form.date_requested.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Date Requested
                            </label>
                            {{ form.date_requested }}
                            {% if form.date_requested.errors %}<p class="mt-2 text-sm text-red-600">{{ form.date_requested.errors.0 }}</p>{% endif %}
                        </div>
                        <div>
                            <label for="{{ form.date_due.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Due Date
                            </label>
                            {{ form.date_due }}
                            <p class="mt-1 text-xs text-gray-500">When should this be completed? (optional)</p>
                            {% if form.date_due.errors %}<p class="mt-2 text-sm text-red-600">{{ form.date_due.errors.0 }}</p>{% endif %}
                        </div>
                        <div>
                            <label for="{{ form.date_completed.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Date Completed
                            </label>
                            {{ form.date_completed }}
                            <p class="mt-1 text-xs text-gray-500">When was this actually completed? (optional)</p>
                            {% if form.date_completed.errors %}<p class="mt-2 text-sm text-red-600">{{ form.date_completed.errors.0 }}</p>{% endif %}
                        </div>
                    </div>
                </div>

                <!-- Links -->
                <div class="bg-white shadow-md rounded-lg w-full">
                    <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 rounded-t-lg">
                        <h2 class="text-lg font-semibold text-gray-900">Related Links</h2>
                        <p class="mt-1 text-sm text-gray-500">Reference links and resources for this request</p>
                    </div>
                    <div class="px-6 py-6">
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-sm font-medium text-gray-700">Links</label>
                            <button type="button" id="open-link-modal-btn" class="inline-flex items-center px-3 py-1 text-xs font-medium rounded-md text-green-700 bg-green-100 hover:bg-green-200 transition-colors duration-150">
                                <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Add New Link
                            </button>
                        </div>
                        <!-- Selected Links Chips -->
                        <div id="links-chips" class="flex flex-wrap gap-2 mb-3"></div>
                        <!-- Searchable Dropdown -->
                        <div class="relative" id="links-dropdown-container">
                            <input type="text" id="links-search" placeholder="Search links..."
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   autocomplete="off">
                            <div id="links-dropdown" class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto"></div>
                        </div>
                        <!-- Hidden select for form submission -->
                        <div class="hidden">{{ form.links }}</div>
                        <p class="mt-2 text-xs text-gray-500">Search and select links. Original URLs will be included in DOCX export.</p>
                        {% if form.links.errors %}<p class="mt-2 text-sm text-red-600">{{ form.links.errors.0 }}</p>{% endif %}
                    </div>
                </div>

                <!-- Attachments -->
                <div class="bg-white shadow-md rounded-lg w-full">
                    <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 rounded-t-lg">
                        <h2 class="text-lg font-semibold text-gray-900">Attachments</h2>
                        <p class="mt-1 text-sm text-gray-500">Supporting documents for this request</p>
                    </div>
                    <div class="px-6 py-6">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-gray-700">Documents</label>
                            <button type="button" id="open-document-modal-btn"
                                    class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Upload New
                            </button>
                        </div>
                        <!-- Selected Attachments Chips -->
                        <div id="attachments-chips" class="flex flex-wrap gap-2 mb-3"></div>
                        <!-- Searchable Dropdown -->
                        <div class="relative" id="attachments-dropdown-container">
                            <input type="text" id="attachments-search" placeholder="Search documents..."
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   autocomplete="off">
                            <div id="attachments-dropdown" class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto"></div>
                        </div>
                        <!-- Hidden select for form submission -->
                        <div class="hidden">{{ form.attachments }}</div>
                        <p class="mt-2 text-xs text-gray-500">Search and select existing documents or upload new ones.</p>
                        {% if form.attachments.errors %}<p class="mt-2 text-sm text-red-600">{{ form.attachments.errors.0 }}</p>{% endif %}
                    </div>
                </div>

                <!-- Additional Notes -->
                <div class="bg-white shadow-md rounded-lg overflow-hidden w-full">
                    <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Additional Notes</h2>
                        <p class="mt-1 text-sm text-gray-500">Any other relevant information</p>
                    </div>
                    <div class="px-6 py-6">
                        <label for="{{ form.comment.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Comments
                        </label>
                        {{ form.comment }}
                        {% if form.comment.errors %}<p class="mt-2 text-sm text-red-600">{{ form.comment.errors.0 }}</p>{% endif %}
                    </div>
                </div>

                <!-- Spacer for sticky footer -->
                <div class="h-20"></div>
            </div>

            <!-- Sticky Form Actions (above timezone clock) -->
            <div class="fixed bottom-[28px] left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-40">
                <div class="px-4 sm:px-6 lg:px-8 py-4">
                    <div class="flex items-center justify-between">
                        <a href="{% url 'it_devops_request' %}"
                           class="flex-1 mr-4 px-6 py-3 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-150 text-center">
                            Cancel
                        </a>
                        <button type="submit"
                                class="flex-1 ml-4 px-6 py-3 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-150">
                            {% if form.instance.pk %}Update Request{% else %}Create Request{% endif %}
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Ask AI Toggle
    const askAiToggle = document.getElementById('ask-ai-toggle');
    const askAiContent = document.getElementById('ask-ai-content');
    const askAiChevron = document.getElementById('ask-ai-chevron');

    if (askAiToggle) {
        askAiToggle.addEventListener('click', function() {
            askAiContent.classList.toggle('hidden');
            askAiChevron.classList.toggle('rotate-180');
        });
    }

    // Copy AI Prompt
    const copyAiPromptBtn = document.getElementById('copy-ai-prompt');
    const aiPromptText = document.getElementById('ai-prompt-text');
    const copyBtnText = document.getElementById('copy-btn-text');

    if (copyAiPromptBtn && aiPromptText) {
        copyAiPromptBtn.addEventListener('click', function() {
            aiPromptText.select();
            aiPromptText.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(aiPromptText.value).then(function() {
                copyBtnText.textContent = 'Copied!';
                copyAiPromptBtn.classList.remove('text-purple-700', 'bg-purple-100', 'hover:bg-purple-200');
                copyAiPromptBtn.classList.add('text-green-700', 'bg-green-100');
                setTimeout(function() {
                    copyBtnText.textContent = 'Copy';
                    copyAiPromptBtn.classList.add('text-purple-700', 'bg-purple-100', 'hover:bg-purple-200');
                    copyAiPromptBtn.classList.remove('text-green-700', 'bg-green-100');
                }, 2000);
            });
        });
    }

    // Searchable Dropdown with Chips Component
    function initSearchableDropdown(config) {
        const hiddenSelect = document.getElementById(config.selectId);
        const searchInput = document.getElementById(config.searchId);
        const dropdown = document.getElementById(config.dropdownId);
        const chipsContainer = document.getElementById(config.chipsId);

        if (!hiddenSelect || !searchInput || !dropdown || !chipsContainer) return;

        // Build options list from hidden select
        let allOptions = [];
        Array.from(hiddenSelect.options).forEach(opt => {
            allOptions.push({ id: opt.value, text: opt.text, selected: opt.selected });
        });

        // Render chips for selected items
        function renderChips() {
            chipsContainer.innerHTML = '';
            allOptions.filter(opt => opt.selected).forEach(opt => {
                const chip = document.createElement('span');
                chip.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800';
                chip.innerHTML = `
                    <span class="max-w-xs truncate">${opt.text}</span>
                    <button type="button" data-id="${opt.id}" class="ml-2 inline-flex items-center justify-center w-4 h-4 rounded-full text-blue-400 hover:bg-blue-200 hover:text-blue-600 focus:outline-none">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                `;
                chip.querySelector('button').addEventListener('click', function() {
                    toggleSelection(this.dataset.id, false);
                });
                chipsContainer.appendChild(chip);
            });
        }

        // Render dropdown options
        function renderDropdown(filter = '') {
            dropdown.innerHTML = '';
            const filterLower = filter.toLowerCase();
            const filtered = allOptions.filter(opt =>
                !opt.selected && opt.text.toLowerCase().includes(filterLower)
            );

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="px-4 py-2 text-gray-500 text-sm">No results found</div>';
                return;
            }

            filtered.forEach(opt => {
                const item = document.createElement('div');
                item.className = 'px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm';
                item.textContent = opt.text;
                item.dataset.id = opt.id;
                item.addEventListener('click', function() {
                    toggleSelection(this.dataset.id, true);
                    searchInput.value = '';
                    dropdown.classList.add('hidden');
                });
                dropdown.appendChild(item);
            });
        }

        // Toggle selection and sync with hidden select
        function toggleSelection(id, selected) {
            const opt = allOptions.find(o => o.id === id);
            if (opt) opt.selected = selected;

            // Sync with hidden select
            Array.from(hiddenSelect.options).forEach(o => {
                if (o.value === id) o.selected = selected;
            });

            renderChips();
            renderDropdown(searchInput.value);
        }

        // Add new option (for modal callbacks)
        function addOption(id, text, selected = true) {
            // Check if already exists
            if (allOptions.find(o => o.id === String(id))) {
                toggleSelection(String(id), selected);
                return;
            }

            // Add to allOptions
            allOptions.push({ id: String(id), text: text, selected: selected });

            // Add to hidden select
            const option = document.createElement('option');
            option.value = id;
            option.text = text;
            option.selected = selected;
            hiddenSelect.add(option);

            renderChips();
            renderDropdown(searchInput.value);
        }

        // Event listeners
        searchInput.addEventListener('focus', function() {
            renderDropdown(this.value);
            dropdown.classList.remove('hidden');
        });

        searchInput.addEventListener('input', function() {
            renderDropdown(this.value);
            dropdown.classList.remove('hidden');
        });

        // Close dropdown on outside click
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // Initial render
        renderChips();

        return { addOption };
    }

    // Initialize Links dropdown
    const linksDropdown = initSearchableDropdown({
        selectId: '{{ form.links.id_for_label }}',
        searchId: 'links-search',
        dropdownId: 'links-dropdown',
        chipsId: 'links-chips'
    });

    // Initialize Attachments dropdown
    const attachmentsDropdown = initSearchableDropdown({
        selectId: '{{ form.attachments.id_for_label }}',
        searchId: 'attachments-search',
        dropdownId: 'attachments-dropdown',
        chipsId: 'attachments-chips'
    });

    // Link Modal Integration
    const openLinkModalBtn = document.getElementById('open-link-modal-btn');
    if (openLinkModalBtn && linksDropdown) {
        openLinkModalBtn.addEventListener('click', function() {
            window.openLinkModal(function(newLink) {
                linksDropdown.addOption(newLink.id, newLink.name, true);
            });
        });
    }

    // Document Modal Integration
    const openDocumentModalBtn = document.getElementById('open-document-modal-btn');
    if (openDocumentModalBtn && attachmentsDropdown) {
        openDocumentModalBtn.addEventListener('click', function() {
            window.openDocumentModal(function(newDocument) {
                const text = newDocument.name + ' v' + newDocument.version + ' (' + newDocument.blob_filename + ')';
                attachmentsDropdown.addOption(newDocument.id, text, true);
            });
        });
    }
});
</script>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        // Initialize Select2 for person dropdowns
        $('#id_person_requester').select2({
            placeholder: 'Search for a requester...',
            allowClear: true,
            width: '100%'
        });

        $('#id_person_assignee').select2({
            placeholder: 'Search for an assignee...',
            allowClear: true,
            width: '100%'
        });

        $('#id_person_approver').select2({
            placeholder: 'Search for an approver...',
            allowClear: true,
            width: '100%'
        });

        // Update Select Me button to work with Select2
        const selectMeBtn = document.getElementById('select-me-btn-requester');
        if (selectMeBtn) {
            selectMeBtn.addEventListener('click', function() {
                const currentUserId = '{{ current_user_person_id }}';
                if (currentUserId) {
                    $('#id_person_requester').val(currentUserId).trigger('change');
                }
            });
        }
    });
</script>
{% endblock %}
