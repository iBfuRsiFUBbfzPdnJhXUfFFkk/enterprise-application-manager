{% extends "authenticated/base_authenticated.html" %}
{% load humanize %}
{% load kpi_tags %}
{% block content %}
<style>
    .column-group {
        border-left: 2px solid #dee2e6;
        border-right: 2px solid #dee2e6;
    }
    .group-separator {
        border-right: 2px solid #dee2e6;
    }
    .blurry-text {
        filter: blur(5px);
        user-select: none;
    }
</style>

<div class="card card-canary">
    <div class="card-header border-bottom-canary">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="mb-0">Sprint {{ sprint.name }} KPIs</h2>
            <div>
                <a href="{% url 'kpi:kpi_sprint_export' sprint.enumeration_attack_uuid %}" class="btn btn-success">ðŸ“¥ Download Excel</a>
                {% if request.user.is_staff or request.user.is_superuser %}
                    <a href="?privacy={% if request.GET.privacy == 'on' %}off{% else %}on{% endif %}" class="btn btn-warning">
                        {% if request.GET.privacy == 'on' %}Disable Privacy Mode{% else %}Enable Privacy Mode{% endif %}
                    </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card-body">
        <div class="mb-4">
            <p><strong>Sprint Dates:</strong> {{ sprint_start_date }} - {{ sprint_end_date }}</p>
            <p><strong>Total Adjusted Capacity:</strong> {{ total_adjusted_capacity }}</p>
            <p><strong>Total Delivered:</strong> {{ total_delivered }}</p>
            <p><strong>Total Committed:</strong> {{ total_committed }}</p>
            <p><strong>Capacity-Based Velocity:</strong> <span class="velocity-highlight">{{ velocity }}</span></p>
            <p><strong>Commitment Accuracy:</strong> <span class="accuracy-highlight">{{ commitment_accuracy }}</span></p>
        </div>

        <div class="table-responsive">
            <table id="data-table" class="table table-canary table-hover mb-0">
                <thead>
                    <tr>
                        <th rowspan="2" class="column-group">Developer</th>
                        <th colspan="4" class="text-center column-group" title="Availability-related metrics affecting capacity">Availability</th>
                        <th colspan="2" class="text-center column-group" title="Story points committed vs. delivered">Story Points</th>
                        <th colspan="3" class="text-center column-group" title="Code review activity including reviews, comments, and threads">Code Review Activity</th>
                        <th colspan="3" class="text-center column-group" title="Developer contributions including issues, code changes, and context switching">Development Output</th>
                        <th colspan="2" class="text-center column-group" title="Performance-based metrics">Performance Metrics</th>
                    </tr>
                    <tr>
                        <th class="group-separator" title="Total available working capacity for the sprint">Base Capacity</th>
                        <th title="Company holidays during the sprint, reducing available working days">Holidays</th>
                        <th title="Personal Time Off (PTO) taken by the developer">PTO Days</th>
                        <th class="group-separator" title="Base capacity adjusted for holidays and PTO">Adjusted Capacity</th>
                        <th title="Story points the developer committed to delivering in the sprint">Committed</th>
                        <th class="group-separator" title="Story points actually delivered by the developer">Delivered</th>
                        <th title="Number of code reviews completed by the developer">Reviews</th>
                        <th title="Total number of comments left in code reviews">Comments</th>
                        <th class="group-separator" title="Total number of discussion threads the developer participated in">Threads</th>
                        <th title="Number of issues written by the developer during the sprint">Issues Written</th>
                        <th title="Lines of code added and deleted by the developer">Code Changes</th>
                        <th class="group-separator" title="Number of unique projects the developer worked on">Context Switching ðŸŒ€</th>
                        <th title="Velocity = Delivered Story Points Ã· Adjusted Capacity">Velocity</th>
                        <th title="Accuracy = Delivered Story Points Ã· Committed Story Points">Accuracy</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in sprint_kpis %}
                    <tr>
                        <td class="column-group{% if request.GET.privacy == 'on' %} blurry-text{% endif %}">{{ stat.person_developer.gitlab_sync_username }}</td>
                        <td class="{% if request.GET.privacy == 'on' %}blurry-text{% endif %}">{{ stat.coerced_scrum_capacity_base }}</td>
                        <td class="{% if request.GET.privacy == 'on' %}blurry-text{% endif %}">{{ stat.sprint.number_of_holidays_during_sprint }}</td>
                        <td class="{% if request.GET.privacy == 'on' %}blurry-text{% endif %}">{{ stat.coerced_number_of_paid_time_off_days }}</td>
                        <td class="group-separator {% if request.GET.privacy == 'on' %}blurry-text{% endif %}">{{ stat.adjusted_capacity }}</td>
                        <td class="metric-accent {% if request.GET.privacy == 'on' %}blurry-text{% endif %}">{{ stat.coerced_number_of_story_points_committed_to }}</td>
                        <td class="group-separator {% if request.GET.privacy == 'on' %}blurry-text{% endif %}">{{ stat.coerced_number_of_story_points_delivered }}</td>
                        <td class="{% if request.GET.privacy == 'on' %}blurry-text{% endif %}">{{ stat.coerced_number_of_merge_requests_approved }}</td>
                        <td class="{% if request.GET.privacy == 'on' %}blurry-text{% endif %}">{{ stat.coerced_number_of_comments_made }}</td>
                        <td class="group-separator {% if request.GET.privacy == 'on' %}blurry-text{% endif %}">{{ stat.coerced_number_of_threads_made }}</td>
                        <td class="{% if request.GET.privacy == 'on' %}blurry-text{% endif %}">{{ stat.coerced_number_of_issues_written }}</td>
                        <td class="{% if request.GET.privacy == 'on' %}blurry-text{% endif %}" title="Added/Deleted lines">
                            {% if stat.coerced_number_of_code_lines_added == 0 and stat.coerced_number_of_code_lines_removed == 0 %}
                                ---
                            {% else %}
                                {% if stat.coerced_number_of_code_lines_added > 0 %}+{% endif %}{{ stat.coerced_number_of_code_lines_added|intcomma }}/
                                {% if stat.coerced_number_of_code_lines_removed > 0 %}-{% endif %}{{ stat.coerced_number_of_code_lines_removed|intcomma }}
                            {% endif %}
                        </td>
                        <td class="group-separator {% if request.GET.privacy == 'on' %}blurry-text{% endif %}">{{ stat.coerced_number_of_context_switches }}</td>  <!-- ðŸ†• NEW CONTEXT SWITCHING ROW -->
                        <td style="background-color: {{ stat.capacity_based_velocity|get_color }}; color: white;">
                            {{ stat.capacity_based_velocity|floatformat:2 }}
                        </td>
                        <td style="background-color: {{ stat.commitment_accuracy|get_color }}; color: white;">
                            {{ stat.commitment_accuracy|floatformat:2 }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="15" class="text-center py-4">No sprint stats found</td>
                    </tr>
                    {% endfor %}
                </tbody>

            </table>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
    <script>
        $(document).ready(function () {
            $('#data-table').DataTable({"pageLength": 100});
        });
    </script>
{% endblock %}