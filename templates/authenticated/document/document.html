{% extends 'authenticated/base_authenticated.html' %}
{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header Section -->
    <div class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Documents</h1>
                    <p class="mt-1 text-sm text-gray-500">Store and manage project documentation and files</p>
                </div>
                <div class="flex items-center space-x-3">
                    <a href="{% url 'document_duplicates' %}"
                       class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-150">
                        <svg class="h-5 w-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                        Dedup Files
                    </a>
                    <a href="{% url 'document_similar_images' %}"
                       class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-150">
                        <svg class="h-5 w-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        Similar Images
                    </a>
                    <button type="button" id="openRehashModal"
                            class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-150">
                        <svg class="h-5 w-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                        Rehash Files
                    </button>
                    <button type="button" id="openThumbnailModal"
                            class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-150">
                        <svg class="h-5 w-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        Regen Thumbnails
                    </button>
                    <button type="button" id="openRenameModal"
                            class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-150">
                        <svg class="h-5 w-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Rename Files
                    </button>
                    <a href="{% url 'document_new' %}"
                       class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-150">
                        <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        New Document
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <!-- Search -->
                <div>
                    <label for="search" class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                    <div class="relative">
                        <input type="text"
                               id="search"
                               placeholder="Search by name or filename..."
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        <svg class="absolute right-3 top-2.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </div>
                </div>

                <!-- File Type Filter -->
                <div>
                    <label for="filetype-filter" class="block text-sm font-medium text-gray-700 mb-2">File Type</label>
                    <select id="filetype-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        <option value="">All File Types</option>
                    </select>
                </div>
            </div>

            <!-- View Toggle and Result Count -->
            <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                <div class="text-sm text-gray-600">
                    Showing <span id="result-count" class="font-semibold text-gray-900">{{ models|length }}</span> document(s)
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium text-gray-700">View:</span>
                    <button id="grid-view-btn" class="px-3 py-1 text-sm font-medium rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                        </svg>
                    </button>
                    <button id="list-view-btn" class="px-3 py-1 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-100 transition-colors">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Grid View Container -->
        <div id="grid-view">
            <div id="grid-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                {% for model in models %}
                <div class="doc-card bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200 cursor-pointer overflow-hidden flex flex-col"
                     data-name="{{ model.name|default:'' }}"
                     data-filename="{{ model.get_filename|default:'' }}"
                     data-version="{{ model.version|default:'' }}"
                     data-filetype="{{ model.get_file_extension|default:'' }}"
                     ondblclick="window.location.href='{% url 'document_detail' model_id=model.id %}'">
                    <!-- File Preview -->
                    <div class="h-40 bg-gray-100 flex items-center justify-center overflow-hidden flex-shrink-0">
                        {% if model.has_thumbnail %}
                        <img src="{{ model.get_thumbnail_url }}" alt="{{ model.name }}" class="w-full h-full object-cover" loading="lazy">
                        {% elif model.is_image and model.get_file_url %}
                        <img src="{{ model.get_file_url }}" alt="{{ model.name }}" class="w-full h-full object-cover" loading="lazy">
                        {% elif model.get_file_extension == 'pdf' %}
                        <div class="text-center">
                            <svg class="h-16 w-16 text-red-500 mx-auto" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zm-1 2l5 5h-5V4zM8.5 13h1c.83 0 1.5.67 1.5 1.5S10.33 16 9.5 16H9v1.5H8V13h.5zm1 2c.28 0 .5-.22.5-.5s-.22-.5-.5-.5H9v1h.5zm3.5-2h1.5c.83 0 1.5.67 1.5 1.5v2c0 .83-.67 1.5-1.5 1.5H13V13zm1 4h.5c.28 0 .5-.22.5-.5v-2c0-.28-.22-.5-.5-.5H14v3zm4-4h2v1h-1.5v1h1v1h-1v1.5h-1V13h.5z"/>
                            </svg>
                            <span class="text-xs text-gray-500 mt-1 block">PDF Document</span>
                        </div>
                        {% elif model.get_file_extension in 'doc,docx' %}
                        <div class="text-center">
                            <svg class="h-16 w-16 text-blue-600 mx-auto" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zm-1 2l5 5h-5V4zM9.5 13v4.5H8V13h1.5zm2 0c.83 0 1.5.67 1.5 1.5v1.5c0 .83-.67 1.5-1.5 1.5H10V13h1.5zm0 3.5c.28 0 .5-.22.5-.5v-1.5c0-.28-.22-.5-.5-.5H11v2.5h.5zm4.5-3.5v4.5h-1V13h1z"/>
                            </svg>
                            <span class="text-xs text-gray-500 mt-1 block">Word Document</span>
                        </div>
                        {% elif model.get_file_extension in 'xls,xlsx' %}
                        <div class="text-center">
                            <svg class="h-16 w-16 text-green-600 mx-auto" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zm-1 2l5 5h-5V4zM8 13h1.5l1 2 1-2H13l-1.75 3.5L13 20h-1.5l-1-2-1 2H8l1.75-3.5L8 13z"/>
                            </svg>
                            <span class="text-xs text-gray-500 mt-1 block">Excel Spreadsheet</span>
                        </div>
                        {% elif model.get_file_extension in 'zip,rar,7z,tar,gz' %}
                        <div class="text-center">
                            <svg class="h-16 w-16 text-yellow-600 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                            </svg>
                            <span class="text-xs text-gray-500 mt-1 block">Archive</span>
                        </div>
                        {% elif model.has_file %}
                        <div class="text-center">
                            <svg class="h-16 w-16 text-gray-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                            <span class="text-xs text-gray-500 mt-1 block">{{ model.get_file_extension|upper|default:"File" }}</span>
                        </div>
                        {% else %}
                        <div class="text-center">
                            <svg class="h-16 w-16 text-gray-300 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <span class="text-xs text-gray-400 mt-1 block">No File</span>
                        </div>
                        {% endif %}
                    </div>

                    <div class="p-4 flex-grow">
                        <!-- Document Name -->
                        <h3 class="text-sm font-semibold text-gray-900 truncate mb-1" title="{{ model.name }}">
                            {{ model.name }}
                        </h3>
                        <p class="text-xs text-gray-500 mb-2" title="{{ model.uploaded_at|date:'F d, Y g:i A' }}">
                            {{ model.uploaded_at|timesince }} ago
                            {% if model.version %} &middot; v{{ model.version }}{% endif %}
                        </p>

                        <!-- File Type and Size -->
                        <div class="flex items-center space-x-2 flex-wrap">
                            {% if model.get_file_extension %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                {{ model.get_file_extension }}
                            </span>
                            {% endif %}
                            {% if model.get_file_size %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                {% if model.get_file_size < 1024 %}
                                    {{ model.get_file_size }} B
                                {% elif model.get_file_size < 1048576 %}
                                    {% widthratio model.get_file_size 1024 1 %} KB
                                {% else %}
                                    {% widthratio model.get_file_size 1048576 1 %} MB
                                {% endif %}
                            </span>
                            {% endif %}
                        </div>

                        <!-- Usage Indicators -->
                        {% if model.app_count > 0 or model.bad_int_count > 0 or model.bad_upd_count > 0 or model.hr_upd_count > 0 %}
                        <div class="flex items-center flex-wrap gap-1 text-xs text-gray-500 mt-2 pt-2 border-t border-gray-100">
                            {% if model.app_count > 0 %}
                            <span class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-blue-50 text-blue-700">
                                {{ model.app_count }} app{{ model.app_count|pluralize }}
                            </span>
                            {% endif %}
                            {% if model.bad_int_count > 0 %}
                            <span class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-orange-50 text-orange-700">
                                {{ model.bad_int_count }} int
                            </span>
                            {% endif %}
                            {% if model.bad_upd_count > 0 %}
                            <span class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-purple-50 text-purple-700">
                                {{ model.bad_upd_count }} BI
                            </span>
                            {% endif %}
                            {% if model.hr_upd_count > 0 %}
                            <span class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-green-50 text-green-700">
                                {{ model.hr_upd_count }} HR
                            </span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Actions -->
                    <div class="px-4 py-2 bg-gray-50 border-t border-gray-200 flex items-center justify-end space-x-3 flex-shrink-0 mt-auto">
                        <a href="{% url 'document_detail' model_id=model.id %}"
                           class="inline-flex items-center text-xs font-medium text-blue-600 hover:text-blue-800 transition-colors"
                           title="View"
                           onclick="event.stopPropagation()">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </a>
                        <a href="{% url 'document_edit' model_id=model.id %}"
                           class="inline-flex items-center text-xs font-medium text-blue-600 hover:text-blue-800 transition-colors"
                           title="Edit"
                           onclick="event.stopPropagation()">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                        </a>
                        {% if model.has_file %}
                        <a href="{{ model.get_file_url }}"
                           class="inline-flex items-center text-xs font-medium text-green-600 hover:text-green-800 transition-colors"
                           title="Download"
                           onclick="event.stopPropagation()"
                           download>
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                            </svg>
                        </a>
                        {% endif %}
                        <a href="{% url 'document_delete' model_id=model.id %}"
                           class="inline-flex items-center text-xs font-medium text-red-600 hover:text-red-800 transition-colors"
                           title="Delete"
                           onclick="event.stopPropagation(); return confirm('Are you sure you want to delete this document?');">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Grid Pagination -->
            <div id="grid-pagination" class="mt-6 bg-white rounded-lg shadow-sm border border-gray-200 px-4 py-3 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <label for="grid-page-size" class="text-sm text-gray-600">Show</label>
                    <select id="grid-page-size" class="border border-gray-300 rounded-md text-sm px-2 py-1 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="10" selected>10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span class="text-sm text-gray-600">per page</span>
                </div>
                <div class="flex items-center space-x-1">
                    <button id="grid-prev-page" class="px-3 py-1 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        Previous
                    </button>
                    <div id="grid-page-numbers" class="flex items-center space-x-1">
                        <!-- Page numbers injected by JS -->
                    </div>
                    <button id="grid-next-page" class="px-3 py-1 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        Next
                    </button>
                </div>
                <div id="grid-pagination-info" class="text-sm text-gray-600">
                    <!-- Info injected by JS -->
                </div>
            </div>
        </div>

        <!-- List View -->
        <div id="list-view" class="hidden">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table id="documentTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uploaded</th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Used In</th>
                                <th scope="col" class="px-2 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" data-orderable="false">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for model in models %}
                            <tr class="doc-row hover:bg-gray-50 transition-colors duration-150 cursor-pointer"
                                data-filetype="{{ model.get_file_extension|default:'' }}"
                                ondblclick="window.location.href='{% url 'document_detail' model_id=model.id %}'">
                                <td class="px-3 py-3 text-sm font-medium text-gray-900" style="max-width: 250px;"
                                    data-search="{{ model.name|default:'' }} {{ model.get_filename|default:'' }}">
                                    <div class="truncate" title="{{ model.name }}">
                                        {{ model.name }}
                                    </div>
                                </td>
                                <td class="px-3 py-3 text-sm text-gray-500 whitespace-nowrap" data-order="{{ model.uploaded_at|date:'Y-m-d H:i:s' }}">
                                    <span title="{{ model.uploaded_at|date:'F d, Y g:i A' }}" class="cursor-help border-b border-dotted border-gray-400">
                                        {{ model.uploaded_at|timesince }} ago
                                    </span>
                                </td>
                                <td class="px-3 py-3 whitespace-nowrap text-sm" data-order="{{ model.get_file_extension|default:'' }}"
                                    data-search="{{ model.get_file_extension|default:'' }}">
                                    {% if model.get_file_extension %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        {{ model.get_file_extension }}
                                    </span>
                                    {% else %}
                                    <span class="text-gray-400">-</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500" data-order="{{ model.get_file_size|default:0 }}">
                                    {% if model.get_file_size %}
                                    <span class="text-xs">
                                        {% if model.get_file_size < 1024 %}
                                            {{ model.get_file_size }} B
                                        {% elif model.get_file_size < 1048576 %}
                                            {% widthratio model.get_file_size 1024 1 %} KB
                                        {% else %}
                                            {% widthratio model.get_file_size 1048576 1 %} MB
                                        {% endif %}
                                    </span>
                                    {% else %}
                                    <span class="text-gray-400">-</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 py-3 text-sm text-gray-500" data-order="{{ model.app_count|default:0|add:model.bad_int_count|default:0|add:model.bad_upd_count|default:0|add:model.hr_upd_count|default:0 }}">
                                    {% if model.app_count > 0 or model.bad_int_count > 0 or model.bad_upd_count > 0 or model.hr_upd_count > 0 %}
                                    <div class="flex flex-wrap gap-1">
                                        {% if model.app_count > 0 %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-blue-50 text-blue-700">
                                            {{ model.app_count }} app{{ model.app_count|pluralize }}
                                        </span>
                                        {% endif %}
                                        {% if model.bad_int_count > 0 %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-orange-50 text-orange-700">
                                            {{ model.bad_int_count }} int{{ model.bad_int_count|pluralize }}
                                        </span>
                                        {% endif %}
                                        {% if model.bad_upd_count > 0 %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-purple-50 text-purple-700">
                                            {{ model.bad_upd_count }} BI{{ model.bad_upd_count|pluralize }}
                                        </span>
                                        {% endif %}
                                        {% if model.hr_upd_count > 0 %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-green-50 text-green-700">
                                            {{ model.hr_upd_count }} HR{{ model.hr_upd_count|pluralize }}
                                        </span>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <span class="text-gray-400">-</span>
                                    {% endif %}
                                </td>
                                <td class="px-2 py-3 whitespace-nowrap text-right text-sm font-medium">
                                    <div class="flex items-center justify-end space-x-2">
                                        <a href="{% url 'document_detail' model_id=model.id %}"
                                           class="inline-flex items-center p-1 text-blue-600 hover:text-blue-800 transition-colors"
                                           title="View Details"
                                           onclick="event.stopPropagation()">
                                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                            </svg>
                                        </a>
                                        <a href="{% url 'document_edit' model_id=model.id %}"
                                           class="inline-flex items-center p-1 text-blue-600 hover:text-blue-800 transition-colors"
                                           title="Edit"
                                           onclick="event.stopPropagation()">
                                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                            </svg>
                                        </a>
                                        {% if model.has_file %}
                                        <a href="{{ model.get_file_url }}"
                                           class="inline-flex items-center p-1 text-green-600 hover:text-green-800 transition-colors"
                                           title="Download"
                                           onclick="event.stopPropagation()"
                                           download>
                                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                            </svg>
                                        </a>
                                        {% endif %}
                                        <a href="{% url 'document_delete' model_id=model.id %}"
                                           class="inline-flex items-center p-1 text-red-600 hover:text-red-800 transition-colors"
                                           title="Delete"
                                           onclick="event.stopPropagation(); return confirm('Are you sure you want to delete this document?');">
                                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No documents found</h3>
            <p class="mt-1 text-sm text-gray-500">Try adjusting your search or filter criteria.</p>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    const searchInput = document.getElementById('search');
    const filetypeFilter = document.getElementById('filetype-filter');
    const gridViewBtn = document.getElementById('grid-view-btn');
    const listViewBtn = document.getElementById('list-view-btn');
    const gridView = document.getElementById('grid-view');
    const listView = document.getElementById('list-view');
    const emptyState = document.getElementById('empty-state');
    const resultCount = document.getElementById('result-count');

    // Grid pagination elements
    const gridPageSizeSelect = document.getElementById('grid-page-size');
    const gridPrevPageBtn = document.getElementById('grid-prev-page');
    const gridNextPageBtn = document.getElementById('grid-next-page');
    const gridPageNumbersDiv = document.getElementById('grid-page-numbers');
    const gridPaginationInfo = document.getElementById('grid-pagination-info');
    const gridPagination = document.getElementById('grid-pagination');

    // Initialize DataTables for list view
    var table = $('#documentTable').DataTable({
        pageLength: 10,
        order: [[1, 'desc']],
        language: {
            search: "",
            searchPlaceholder: "Search documents...",
            lengthMenu: "Show _MENU_ entries",
            info: "Showing _START_ to _END_ of _TOTAL_ documents",
            infoEmpty: "No documents found",
            infoFiltered: "(filtered from _MAX_ total)",
            paginate: { first: "First", last: "Last", next: "Next", previous: "Previous" }
        },
        dom: '<"flex flex-wrap items-center justify-between gap-4 p-4"lf>rt<"flex flex-wrap items-center justify-between gap-4 p-4 border-t border-gray-200"ip>',
        columnDefs: [{ orderable: false, targets: 5 }]
    });

    // Collect all grid cards for filtering
    const allCards = [];
    document.querySelectorAll('.doc-card').forEach(card => {
        allCards.push({
            card: card,
            name: card.dataset.name.toLowerCase(),
            filename: card.dataset.filename.toLowerCase(),
            version: card.dataset.version.toLowerCase(),
            filetype: card.dataset.filetype
        });
    });

    // Populate file type filter from cards
    const filetypes = new Set();
    allCards.forEach(item => {
        if (item.filetype) filetypes.add(item.filetype);
    });
    Array.from(filetypes).sort().forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        filetypeFilter.appendChild(option);
    });

    // Grid pagination state
    let currentViewState = 'grid';
    let gridCurrentPage = 1;
    let gridPageSize = 10;
    let filteredCards = [...allCards];

    // Render grid pagination controls
    function renderGridPagination() {
        const totalItems = filteredCards.length;
        const totalPages = Math.ceil(totalItems / gridPageSize);
        const startItem = totalItems === 0 ? 0 : (gridCurrentPage - 1) * gridPageSize + 1;
        const endItem = Math.min(gridCurrentPage * gridPageSize, totalItems);

        gridPaginationInfo.textContent = `Showing ${startItem} to ${endItem} of ${totalItems} documents`;

        gridPrevPageBtn.disabled = gridCurrentPage === 1;
        gridNextPageBtn.disabled = gridCurrentPage === totalPages || totalPages === 0;

        gridPageNumbersDiv.innerHTML = '';
        const maxPages = 5;
        let startPage = Math.max(1, gridCurrentPage - Math.floor(maxPages / 2));
        let endPage = Math.min(totalPages, startPage + maxPages - 1);
        if (endPage - startPage + 1 < maxPages) {
            startPage = Math.max(1, endPage - maxPages + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.className = i === gridCurrentPage
                ? 'px-3 py-1 text-sm border border-blue-500 bg-blue-500 text-white rounded-md'
                : 'px-3 py-1 text-sm border border-gray-300 rounded-md hover:bg-gray-50';
            btn.addEventListener('click', () => {
                gridCurrentPage = i;
                renderGridPage();
            });
            gridPageNumbersDiv.appendChild(btn);
        }

        // Always show pagination when there are items
        gridPagination.classList.remove('hidden');
    }

    // Render the current page of grid cards
    function renderGridPage() {
        // Hide all cards first
        allCards.forEach(item => item.card.classList.add('hidden'));

        // Show only cards for current page
        const start = (gridCurrentPage - 1) * gridPageSize;
        const end = start + gridPageSize;
        const pageCards = filteredCards.slice(start, end);

        pageCards.forEach(item => item.card.classList.remove('hidden'));

        renderGridPagination();
    }

    // Filter grid cards based on search and file type
    function filterGridCards() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedFiletype = filetypeFilter.value;

        filteredCards = allCards.filter(item => {
            const matchesSearch = !searchTerm ||
                                item.name.includes(searchTerm) ||
                                item.filename.includes(searchTerm) ||
                                item.version.includes(searchTerm);
            const matchesFiletype = !selectedFiletype || item.filetype === selectedFiletype;
            return matchesSearch && matchesFiletype;
        });

        resultCount.textContent = filteredCards.length;
        gridCurrentPage = 1;

        // Show empty state if no results
        if (filteredCards.length === 0) {
            emptyState.classList.remove('hidden');
            gridView.classList.add('hidden');
            gridPagination.classList.add('hidden');
        } else {
            emptyState.classList.add('hidden');
            gridView.classList.remove('hidden');
            gridPagination.classList.remove('hidden');
            renderGridPage();
        }
    }

    // Apply filters to DataTables
    function filterDataTable() {
        const searchTerm = searchInput.value;
        const selectedFiletype = filetypeFilter.value;

        table.search(searchTerm);
        table.column(2).search(selectedFiletype);
        table.draw();

        const info = table.page.info();
        resultCount.textContent = info.recordsDisplay;

        if (info.recordsDisplay === 0) {
            emptyState.classList.remove('hidden');
            listView.classList.add('hidden');
        } else {
            emptyState.classList.add('hidden');
            listView.classList.remove('hidden');
        }
    }

    // Grid pagination event listeners
    gridPageSizeSelect.addEventListener('change', () => {
        gridPageSize = parseInt(gridPageSizeSelect.value);
        gridCurrentPage = 1;
        renderGridPage();
    });

    gridPrevPageBtn.addEventListener('click', () => {
        if (gridCurrentPage > 1) {
            gridCurrentPage--;
            renderGridPage();
        }
    });

    gridNextPageBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(filteredCards.length / gridPageSize);
        if (gridCurrentPage < totalPages) {
            gridCurrentPage++;
            renderGridPage();
        }
    });

    // Event listeners for filters
    searchInput.addEventListener('input', function() {
        if (currentViewState === 'grid') {
            filterGridCards();
        } else {
            filterDataTable();
        }
    });

    filetypeFilter.addEventListener('change', function() {
        if (currentViewState === 'grid') {
            filterGridCards();
        } else {
            filterDataTable();
        }
    });

    // View toggle
    function setView(view) {
        currentViewState = view;
        localStorage.setItem('eam_document_view', view);

        if (view === 'grid') {
            gridView.classList.remove('hidden');
            listView.classList.add('hidden');
            gridViewBtn.classList.add('bg-blue-100', 'text-blue-700');
            gridViewBtn.classList.remove('text-gray-600', 'hover:bg-gray-100');
            listViewBtn.classList.remove('bg-blue-100', 'text-blue-700');
            listViewBtn.classList.add('text-gray-600', 'hover:bg-gray-100');
            emptyState.classList.add('hidden');
            filterGridCards();
        } else {
            gridView.classList.add('hidden');
            listView.classList.remove('hidden');
            listViewBtn.classList.add('bg-blue-100', 'text-blue-700');
            listViewBtn.classList.remove('text-gray-600', 'hover:bg-gray-100');
            gridViewBtn.classList.remove('bg-blue-100', 'text-blue-700');
            gridViewBtn.classList.add('text-gray-600', 'hover:bg-gray-100');
            emptyState.classList.add('hidden');
            filterDataTable();
        }
    }

    gridViewBtn.addEventListener('click', () => setView('grid'));
    listViewBtn.addEventListener('click', () => setView('list'));

    // Initialize view
    currentViewState = localStorage.getItem('eam_document_view') || 'grid';
    setView(currentViewState);
});
</script>

<style>
    /* DataTables styling overrides */
    #documentTable_wrapper .dataTables_filter input {
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        margin-left: 0.5rem;
    }
    #documentTable_wrapper .dataTables_length select {
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.25rem 2rem 0.25rem 0.5rem;
    }
    #documentTable_wrapper .dataTables_paginate .paginate_button {
        padding: 0.25rem 0.75rem;
        margin: 0 0.125rem;
        border-radius: 0.375rem;
        border: 1px solid #d1d5db;
    }
    #documentTable_wrapper .dataTables_paginate .paginate_button.current {
        background: #3b82f6 !important;
        color: white !important;
        border-color: #3b82f6;
    }
    #documentTable_wrapper .dataTables_paginate .paginate_button:hover:not(.current):not(.disabled) {
        background: #f3f4f6 !important;
        color: #1f2937 !important;
        border-color: #d1d5db;
    }
    #documentTable_wrapper .dataTables_paginate .paginate_button.disabled {
        color: #9ca3af;
        cursor: not-allowed;
    }
    /* Sort icons */
    table.dataTable thead th.sorting:after,
    table.dataTable thead th.sorting_asc:after,
    table.dataTable thead th.sorting_desc:after {
        opacity: 0.5;
    }
    table.dataTable thead th.sorting_asc:after,
    table.dataTable thead th.sorting_desc:after {
        opacity: 1;
    }
</style>

<!-- Rehash Files Modal -->
<div id="rehashModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center pb-3 border-b">
            <h3 class="text-lg font-semibold text-gray-900">Rehash Files</h3>
            <button type="button" class="closeRehashModal text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Initial State -->
        <div id="rehashInitial" class="mt-4">
            <div class="flex items-center space-x-3 p-4 bg-green-50 rounded-lg">
                <svg class="h-8 w-8 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                </svg>
                <div>
                    <p class="text-sm text-gray-700">Recalculate SHA-256 hashes and perceptual image hashes for all documents.</p>
                    <p class="text-xs text-gray-500 mt-1">Used for duplicate detection and similar image finding.</p>
                </div>
            </div>
            <div id="rehashFileCountInfo" class="mt-3 p-3 bg-gray-50 rounded-lg text-center">
                <span id="rehashFileCountLoading" class="text-sm text-gray-500">Loading document count...</span>
                <span id="rehashFileCountDisplay" class="hidden text-sm font-medium text-gray-700">
                    <span id="rehashInitialFileCount">0</span> document(s) to process
                </span>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" class="closeRehashModal px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button type="button" id="startRehashBtn" class="px-4 py-2 bg-green-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-green-700">
                    Start Processing
                </button>
            </div>
        </div>

        <!-- Processing State -->
        <div id="rehashProcessing" class="hidden mt-4">
            <div class="flex flex-col items-center justify-center py-4">
                <p class="text-sm font-medium text-gray-700 mb-2">Rehashing files...</p>
                <p class="text-lg font-semibold text-green-600 mb-3">
                    <span id="rehashCurrentCount">0</span> of <span id="rehashTotalCount">0</span>
                </p>
                <div class="w-full bg-gray-200 rounded-full h-3 mb-3">
                    <div id="rehashProgressBar" class="bg-green-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="rehashCurrentFileName" class="text-xs text-gray-500 truncate max-w-full px-4">Starting...</p>
                <div class="flex space-x-4 mt-4 text-xs">
                    <span class="text-green-600"><span id="rehashLiveHashed">0</span> hashed</span>
                    <span class="text-blue-600"><span id="rehashLiveImages">0</span> images</span>
                    <span class="text-red-600"><span id="rehashLiveErrors">0</span> errors</span>
                </div>
            </div>
        </div>

        <!-- Complete State -->
        <div id="rehashComplete" class="hidden mt-4">
            <div id="rehashSuccessIcon" class="hidden flex items-center justify-center mb-4">
                <div class="rounded-full bg-green-100 p-3">
                    <svg class="h-8 w-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
            </div>
            <div id="rehashWarningIcon" class="hidden flex items-center justify-center mb-4">
                <div class="rounded-full bg-yellow-100 p-3">
                    <svg class="h-8 w-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
            </div>
            <div class="text-center mb-4">
                <h4 id="rehashResultTitle" class="text-lg font-medium text-gray-900">Processing Complete</h4>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Total documents:</span>
                    <span id="rehashResultTotal" class="font-medium text-gray-900">0</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Files hashed:</span>
                    <span id="rehashResultHashed" class="font-medium text-green-600">0</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Image hashes:</span>
                    <span id="rehashResultImages" class="font-medium text-blue-600">0</span>
                </div>
                <div id="rehashErrorRow" class="hidden flex justify-between text-sm">
                    <span class="text-gray-600">Errors:</span>
                    <span id="rehashResultErrors" class="font-medium text-red-600">0</span>
                </div>
            </div>
            <div id="rehashErrorDetails" class="hidden mt-3 p-3 bg-red-50 rounded-lg">
                <p class="text-xs font-medium text-red-800 mb-1">Failed documents:</p>
                <ul id="rehashErrorList" class="text-xs text-red-700 list-disc list-inside"></ul>
            </div>
            <div class="mt-6 flex justify-end">
                <button type="button" id="closeRehashCompleteBtn" class="px-4 py-2 bg-green-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-green-700">
                    Done
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Rename Files Modal -->
<div id="renameModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center pb-3 border-b">
            <h3 class="text-lg font-semibold text-gray-900">Rename Files</h3>
            <button type="button" class="closeRenameModal text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Initial State -->
        <div id="renameInitial" class="mt-4">
            <div class="flex items-center space-x-3 p-4 bg-yellow-50 rounded-lg">
                <svg class="h-8 w-8 text-yellow-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <div>
                    <p class="text-sm text-gray-700">Rename all files to random UUIDs while preserving extensions.</p>
                    <p class="text-xs text-red-600 font-medium mt-1">Warning: This cannot be undone!</p>
                </div>
            </div>
            <div id="renameFileCountInfo" class="mt-3 p-3 bg-gray-50 rounded-lg text-center">
                <span id="renameFileCountLoading" class="text-sm text-gray-500">Loading document count...</span>
                <span id="renameFileCountDisplay" class="hidden text-sm font-medium text-gray-700">
                    <span id="renameInitialFileCount">0</span> document(s) to process
                </span>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" class="closeRenameModal px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button type="button" id="startRenameBtn" class="px-4 py-2 bg-yellow-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-yellow-700">
                    Start Renaming
                </button>
            </div>
        </div>

        <!-- Processing State -->
        <div id="renameProcessing" class="hidden mt-4">
            <div class="flex flex-col items-center justify-center py-4">
                <p class="text-sm font-medium text-gray-700 mb-2">Renaming files...</p>
                <p class="text-lg font-semibold text-yellow-600 mb-3">
                    <span id="renameCurrentCount">0</span> of <span id="renameTotalCount">0</span>
                </p>
                <div class="w-full bg-gray-200 rounded-full h-3 mb-3">
                    <div id="renameProgressBar" class="bg-yellow-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="renameCurrentFileName" class="text-xs text-gray-500 truncate max-w-full px-4">Starting...</p>
                <div class="flex space-x-4 mt-4 text-xs">
                    <span class="text-green-600"><span id="renameLiveRenamed">0</span> renamed</span>
                    <span class="text-gray-500"><span id="renameLiveSkipped">0</span> skipped</span>
                    <span class="text-red-600"><span id="renameLiveErrors">0</span> errors</span>
                </div>
            </div>
        </div>

        <!-- Complete State -->
        <div id="renameComplete" class="hidden mt-4">
            <div id="renameSuccessIcon" class="hidden flex items-center justify-center mb-4">
                <div class="rounded-full bg-green-100 p-3">
                    <svg class="h-8 w-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
            </div>
            <div id="renameWarningIcon" class="hidden flex items-center justify-center mb-4">
                <div class="rounded-full bg-yellow-100 p-3">
                    <svg class="h-8 w-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
            </div>
            <div class="text-center mb-4">
                <h4 id="renameResultTitle" class="text-lg font-medium text-gray-900">Processing Complete</h4>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Total documents:</span>
                    <span id="renameResultTotal" class="font-medium text-gray-900">0</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Files renamed:</span>
                    <span id="renameResultRenamed" class="font-medium text-green-600">0</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Skipped:</span>
                    <span id="renameResultSkipped" class="font-medium text-gray-500">0</span>
                </div>
                <div id="renameErrorRow" class="hidden flex justify-between text-sm">
                    <span class="text-gray-600">Errors:</span>
                    <span id="renameResultErrors" class="font-medium text-red-600">0</span>
                </div>
            </div>
            <div id="renameErrorDetails" class="hidden mt-3 p-3 bg-red-50 rounded-lg">
                <p class="text-xs font-medium text-red-800 mb-1">Failed documents:</p>
                <ul id="renameErrorList" class="text-xs text-red-700 list-disc list-inside"></ul>
            </div>
            <div class="mt-6 flex justify-end">
                <button type="button" id="closeRenameCompleteBtn" class="px-4 py-2 bg-yellow-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-yellow-700">
                    Done
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Thumbnail Regeneration Modal -->
<div id="thumbnailModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center pb-3 border-b">
            <h3 class="text-lg font-semibold text-gray-900">Regenerate Thumbnails</h3>
            <button type="button" id="closeThumbnailModal" class="text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Initial State -->
        <div id="thumbnailInitial" class="mt-4">
            <div class="flex items-center space-x-3 p-4 bg-blue-50 rounded-lg">
                <svg class="h-8 w-8 text-blue-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <div>
                    <p class="text-sm text-gray-700">This will regenerate AVIF thumbnails for all documents with files (images and PDFs).</p>
                    <p class="text-xs text-gray-500 mt-1">Existing thumbnails will be replaced.</p>
                </div>
            </div>
            <div id="fileCountInfo" class="mt-3 p-3 bg-gray-50 rounded-lg text-center">
                <span id="fileCountLoading" class="text-sm text-gray-500">Loading document count...</span>
                <span id="fileCountDisplay" class="hidden text-sm font-medium text-gray-700">
                    <span id="initialFileCount">0</span> document(s) to process
                </span>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="cancelThumbnailBtn"
                        class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button type="button" id="startThumbnailBtn"
                        class="px-4 py-2 bg-blue-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-blue-700">
                    Start Processing
                </button>
            </div>
        </div>

        <!-- Processing State -->
        <div id="thumbnailProcessing" class="hidden mt-4">
            <div class="flex flex-col items-center justify-center py-4">
                <p class="text-sm font-medium text-gray-700 mb-2">Processing thumbnails...</p>
                <p id="processingStatus" class="text-lg font-semibold text-blue-600 mb-3">
                    <span id="currentCount">0</span> of <span id="totalCount">0</span>
                </p>

                <!-- Progress Bar -->
                <div class="w-full bg-gray-200 rounded-full h-3 mb-3">
                    <div id="progressBar" class="bg-blue-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>

                <!-- Current File -->
                <p id="currentFileName" class="text-xs text-gray-500 truncate max-w-full px-4">Starting...</p>

                <!-- Stats -->
                <div class="flex space-x-4 mt-4 text-xs">
                    <span class="text-green-600"><span id="liveGenerated">0</span> generated</span>
                    <span class="text-gray-500"><span id="liveSkipped">0</span> skipped</span>
                    <span class="text-red-600"><span id="liveErrors">0</span> errors</span>
                </div>
            </div>
        </div>

        <!-- Complete State -->
        <div id="thumbnailComplete" class="hidden mt-4">
            <div id="thumbnailSuccessIcon" class="hidden flex items-center justify-center mb-4">
                <div class="rounded-full bg-green-100 p-3">
                    <svg class="h-8 w-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
            </div>
            <div id="thumbnailWarningIcon" class="hidden flex items-center justify-center mb-4">
                <div class="rounded-full bg-yellow-100 p-3">
                    <svg class="h-8 w-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
            </div>

            <div class="text-center mb-4">
                <h4 id="thumbnailResultTitle" class="text-lg font-medium text-gray-900">Processing Complete</h4>
            </div>

            <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Total documents:</span>
                    <span id="resultTotal" class="font-medium text-gray-900">0</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Thumbnails generated:</span>
                    <span id="resultGenerated" class="font-medium text-green-600">0</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Skipped (unsupported):</span>
                    <span id="resultSkipped" class="font-medium text-gray-500">0</span>
                </div>
                <div id="errorRow" class="hidden flex justify-between text-sm">
                    <span class="text-gray-600">Errors:</span>
                    <span id="resultErrors" class="font-medium text-red-600">0</span>
                </div>
            </div>

            <div id="errorDetails" class="hidden mt-3 p-3 bg-red-50 rounded-lg">
                <p class="text-xs font-medium text-red-800 mb-1">Failed documents:</p>
                <ul id="errorList" class="text-xs text-red-700 list-disc list-inside"></ul>
            </div>

            <div class="mt-6 flex justify-end">
                <button type="button" id="closeThumbnailCompleteBtn"
                        class="px-4 py-2 bg-blue-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-blue-700">
                    Done
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Shared utility function
function getCsrfToken() {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, 13) === 'eam_csrftoken=') {
                cookieValue = decodeURIComponent(cookie.substring(13));
                break;
            }
        }
    }
    return cookieValue;
}

// Rehash Modal Functionality
(function() {
    const modal = document.getElementById('rehashModal');
    const openBtn = document.getElementById('openRehashModal');
    const closeBtns = document.querySelectorAll('.closeRehashModal');
    const startBtn = document.getElementById('startRehashBtn');
    const completeBtn = document.getElementById('closeRehashCompleteBtn');

    const initialState = document.getElementById('rehashInitial');
    const processingState = document.getElementById('rehashProcessing');
    const completeState = document.getElementById('rehashComplete');

    let documentIds = [];
    let errorDetails = [];

    function showState(state) {
        initialState.classList.add('hidden');
        processingState.classList.add('hidden');
        completeState.classList.add('hidden');
        state.classList.remove('hidden');
    }

    async function openModal() {
        modal.classList.remove('hidden');
        showState(initialState);
        documentIds = [];
        errorDetails = [];

        document.getElementById('rehashFileCountLoading').classList.remove('hidden');
        document.getElementById('rehashFileCountDisplay').classList.add('hidden');

        try {
            const response = await fetch('{% url "document_rehash" %}', {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            const data = await response.json();
            documentIds = data.document_ids;

            document.getElementById('rehashInitialFileCount').textContent = documentIds.length;
            document.getElementById('rehashFileCountLoading').classList.add('hidden');
            document.getElementById('rehashFileCountDisplay').classList.remove('hidden');
        } catch (error) {
            document.getElementById('rehashFileCountLoading').textContent = 'Could not load count';
        }
    }

    function closeModal() {
        modal.classList.add('hidden');
    }

    async function startProcessing() {
        showState(processingState);

        const total = documentIds.length;
        let processed = 0, hashed = 0, images = 0, errors = 0;

        document.getElementById('rehashTotalCount').textContent = total;
        document.getElementById('rehashCurrentCount').textContent = '0';
        document.getElementById('rehashProgressBar').style.width = '0%';
        document.getElementById('rehashLiveHashed').textContent = '0';
        document.getElementById('rehashLiveImages').textContent = '0';
        document.getElementById('rehashLiveErrors').textContent = '0';

        for (const docId of documentIds) {
            try {
                document.getElementById('rehashCurrentFileName').textContent = `Processing document #${docId}...`;

                const response = await fetch('{% url "document_rehash" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ document_id: docId })
                });

                const data = await response.json();
                processed++;

                if (data.status === 'hashed') {
                    hashed++;
                    if (data.is_image) images++;
                    document.getElementById('rehashCurrentFileName').textContent = ` ${data.name}`;
                } else if (data.status === 'error') {
                    errors++;
                    errorDetails.push(`${data.name}: ${data.error}`);
                    document.getElementById('rehashCurrentFileName').textContent = ` ${data.name}`;
                }

                document.getElementById('rehashCurrentCount').textContent = processed;
                document.getElementById('rehashProgressBar').style.width = `${(processed / total) * 100}%`;
                document.getElementById('rehashLiveHashed').textContent = hashed;
                document.getElementById('rehashLiveImages').textContent = images;
                document.getElementById('rehashLiveErrors').textContent = errors;

            } catch (error) {
                processed++;
                errors++;
                errorDetails.push(`Document #${docId}: ${error.message}`);
                document.getElementById('rehashCurrentCount').textContent = processed;
                document.getElementById('rehashProgressBar').style.width = `${(processed / total) * 100}%`;
                document.getElementById('rehashLiveErrors').textContent = errors;
            }
        }

        showComplete(total, hashed, images, errors);
    }

    function showComplete(total, hashed, images, errors) {
        document.getElementById('rehashResultTotal').textContent = total;
        document.getElementById('rehashResultHashed').textContent = hashed;
        document.getElementById('rehashResultImages').textContent = images;
        document.getElementById('rehashResultErrors').textContent = errors;

        if (errors > 0) {
            document.getElementById('rehashErrorRow').classList.remove('hidden');
            document.getElementById('rehashWarningIcon').classList.remove('hidden');
            document.getElementById('rehashSuccessIcon').classList.add('hidden');
            document.getElementById('rehashResultTitle').textContent = 'Completed with Errors';

            if (errorDetails.length > 0) {
                document.getElementById('rehashErrorDetails').classList.remove('hidden');
                const list = document.getElementById('rehashErrorList');
                list.innerHTML = '';
                errorDetails.slice(0, 10).forEach(detail => {
                    const li = document.createElement('li');
                    li.textContent = detail;
                    li.className = 'truncate';
                    li.title = detail;
                    list.appendChild(li);
                });
            }
        } else {
            document.getElementById('rehashErrorRow').classList.add('hidden');
            document.getElementById('rehashErrorDetails').classList.add('hidden');
            document.getElementById('rehashWarningIcon').classList.add('hidden');
            document.getElementById('rehashSuccessIcon').classList.remove('hidden');
            document.getElementById('rehashResultTitle').textContent = 'Processing Complete';
        }

        showState(completeState);
    }

    openBtn.addEventListener('click', openModal);
    closeBtns.forEach(btn => btn.addEventListener('click', closeModal));
    startBtn.addEventListener('click', startProcessing);
    completeBtn.addEventListener('click', function() {
        closeModal();
        window.location.reload();
    });
    modal.addEventListener('click', function(e) {
        if (e.target === modal) closeModal();
    });
})();

// Rename Modal Functionality
(function() {
    const modal = document.getElementById('renameModal');
    const openBtn = document.getElementById('openRenameModal');
    const closeBtns = document.querySelectorAll('.closeRenameModal');
    const startBtn = document.getElementById('startRenameBtn');
    const completeBtn = document.getElementById('closeRenameCompleteBtn');

    const initialState = document.getElementById('renameInitial');
    const processingState = document.getElementById('renameProcessing');
    const completeState = document.getElementById('renameComplete');

    let documentIds = [];
    let errorDetails = [];

    function showState(state) {
        initialState.classList.add('hidden');
        processingState.classList.add('hidden');
        completeState.classList.add('hidden');
        state.classList.remove('hidden');
    }

    async function openModal() {
        modal.classList.remove('hidden');
        showState(initialState);
        documentIds = [];
        errorDetails = [];

        document.getElementById('renameFileCountLoading').classList.remove('hidden');
        document.getElementById('renameFileCountDisplay').classList.add('hidden');

        try {
            const response = await fetch('{% url "document_rename_files" %}', {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            const data = await response.json();
            documentIds = data.document_ids;

            document.getElementById('renameInitialFileCount').textContent = documentIds.length;
            document.getElementById('renameFileCountLoading').classList.add('hidden');
            document.getElementById('renameFileCountDisplay').classList.remove('hidden');
        } catch (error) {
            document.getElementById('renameFileCountLoading').textContent = 'Could not load count';
        }
    }

    function closeModal() {
        modal.classList.add('hidden');
    }

    async function startProcessing() {
        showState(processingState);

        const total = documentIds.length;
        let processed = 0, renamed = 0, skipped = 0, errors = 0;

        document.getElementById('renameTotalCount').textContent = total;
        document.getElementById('renameCurrentCount').textContent = '0';
        document.getElementById('renameProgressBar').style.width = '0%';
        document.getElementById('renameLiveRenamed').textContent = '0';
        document.getElementById('renameLiveSkipped').textContent = '0';
        document.getElementById('renameLiveErrors').textContent = '0';

        for (const docId of documentIds) {
            try {
                document.getElementById('renameCurrentFileName').textContent = `Processing document #${docId}...`;

                const response = await fetch('{% url "document_rename_files" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ document_id: docId })
                });

                const data = await response.json();
                processed++;

                if (data.status === 'renamed') {
                    renamed++;
                    document.getElementById('renameCurrentFileName').textContent = ` ${data.name}`;
                } else if (data.status === 'skipped') {
                    skipped++;
                    document.getElementById('renameCurrentFileName').textContent = `- ${data.name} (skipped)`;
                } else if (data.status === 'error') {
                    errors++;
                    errorDetails.push(`${data.name}: ${data.error}`);
                    document.getElementById('renameCurrentFileName').textContent = ` ${data.name}`;
                }

                document.getElementById('renameCurrentCount').textContent = processed;
                document.getElementById('renameProgressBar').style.width = `${(processed / total) * 100}%`;
                document.getElementById('renameLiveRenamed').textContent = renamed;
                document.getElementById('renameLiveSkipped').textContent = skipped;
                document.getElementById('renameLiveErrors').textContent = errors;

            } catch (error) {
                processed++;
                errors++;
                errorDetails.push(`Document #${docId}: ${error.message}`);
                document.getElementById('renameCurrentCount').textContent = processed;
                document.getElementById('renameProgressBar').style.width = `${(processed / total) * 100}%`;
                document.getElementById('renameLiveErrors').textContent = errors;
            }
        }

        showComplete(total, renamed, skipped, errors);
    }

    function showComplete(total, renamed, skipped, errors) {
        document.getElementById('renameResultTotal').textContent = total;
        document.getElementById('renameResultRenamed').textContent = renamed;
        document.getElementById('renameResultSkipped').textContent = skipped;
        document.getElementById('renameResultErrors').textContent = errors;

        if (errors > 0) {
            document.getElementById('renameErrorRow').classList.remove('hidden');
            document.getElementById('renameWarningIcon').classList.remove('hidden');
            document.getElementById('renameSuccessIcon').classList.add('hidden');
            document.getElementById('renameResultTitle').textContent = 'Completed with Errors';

            if (errorDetails.length > 0) {
                document.getElementById('renameErrorDetails').classList.remove('hidden');
                const list = document.getElementById('renameErrorList');
                list.innerHTML = '';
                errorDetails.slice(0, 10).forEach(detail => {
                    const li = document.createElement('li');
                    li.textContent = detail;
                    li.className = 'truncate';
                    li.title = detail;
                    list.appendChild(li);
                });
            }
        } else {
            document.getElementById('renameErrorRow').classList.add('hidden');
            document.getElementById('renameErrorDetails').classList.add('hidden');
            document.getElementById('renameWarningIcon').classList.add('hidden');
            document.getElementById('renameSuccessIcon').classList.remove('hidden');
            document.getElementById('renameResultTitle').textContent = 'Processing Complete';
        }

        showState(completeState);
    }

    openBtn.addEventListener('click', openModal);
    closeBtns.forEach(btn => btn.addEventListener('click', closeModal));
    startBtn.addEventListener('click', startProcessing);
    completeBtn.addEventListener('click', function() {
        closeModal();
        window.location.reload();
    });
    modal.addEventListener('click', function(e) {
        if (e.target === modal) closeModal();
    });
})();

// Thumbnail Modal Functionality
(function() {
    const modal = document.getElementById('thumbnailModal');
    const openBtn = document.getElementById('openThumbnailModal');
    const closeBtn = document.getElementById('closeThumbnailModal');
    const cancelBtn = document.getElementById('cancelThumbnailBtn');
    const startBtn = document.getElementById('startThumbnailBtn');
    const completeBtn = document.getElementById('closeThumbnailCompleteBtn');

    const initialState = document.getElementById('thumbnailInitial');
    const processingState = document.getElementById('thumbnailProcessing');
    const completeState = document.getElementById('thumbnailComplete');

    let documentIds = [];
    let errorDetails = [];

    function showState(state) {
        initialState.classList.add('hidden');
        processingState.classList.add('hidden');
        completeState.classList.add('hidden');
        state.classList.remove('hidden');
    }

    async function openModal() {
        modal.classList.remove('hidden');
        showState(initialState);
        documentIds = [];
        errorDetails = [];

        // Reset count display
        document.getElementById('fileCountLoading').classList.remove('hidden');
        document.getElementById('fileCountDisplay').classList.add('hidden');

        // Fetch document IDs
        try {
            const response = await fetch('{% url "document_reprocess_thumbnails" %}', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            const data = await response.json();
            documentIds = data.document_ids;

            document.getElementById('initialFileCount').textContent = documentIds.length;
            document.getElementById('fileCountLoading').classList.add('hidden');
            document.getElementById('fileCountDisplay').classList.remove('hidden');
        } catch (error) {
            document.getElementById('fileCountLoading').textContent = 'Could not load count';
        }
    }

    function closeModal() {
        modal.classList.add('hidden');
    }

    async function startProcessing() {
        showState(processingState);

        const total = documentIds.length;
        let processed = 0;
        let generated = 0;
        let skipped = 0;
        let errors = 0;

        // Update initial display
        document.getElementById('totalCount').textContent = total;
        document.getElementById('currentCount').textContent = '0';
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('liveGenerated').textContent = '0';
        document.getElementById('liveSkipped').textContent = '0';
        document.getElementById('liveErrors').textContent = '0';

        // Process each document
        for (const docId of documentIds) {
            try {
                document.getElementById('currentFileName').textContent = `Processing document #${docId}...`;

                const response = await fetch('{% url "document_reprocess_thumbnails" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ document_id: docId })
                });

                const data = await response.json();
                processed++;

                if (data.status === 'generated') {
                    generated++;
                    document.getElementById('currentFileName').textContent = ` ${data.name}`;
                } else if (data.status === 'skipped') {
                    skipped++;
                    document.getElementById('currentFileName').textContent = `- ${data.name} (skipped)`;
                } else if (data.status === 'error') {
                    errors++;
                    errorDetails.push(`${data.name}: ${data.error}`);
                    document.getElementById('currentFileName').textContent = ` ${data.name}`;
                }

                // Update live stats
                document.getElementById('currentCount').textContent = processed;
                document.getElementById('progressBar').style.width = `${(processed / total) * 100}%`;
                document.getElementById('liveGenerated').textContent = generated;
                document.getElementById('liveSkipped').textContent = skipped;
                document.getElementById('liveErrors').textContent = errors;

            } catch (error) {
                processed++;
                errors++;
                errorDetails.push(`Document #${docId}: ${error.message}`);
                document.getElementById('currentCount').textContent = processed;
                document.getElementById('progressBar').style.width = `${(processed / total) * 100}%`;
                document.getElementById('liveErrors').textContent = errors;
            }
        }

        // Show completion state
        showComplete(total, generated, skipped, errors);
    }

    function showComplete(total, generated, skipped, errors) {
        document.getElementById('resultTotal').textContent = total;
        document.getElementById('resultGenerated').textContent = generated;
        document.getElementById('resultSkipped').textContent = skipped;
        document.getElementById('resultErrors').textContent = errors;

        const errorRow = document.getElementById('errorRow');
        const errorDetailsEl = document.getElementById('errorDetails');
        const errorList = document.getElementById('errorList');
        const successIcon = document.getElementById('thumbnailSuccessIcon');
        const warningIcon = document.getElementById('thumbnailWarningIcon');
        const resultTitle = document.getElementById('thumbnailResultTitle');

        if (errors > 0) {
            errorRow.classList.remove('hidden');
            warningIcon.classList.remove('hidden');
            successIcon.classList.add('hidden');
            resultTitle.textContent = 'Completed with Errors';

            if (errorDetails.length > 0) {
                errorDetailsEl.classList.remove('hidden');
                errorList.innerHTML = '';
                errorDetails.slice(0, 10).forEach(detail => {
                    const li = document.createElement('li');
                    li.textContent = detail;
                    li.className = 'truncate';
                    li.title = detail;
                    errorList.appendChild(li);
                });
                if (errors > 10) {
                    const li = document.createElement('li');
                    li.textContent = `...and ${errors - 10} more`;
                    errorList.appendChild(li);
                }
            }
        } else {
            errorRow.classList.add('hidden');
            errorDetailsEl.classList.add('hidden');
            warningIcon.classList.add('hidden');
            successIcon.classList.remove('hidden');
            resultTitle.textContent = 'Processing Complete';
        }

        showState(completeState);
    }

    // Event listeners
    openBtn.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    startBtn.addEventListener('click', startProcessing);
    completeBtn.addEventListener('click', function() {
        closeModal();
        window.location.reload();
    });

    // Close on outside click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });
})();
</script>
{% endblock %}
